<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"leetao50.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.11.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="记录信息来源网络，内容只为方便查找，非公开信息，非请勿入">
<meta property="og:type" content="website">
<meta property="og:title" content="InfoPool">
<meta property="og:url" content="https://leetao50.github.io/index.html">
<meta property="og:site_name" content="InfoPool">
<meta property="og:description" content="记录信息来源网络，内容只为方便查找，非公开信息，非请勿入">
<meta property="og:locale" content="zh_CN">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://leetao50.github.io/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>InfoPool</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">InfoPool</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">私人信息记录</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description">记录信息来源网络，内容只为方便查找，非公开信息，非请勿入</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">65</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://leetao50.github.io/2024/05/23/nginx/Nginx-%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="InfoPool">
      <meta itemprop="description" content="记录信息来源网络，内容只为方便查找，非公开信息，非请勿入">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | InfoPool">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/23/nginx/Nginx-%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">Nginx-配置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-05-23 15:30:23" itemprop="dateCreated datePublished" datetime="2024-05-23T15:30:23+08:00">2024-05-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-28 13:47:49" itemprop="dateModified" datetime="2024-05-28T13:47:49+08:00">2024-05-28</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Nginx-架构"><a href="#Nginx-架构" class="headerlink" title="Nginx 架构"></a>Nginx 架构</h1><p><img src="1131847985f79f1f463c35f3eb2ebb5ec2b5e8c3e97b41cdfe9233b2c06d5cf4.png" alt="图 0"><br>从上边这张图，我们可以一览nginx的架构设计，首先我们可以直观得出nginx的几大特点：</p>
<ol>
<li>事件驱动&amp;异步非阻塞</li>
<li>多进程机制</li>
<li>服务端缓存</li>
<li>反向代理</li>
</ol>
<h1 id="Nginx模块"><a href="#Nginx模块" class="headerlink" title="Nginx模块"></a>Nginx模块</h1><p><img src="dcb9be47fd4ef765e7f7768f5cb9fe70c8cf416be6f139e49c80a19f6408c47f.png" alt="图 1">  </p>
<ul>
<li><strong>核心模块</strong> ：是nginx 服务器正常运行必不可少的模块，提供错误日志记录、配置文件解析、事件驱动<br>机制、进程管理等核心功能</li>
<li><strong>标准HTTP模块</strong> ：提供 HTTP 协议解析相关的功能，如：端口配置、网页编码设置、HTTP 响应头设<br>置等</li>
<li><strong>可选HTTP模块</strong> ：主要用于扩展标准的 HTTP 功能，让nginx能处理一些特殊的服务，如：Flash 多<br>媒体传输、解析 GeoIP 请求、SSL 支持等</li>
<li><strong>邮件服务模块</strong> ：主要用于支持 nginx  的邮件服务，包括对 POP3 协议、IMAP 协议和 SMTP 协议的支持</li>
<li><strong>第三方模块</strong> ：是为了扩展 Nginx 服务器应用，完成开发者自定义功能，如：Json 支持、Lua 支持等</li>
</ul>
<h1 id="nginx目录一览"><a href="#nginx目录一览" class="headerlink" title="nginx目录一览"></a>nginx目录一览</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost /]# tree  /usr/local/nginx/  -L 2</span><br><span class="line">/usr/local/nginx/</span><br><span class="line">├── conf                        #存放一系列配置文件的目录</span><br><span class="line">│   ├── fastcgi.conf           #fastcgi程序相关配置文件</span><br><span class="line">│   ├── fastcgi.conf.default   #fastcgi程序相关配置文件备份</span><br><span class="line">│   ├── fastcgi_params         #fastcgi程序参数文件</span><br><span class="line">│   ├── fastcgi_params.default #fastcgi程序参数文件备份</span><br><span class="line">│   ├── koi-utf           #编码映射文件</span><br><span class="line">│   ├── koi-win           #编码映射文件</span><br><span class="line">│   ├── mime.types        #媒体类型控制文件</span><br><span class="line">│   ├── mime.types.default #媒体类型控制文件备份</span><br><span class="line">│   ├── nginx.conf        #主配置文件</span><br><span class="line">│   ├── nginx.conf.default #主配置文件备份</span><br><span class="line">│   ├── scgi_params      #scgi程序相关配置文件</span><br><span class="line">│   ├── scgi_params.default #scgi程序相关配置文件备份</span><br><span class="line">│   ├── uwsgi_params       #uwsgi程序相关配置文件</span><br><span class="line">│   ├── uwsgi_params.default #uwsgi程序相关配置文件备份</span><br><span class="line">│   └── win-utf          #编码映射文件</span><br><span class="line">├── html                 #存放网页文档</span><br><span class="line">│   ├── 50x.html         #错误页码显示网页文件</span><br><span class="line">│   └── index.html       #网页的首页文件</span><br><span class="line">├── logs                 #存放nginx的日志文件</span><br><span class="line">├── sbin                #存放启动程序</span><br><span class="line">│   ├── nginx           #nginx启动程序</span><br><span class="line">│   └── nginx.old       </span><br></pre></td></tr></table></figure>

<h1 id="nginx-conf文件-解读"><a href="#nginx-conf文件-解读" class="headerlink" title="nginx.conf文件 解读"></a>nginx.conf文件 解读</h1><p>首先我们要知道nginx.conf文件是由一个一个的指令块组成的，nginx用{}标识一个指令块，指令块中再设置具体的指令(注意<strong>指令必须以;号结尾</strong>)。<br>指令块有：</p>
<ol>
<li>全局模块</li>
<li>events模块</li>
<li>http模块</li>
<li>server模块</li>
<li>location模块</li>
<li>upstream模块</li>
</ol>
<p>精简后的结构如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">全局模块</span><br><span class="line">event模块</span><br><span class="line">http模块</span><br><span class="line">    upstream模块</span><br><span class="line">    </span><br><span class="line">    server模块</span><br><span class="line">        location块</span><br><span class="line">        location块</span><br><span class="line">        ....</span><br><span class="line">    server模块</span><br><span class="line">        location块</span><br><span class="line">        location块</span><br><span class="line">        ...</span><br><span class="line">    ....    </span><br></pre></td></tr></table></figure>
<p><strong>各模块的功能作用如下描述：</strong></p>
<ol>
<li>全局模块： 配置影响nginx全局的指令，比如运行nginx的用户名，nginx进程pid存放路径，日志存放路径，配置文件引入，worker进程数等。</li>
<li>events块： 配置影响nginx服务器或与用户的网络连接。比如每个进程的最大连接数，选取哪种事件驱动模型（select&#x2F;poll epoll或者是其他等等nginx支持的）来处理连接请求，是否允许同时接受多个网路连接，开启多个网络连接序列化等。</li>
<li>http块： 可以嵌套多个server，配置代理，缓存，日志格式定义等绝大多数功能和第三方模块的配置。如文件引入，mime-type定义，日志自定义，是否使用sendfile传输文件，连接超时时间，单连接请求数等。</li>
<li>upstream块： 配置上游服务器的地址以及负载均衡策略和重试策略等等。</li>
<li>server块： 配置虚拟主机的相关参数比如域名端口等等，一个http中可以有多个server。</li>
<li>location块： 配置url路由规则。</li>
</ol>
<p><strong>下面看下nginx.conf长啥样并对一些指令做个解释：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意：有些指令是可以在不同指令块使用的（需要时可以去官网看看对应指令的作用域）。这里只是演示</span></span><br><span class="line"></span><br><span class="line">[root@localhost /usr/local/nginx]# cat /usr/local/nginx/conf/nginx.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">user  nobody; <span class="comment"># 指定Nginx Worker进程运行用户以及用户组，默认由nobody账号运行</span></span></span><br><span class="line"></span><br><span class="line">worker_processes  1;  # 指定工作进程的个数，默认是1个。具体可以根据服务器cpu数量进行设置， 比如cpu有4个，可以设置为4。如果不知道cpu的数量，可以设置为auto。 nginx会自动判断服务器的cpu个数，并设置相应的进程数</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">error_log  logs/error.log;  <span class="comment"># 用来定义全局错误日志文件输出路径，这个设置也可以放入http块，server块，日志输出级别有debug、info、notice、warn、error、crit可供选择，其中，debug输出日志最为最详细，而crit输出日志最少。</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">error_log  logs/error.log  info; <span class="comment"># 指定error日志位置和日志级别</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">pid        logs/nginx.pid;  <span class="comment"># 用来指定进程pid的存储文件位置</span></span></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    accept_mutex on;   # 设置网路连接序列化，防止惊群现象发生，默认为on</span><br><span class="line">    </span><br><span class="line">    # Nginx支持的工作模式有select、poll、kqueue、epoll、rtsig和/dev/poll，其中select和poll都是标准的工作模式，kqueue和epoll是高效的工作模式，不同的是epoll用在Linux平台上，而kqueue用在BSD系统中，对于Linux系统，epoll工作模式是首选</span><br><span class="line">    use epoll;</span><br><span class="line">    </span><br><span class="line">    # 用于定义Nginx每个工作进程的最大连接数，默认是1024。最大客户端连接数由worker_processes和worker_connections决定，即Max_client=worker_processes*worker_connections在作为反向代理时，max_clients变为：max_clients = worker_processes *worker_connections/4。进程的最大连接数受Linux系统进程的最大打开文件数限制，在执行操作系统命令“ulimit -n 65536”后worker_connections的设置才能生效</span><br><span class="line">    worker_connections  1024; </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对HTTP服务器相关属性的配置如下</span></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types; # 引入文件类型映射文件 </span><br><span class="line">    default_type  application/octet-stream; # 如果没有找到指定的文件类型映射 使用默认配置 </span><br><span class="line">    # 设置日志打印格式</span><br><span class="line">    #log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">    #                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">    #                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line">    # </span><br><span class="line">    #access_log  logs/access.log  main; # 设置日志输出路径以及 日志级别</span><br><span class="line">    sendfile        on; # 开启零拷贝 省去了内核到用户态的两次copy故在文件传输时性能会有很大提升</span><br><span class="line">    #tcp_nopush     on; # 数据包会累计到一定大小之后才会发送，减小了额外开销，提高网络效率</span><br><span class="line">    keepalive_timeout  65; # 设置nginx服务器与客户端会话的超时时间。超过这个时间之后服务器会关闭该连接，客户端再次发起请求，则需要再次进行三次握手。</span><br><span class="line">    #gzip  on; # 开启压缩功能，减少文件传输大小，节省带宽。</span><br><span class="line">    sendfile_max_chunk 100k; #每个进程每次调用传输数量不能大于设定的值，默认为0，即不设上限。</span><br><span class="line">    </span><br><span class="line">    # 配置你的上游服务（即被nginx代理的后端服务）的ip和端口/域名</span><br><span class="line">    upstream backend_server &#123; </span><br><span class="line">        server 172.30.128.65:8080;</span><br><span class="line">        server 172.30.128.65:8081 backup; #备机</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80; #nginx服务器监听的端口</span><br><span class="line">        server_name  localhost; #监听的地址 nginx服务器域名/ip 多个使用英文逗号分割</span><br><span class="line">        #access_log  logs/host.access.log  main; # 设置日志输出路径以及 级别，会覆盖http指令块的access_log配置</span><br><span class="line">        </span><br><span class="line">        # location用于定义请求匹配规则。 以下是实际使用中常见的3中配置（即分为：首页，静态，动态三种）</span><br><span class="line">       </span><br><span class="line">        # 第一种：直接匹配网站根目录，通过域名访问网站首页比较频繁，使用这个会加速处理，一般这个规则配成网站首页，假设此时我们的网站首页文件就是： usr/local/nginx/html/index.html</span><br><span class="line">        location = / &#123;  </span><br><span class="line">            root   html; # 静态资源文件的根目录 比如我的是 /usr/local/nginx/html/</span><br><span class="line">            index  index.html index.htm; # 静态资源文件名称 比如：网站首页html文件</span><br><span class="line">        &#125;</span><br><span class="line">        # 第二种：静态资源匹配（静态文件修改少访问频繁，可以直接放到nginx或者统一放到文件服务器，减少后端服务的压力），假设把静态文件我们这里放到了 usr/local/nginx/webroot/static/目录下</span><br><span class="line">        location ^~ /static/ &#123;</span><br><span class="line">            alias /webroot/static/; #访问 ip:80/static/xxx.jpg后，将会去获取/url/local/nginx/webroot/static/xxx.jpg 文件并响应</span><br><span class="line">        &#125;</span><br><span class="line">        # 第二种的另外一种方式：拦截所有 后缀名是gif,jpg,jpeg,png,css.js,ico这些 类静态的的请求，让他们都去直接访问静态文件目录即可</span><br><span class="line">        location ~* \.(gif|jpg|jpeg|png|css|js|ico)$ &#123;</span><br><span class="line">            root /webroot/static/;</span><br><span class="line">        &#125;</span><br><span class="line">        # 第三种：用来拦截非首页、非静态资源的动态数据请求，并转发到后端应用服务器 </span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://backend_server; #请求转向 upstream是backend_server 指令块所定义的服务器列表</span><br><span class="line">            deny 192.168.3.29; #拒绝的ip （黑名单）</span><br><span class="line">            allow 192.168.5.10; #允许的ip（白名单）</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        # 定义错误返回的页面，凡是状态码是 500 502 503 504 总之50开头的都会返回这个 根目录下html文件夹下的50x.html文件内容</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    # 其余的server配置 ,如果有需要的话</span><br><span class="line">    #server &#123;</span><br><span class="line">        ......</span><br><span class="line">    #    location / &#123;</span><br><span class="line">               ....</span><br><span class="line">    #    &#125;</span><br><span class="line">    #&#125;</span><br><span class="line">    </span><br><span class="line">    # include /etc/nginx/conf.d/*.conf;  # 一般我们实际使用中有很多配置，通常的做法并不是将其直接写到nginx.conf文件，</span><br><span class="line">    # 而是写到新文件 然后使用include指令 将其引入到nginx.conf即可，这样使得主配置nginx.conf文件更加清晰。</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上就是nginx.conf文件的配置了，主要讲了一些指令的含义，当然实际的指令有很多，我在配置文件并没有全部写出来，准备放到后边章节详细阐述这些东西，比如：location匹配规则，反向代理，动静分离，负载均衡策略，重试策略，压缩，https,限流，缓存，跨域这些 我们都没细说，这些东西比较多比较细不可能把使用规则和细节都写到上边的配置文件中，所以我们下边一一解释说明关于这些东西的配置和使用方式。</p>
<p>另外值的注意的是： 因为有些指令是可以在不同作用域使用的，如果在多个作用域都有相同指令的使用，那么nginx将会遵循就近原则或者我愿称之为 内层配置优先。 eg: 你在 http配了日志级别，也在某个server中配了日志级别，那么这个server将使用他自己配置的已不使用外层的http日志配置。</p>
<h1 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h1><p><img src="906719353d4c09aff2cc5893b4f7268ea6c9212e6b2abe5e8029ad1c30606f5d.png" alt="图 2">  </p>
<p>要让 nginx 代理 我们的 服务 很简单，简单描述一下就是 两步：</p>
<p>通过upstream指令块来定义我们的上游服务（即被代理的服务）<br>通过location指令块中的 proxy_pass指令，指定该location要路由到哪个upstream</p>
<p>配置好1和2后，如果来了请求后 会通过url路由到对应的location, 然后nginx会将请求打到upstream定义的服务地址中去。<br><img src="10a064ec18361b3d955e76e0ca66fd30f73116bb5b64f3fc94e68e99d9fccf3c.png" alt="图 3">  </p>
<blockquote>
<p><strong>注意上边的 proxy_pass <a target="_blank" rel="noopener" href="http://mybackendserver/">http://mybackendserver/</a> 后边这个斜线加和不加区别挺大的，加的话不会拼接&#x2F;backend , 而不加的话会拼接 &#x2F;backend</strong></p>
</blockquote>
<h2 id="消除-proxy-pass-转发-x2F-的恐怖阴影"><a href="#消除-proxy-pass-转发-x2F-的恐怖阴影" class="headerlink" title="消除 proxy_pass 转发 &#x2F;的恐怖阴影"></a>消除 proxy_pass 转发 &#x2F;的恐怖阴影</h2><p>在配置Nginx过程中路由转发的一个小小 &#x2F; 可能会给你带来很多麻烦，虽然只是一个小小的斜杠，但是转发的结果千差万别</p>
<ol>
<li>proxy_pass 不带&#x2F;</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location /alpha/ &#123;</span><br><span class="line">    proxy_pass  http://<span class="number">192.168</span>.xxx.xxx:<span class="number">80</span>;</span><br><span class="line">&#125;</span><br><span class="line">http://domain/alpha/ --&gt; http://<span class="number">192.168</span>.xxx.xxx:<span class="number">80</span>/alpha/</span><br><span class="line">http://domain/alpha/beta/abc --&gt; http://<span class="number">192.168</span>.xxx.xxx:<span class="number">80</span>/alpha/beta/abc</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>proxy_pass 带&#x2F;</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location /alpha/ &#123;</span><br><span class="line">    proxy_pass  http://<span class="number">192.168</span>.xxx.xxx:<span class="number">80</span>/;</span><br><span class="line">&#125;</span><br><span class="line">http://domain/alpha/ --&gt; http://<span class="number">192.168</span>.xxx.xxx:<span class="number">80</span>/</span><br><span class="line">http://domain/alpha/beta/abc --&gt; http://<span class="number">192.168</span>.xxx.xxx:<span class="number">80</span>/beta/abc</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="反向代理流程与原理"><a href="#反向代理流程与原理" class="headerlink" title="反向代理流程与原理"></a>反向代理流程与原理</h2><p>对于上边演示的反向代理案例的流程与原理，我们来个示意图如下<br><img src="02ccd71b11335caae443ba0c6391dd9fe671526e6a630859838ed2f63b91273f.png" alt="图 4">  </p>
<h1 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h1><p>说到负载均衡很多人应该并不陌生，总而言之负载均衡就是：避免高并发高流量时请求都聚集到某一个服务或者某几个服务上，而是让其均匀分配（或者能者多劳），从而减少高并发带来的系统压力，从而让服务更稳定。对于nginx来说，负载均衡就是从 upstream 模块定义的后端服务器列表中按照配置的负载策略选取一台服务器接受用户的请求。</p>
<h2 id="nginx常用的负载策略"><a href="#nginx常用的负载策略" class="headerlink" title="nginx常用的负载策略"></a>nginx常用的负载策略</h2><ol>
<li>轮询(默认方式)<ol>
<li>每个请求会按时间顺序逐一分配到不同的后端服务器 </li>
<li>在轮询中，如果服务器down掉了，会自动剔除该服务器</li>
<li>缺省配置就是轮询策略</li>
<li>此策略适合服务器配置相当，无状态且短平快的服务使用</li>
</ol>
</li>
<li>weight(权重方式)<ol>
<li>在轮询策略的基础上指定轮询的几率</li>
<li>权重越高分配到的请求越多</li>
<li>此策略可以与least_conn和ip_hash结合使用</li>
<li>此策略比较适合服务器的硬件配置差别比较大的情况</li>
</ol>
</li>
<li>ip_hash(依据ip的hash值来分配)<ol>
<li>在nginx版本1.3.1之前，不能在ip_hash中使用权重（weight）</li>
<li>ip_hash不能与backup同时使用</li>
<li>此策略适合有状态服务，比如session</li>
<li>当有服务器需要剔除，必须手动down掉</li>
</ol>
</li>
<li>least_conn(最少连接方式)<ol>
<li>此负载均衡策略适合请求处理时间长短不一造成服务器过载的情况</li>
</ol>
</li>
<li>fair(响应时间方式)<ol>
<li>根据后端服务器的响应时间来分配请求，响应时间短的优先分配</li>
<li>Nginx本身不支持fair，如果需要这种调度算法，则必须安装upstream_fair模块</li>
</ol>
</li>
<li>url_hash(依据URL分配方式)<ol>
<li>按访问的URL的哈希结果来分配请求，使每个URL定向到一台后端服务器</li>
<li>Nginx本身不支持url_hash，如果需要这种调度算法，则必须安装Nginx的hash软件包</li>
</ol>
</li>
</ol>
<h2 id="轮询"><a href="#轮询" class="headerlink" title="轮询"></a>轮询</h2><p>轮询策略是默认的，所以只需要如下这样修改配置文件就可以了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream backend_server &#123; </span><br><span class="line">    ip_hash</span><br><span class="line">    server 172.30.128.65:8080;</span><br><span class="line">    server 172.30.128.65:8081;</span><br><span class="line">    server 172.30.128.65:8082;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="weight"><a href="#weight" class="headerlink" title="weight"></a>weight</h2><p>weight指令用于指定轮询机率，weight的默认值为1，weight的数值与访问比率成正比。 接下来我们指定8082端口的服务的weight&#x3D;2，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream backend_server &#123; </span><br><span class="line">    ip_hash</span><br><span class="line">    server 172.30.128.65:8080;</span><br><span class="line">    server 172.30.128.65:8081;</span><br><span class="line">    server 172.30.128.65:8082 weight=2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ip-hash"><a href="#ip-hash" class="headerlink" title="ip_hash"></a>ip_hash</h2><p>设定ip哈希很简单，就是在你的upstream中 指定 ip_hash;即可，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream backend_server &#123; </span><br><span class="line">    ip_hash;</span><br><span class="line">    server 172.30.128.65:8080;</span><br><span class="line">    server 172.30.128.65:8081;</span><br><span class="line">    server 172.30.128.65:8083;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="least-conn"><a href="#least-conn" class="headerlink" title="least_conn"></a>least_conn</h2><p>同ip_hash一样，设定最小连接数策略也很简单，就是在你的upstream中 指定 least_conn;即可，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream backend_server &#123; </span><br><span class="line">    least_conn;</span><br><span class="line">    server 172.30.128.65:8080;</span><br><span class="line">    server 172.30.128.65:8081;</span><br><span class="line">    server 172.30.128.65:8083;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="动静分离"><a href="#动静分离" class="headerlink" title="动静分离"></a>动静分离</h1><p>如果将静态资源都搞到后端服务的话，将会提高后端服务的压力且占用带宽增加了系统负载（要知道，静态资源的访问频率其实蛮高的）所以为了避免该类问题我们可以把不常修改的静态资源文件放到nginx的静态资源目录中去，这样在访问静态资源时直接读取nginx服务器本地文件目录之后返回，这样就大大减少了后端服务的压力同时也加快了静态资源的访问速度，何为静，何为动呢？：</p>
<ul>
<li>静：将不常修改且访问频繁的静态文件，放到nginx本地静态目录（当然也可以搞个静态资源服务器专门存放所有静态文件）</li>
<li>动：将变动频繁&#x2F;实时性较高的比如后端接口，实时转发到对应的后台服务</li>
</ul>
<p>接下来我们将构造一个html页面，然后点击按钮后发送get请求到后端接口。流程如下：<br><img src="90b8227be27efbd64a2f46dd65b82a17719c01f4de358202c1b00c9fce4cfe5a.png" alt="图 7"><br>首先我们搞个html,内容如下：<br><img src="ba4dafbbf05c7421b7e3406341dc794a348f94c38224aa11be57060f7d728ebd.png" alt="图 8"><br>命令将index_page.html 文件上传到虚拟机。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp /Users/hzz/fsdownload/index_page.html root@172.30.128.65:/usr/local/nginx/test/static</span><br></pre></td></tr></table></figure>

<p><strong>修改nginx.conf文件</strong><br>首先我们配置俩location规则,一个（ &#x2F;frontend ）是读取静态文件，一个（&#x2F;backend）是转发到 我们配置的upstream服务中去。如下：<br><img src="75505aff0f154ef619465c07e5ff92c4255343489c38e501e5acb4136dcb44e2.png" alt="图 9"><br>首先我们在浏览器输入：<a target="_blank" rel="noopener" href="http://www.xxx.com/frontend/">www.xxx.com/frontend/</a> ，可以看到请求返回了一个html页面，其实就是我们刚才的 &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;test&#x2F;static&#x2F;index_page.html文件<br><img src="5cb41dbd487daf7ad6bc9394658d6c8260db8febf0500f71c4b23f69b477a760.png" alt="图 10"><br>接着我们输入要查询的人名，之后点击 “调用get接口” 按钮，如下：<br><img src="876c341f79771db8af81e85393e1c09fe6600ce9ab56d29f92b64e417bc5258b.png" alt="图 11"><br>返回数据：<br><img src="74d909a5512cd22ec7222d9741012ae70ced3cf8939bba733710206c27b58de1.png" alt="图 12">  </p>
<h1 id="跨域"><a href="#跨域" class="headerlink" title="跨域"></a>跨域</h1><p>产生跨域问题的主要原因就在于同源策略，为了保证用户信息安全，防止恶意网站窃取数据，同源策略是必须的，该政策由 Netscape 公司于1995年引入浏览器。目前，所有浏览器都实行这个政策。同源策略主要是指三点相同即：协议+域名+端口 相同的两个请求，则可以被看做是同源的，但如果其中任意一点存在不同，则代表是两个不同源的请求，同源策略会限制不同源之间的资源交互从而减少数据安全问题。</p>
<p>首先我在nginx.conf文件中加一个server配置也即将前后端配成不同的server 并且监听的端口以及域名名称都不一致，从而造成访问前端服务和后端服务时候 这俩服务不是”同源”， 如下：<br><img src="0ec37e0f3f0fba4c1cdb499fad8bcb8e21d84e3196bc69bbd76e01e782f87c42.png" alt="图 13"><br>之后我修改index_page中的后端地址：<br><img src="5ef59fe1a47f428f60a46e5f25288fd08d77880b21da318d87adbc13eccf4c66.png" alt="图 14"><br>之后在浏览器中测试一下：<br><img src="d72f26125080dac1f25ab5b49761bb4886cfd90055ec22b5698f51605fddd193.png" alt="图 15"><br>可以看到浏览器提示我们受同源规则影响我们不能跨域访问资源。造成的原因是我的两个域名解析出来的端口不一致 一个是80一个是90。不符合同源策略，所以必然会有跨域报错。</p>
<h2 id="nginx解决跨域"><a href="#nginx解决跨域" class="headerlink" title="nginx解决跨域"></a>nginx解决跨域</h2><p>首先想解决跨越就得避免不同源，而我们可不可以 把对后端的代理 放在前端的server中呢（也就是说让前后端统一使用一个端口，一个server_name）？答案是可以的，因为server支持多个location配置呀（一个location处理前端，一个location转发后端），我们改下配置文件试一把如下：<br><img src="b605cc52d83b66632810ae71f267a62783c9fddb047f39824b37c57f0e59d4f0.png" alt="图 16"><br>之后重启nginx后在浏览器输入 <a target="_blank" rel="noopener" href="http://www.xxxadminsystem.com/page/">www.xxxadminsystem.com/page/</a> ，效果如下：<br><img src="76c4cd8348066004e5a6642d147d999586db71735a936b776c423fcd2ce01cdd.png" alt="图 17"><br>上边&#x2F;page请求返回了html页面之后我们输入参数点击“调用get接口”查看到后端接口的调用如下：<br><img src="d4d10bc3347f15e1e0ee5f6216d3784c4e3d26ec724d0eebafb5dcf493839857.png" alt="图 18">  </p>
<h1 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h1><p>在开头我们就介绍过，nginx代理缓存可以在某些场景下有效的减少服务器压力，让请求快速响应，从而提升用户体验和服务性能，那么nginx缓存如何使用呢？在使用及演示前我们先来熟悉下相关的配置以及其含义，知道了这些才能更好的使用nginx缓存。</p>
<h2 id="nginx缓存配置参数表格一览"><a href="#nginx缓存配置参数表格一览" class="headerlink" title="nginx缓存配置参数表格一览"></a>nginx缓存配置参数表格一览</h2><ul>
<li>proxy_cache：设置是否开启对后端响应的缓存。<ul>
<li>语法：proxy_cache zone | off;	</li>
<li>默认配置：proxy_cache off;	</li>
<li>示例：proxy_cache mycache; # 规定开启nginx缓存并且缓存名称为: mycache	</li>
<li>作用域：http, server, location</li>
</ul>
</li>
<li>proxy_cache_valid：配置什么状态码可以被缓存，以及缓存时长	<ul>
<li>语法：proxy_cache_valid [code …] time;	</li>
<li>示例：proxy_cache_valid 200 304 2m; # 对于状态为200和304的缓存文件，缓存时间是2分钟</li>
<li>作用域：http, server, location</li>
</ul>
</li>
<li>proxy_cache_key：设置缓存文件的 key	<ul>
<li>语法：proxy_cache_key string;	</li>
<li>默认配置：proxy_cache_key：$scheme $proxy_host $request_uri;</li>
<li>示例：proxy_cache_key “$host $request_uri $cookie_user”; # 使用host +请求的uri以及cookie拼接成缓存key</li>
<li>作用域：http, server, location</li>
</ul>
</li>
</ul>
<p>事实上，ngx_http_proxy_module模块中代理缓存proxy_cache相关的指令远不止这些，如果有需要请参考： nginx官方文档。<a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html?_ga=2.13518455.1300709501.1700036543-1660479828.1698914648#proxy_cache">https://nginx.org/en/docs/http/ngx_http_proxy_module.html?_ga=2.13518455.1300709501.1700036543-1660479828.1698914648#proxy_cache</a></p>
<h2 id="nginx缓存使用"><a href="#nginx缓存使用" class="headerlink" title="nginx缓存使用"></a>nginx缓存使用</h2><p>接下来我们修改下nginx.conf文件,如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">    ...</span><br><span class="line">    # 指定缓存存放目录为/usr/local/nginx/test/nginx_cache_storage，并设置缓存名称为mycache，大小为64m， 1天未被访问过的缓存将自动清除，磁盘中缓存的最大容量为1gb</span><br><span class="line">    proxy_cache_path /usr/local/nginx/test/nginx_cache_storage levels=1:2 keys_zone=mycache:64m inactive=1d max_size=1g;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    server&#123;</span><br><span class="line">        ...</span><br><span class="line">        #  指定 username 参数中只要有字母 就不走nginx缓存  </span><br><span class="line">        if ($arg_username ~ [a-z]) &#123;</span><br><span class="line">             set $cache_name &quot;no cache&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        location  /interface &#123;</span><br><span class="line">                   proxy_pass http://mybackendserver/;</span><br><span class="line">                   # 使用名为 mycache 的缓存空间</span><br><span class="line">                   proxy_cache mycache;</span><br><span class="line">                   # 对于200 206 状态码的数据缓存2分钟</span><br><span class="line">                   proxy_cache_valid 200 206 2m;</span><br><span class="line">                   # 定义生成缓存键的规则（请求的url+参数作为缓存key）</span><br><span class="line">                   proxy_cache_key $host$uri$is_args$args;</span><br><span class="line">                   # 资源至少被重复访问2次后再加入缓存</span><br><span class="line">                   proxy_cache_min_uses 3;</span><br><span class="line">                   # 出现重复请求时，只让其中一个去后端读数据，其他的从缓存中读取</span><br><span class="line">                   proxy_cache_lock on;</span><br><span class="line">                   # 上面的锁 超时时间为4s，超过4s未获取数据，其他请求直接去后端</span><br><span class="line">                   proxy_cache_lock_timeout 4s;</span><br><span class="line">                   # 对于请求参数中有字母的 不走nginx缓存</span><br><span class="line">                   proxy_no_cache $cache_name; # 判断该变量是否有值，如果有值则不进行缓存，没有值则进行缓存</span><br><span class="line">                   # 在响应头中添加一个缓存是否命中的状态（便于调试）</span><br><span class="line">                   add_header Cache-status $upstream_cache_status;    </span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ps: 在上边配置文件中除了缓存相关的配置，我们还加了一个参数：</p>
<p><code>add_header Cache-status $upstream_cache_status;</code><br>这个参数可以方便从响应头看到是否命中了nginx缓存，方便我们观察，其不同的值有不同的含义，</p>
<blockquote>
<p>upstream_cache_status的值集合如下：</p>
</blockquote>
<ul>
<li>MISS：请求未命中缓存</li>
<li>HIT：请求命中缓存。</li>
<li>EXPIRED：请求命中缓存但缓存已过期。</li>
<li>STALE：请求命中了陈旧缓存。</li>
<li>REVALIDDATED：Nginx验证陈旧缓存依然有效。</li>
<li>UPDATING：命中的缓存内容陈旧，但正在更新缓存。</li>
<li>BYPASS：响应结果是从原始服务器获取的。</li>
</ul>
<h1 id="黑白名单"><a href="#黑白名单" class="headerlink" title="黑白名单"></a>黑白名单</h1><p>nginx黑白名单比较简单，allow后配置你的白名单，deny后配置你的黑名单，在实际使用中，我们一般都是建个黑名单和白名单的文件然后再nginx.copnf中incluld一下，这样保持主配置文件整洁，也好管理。下边我为了方便就直接在主配置写了。<br><img src="324751d5ef58ea9cc69a3524b9eb5bd5316cf428bc3421fcd069635614941554.png" alt="图 19"><br>可以看到ip 可以是ipv4 也可以是ipv6 也可以按照网段来配置，当然ip黑白配置可以在 http，server，location和limit_except这几个域都可以区别只是作用粒度大小问题。当然nginx建议我们使用 ngx_http_geo_module这个库，ngx_http_geo_module库支持 按地区、国家进行屏蔽，并且提供了IP库，当需要配置的名单比较多或者根据地区国家屏蔽时这个库可以帮上大忙。</p>
<h1 id="nginx限流"><a href="#nginx限流" class="headerlink" title="nginx限流"></a>nginx限流</h1><p>Nginx主要有两种限流方式：按并发连接数限流(ngx_http_limit_conn_module)、按请求速率限流(ngx_http_limit_req_module 使用的令牌桶算法)。<br>关于  ngx_http_limit_req_module模块，里边有很多种限流指令，官网资料一览：</p>
<p>我们下面使用 ngx_http_limit_req_module 模块中的limit_req_zone和 limit_req 这两个指令来达到限制单个IP的请求速率 的目的。</p>
<h2 id="nginx限流配置解释"><a href="#nginx限流配置解释" class="headerlink" title="nginx限流配置解释"></a>nginx限流配置解释</h2><p> 在 nginx.conf 中添加限流配置如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">    ...</span><br><span class="line">    # 对请求速率限流</span><br><span class="line">    limit_req_zone $binary_remote_addr zone=myRateLimit:10m rate=5r/s;</span><br><span class="line">    </span><br><span class="line">    server&#123;</span><br><span class="line">        location /interface&#123;</span><br><span class="line">            ...</span><br><span class="line">            limit_req zone=myRateLimit burst=5  nodelay;</span><br><span class="line">            limit_req_status 520;</span><br><span class="line">            limit_req_log_level info;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>$binary_remote_addr：表示基于 remote_addr(客户端IP) 来做限流<ul>
<li>zone&#x3D;myRateLimit:10m：表示使用myRateLimit来作为内存区域（存储访问信息）的名字，大小为10M，1M能存储16000 IP地址的访问信息，10M可以存储16W IP地址访问信息</li>
<li>rate&#x3D;5r&#x2F;s：表示相同ip每秒最多请求5次，nginx是精确到毫秒的，也就是说此配置代表每200毫秒处理一个请求，这意味着自上一个请求处理完后，若后续200毫秒内又有请求到达，将拒绝处理该请求（如果没配burst的话）</li>
<li>burst&#x3D;5：(英文 爆发 的意思)，意思是设置一个大小为5的缓冲队列，若同时有6个请求到达，Nginx 会处理第一个请求，剩余5个请求将放入队列，然后每隔200ms从队列中获取一个请求进行处理。若请求数大于6，将拒绝处理多余的请求，直接返回503</li>
<li>nodelay：针对的是 burst 参数，burst&#x3D;5 nodelay 这个配置表示被放到缓冲队列的这5个请求会立马处理，不再是每隔200ms取一个了。但是值得注意的是，即使这5个突发请求立马处理并结束，后续来了请求也不一定不会立马处理，因为虽然请求被处理了但是请求所占的坑并不会被立即释放，而是只能按 200ms 一个来释放，释放一个后 才将等待的请求 入队一个。</li>
<li>另外两个： limit_req_status&#x3D;520表示当被限流后，nginx的返回码，limit_req_log_level info代表日志级别</li>
</ul>
</li>
</ul>
<blockquote>
<p>注意： 如果不开启nodelay且开启了burst这个配置，那么将会严重影响用户体验（你想想假设burst队列长度为100的话每100ms处理一个,那队列最后那个请求得等10000ms&#x3D;10s后才能被处理，那不超时才怪呢此时burst已经意义不大了）所以一般情况下 建议burst和nodelay结合使用，从而尽可能达到速率稳定，但突然流量也能正常处理的效果。</p>
</blockquote>
<h2 id="nginx限流（针对请求速率）"><a href="#nginx限流（针对请求速率）" class="headerlink" title="nginx限流（针对请求速率）"></a>nginx限流（针对请求速率）</h2><p>限制每秒同一ip最多访问5次&#x2F;1s<br>修改nginx.conf，把burst&#x3D;5 nodelay注释掉，如下：	</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">    ...</span><br><span class="line">    # 对请求速率限流</span><br><span class="line">    limit_req_zone $binary_remote_addr zone=myRateLimit:10m rate=5r/s;</span><br><span class="line">    </span><br><span class="line">    server&#123;</span><br><span class="line">        location /interface&#123;</span><br><span class="line">            ...</span><br><span class="line">            limit_req zone=myRateLimit #burst=5  nodelay;</span><br><span class="line">            limit_req_status 520;</span><br><span class="line">            limit_req_log_level info;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上边的配置意味着每秒最多处理5次同样ip的请求</p>
<p>打开burst参数并设置成5。现在我们的速率不变还是最多5次一秒，但是设置burst&#x3D;5代表缓冲队列的长度为5，nginx每隔200ms，从缓冲队列拿一个进行处理，配置如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">    ...</span><br><span class="line">    # 对请求速率限流</span><br><span class="line">    limit_req_zone $binary_remote_addr zone=myRateLimit:10m rate=5r/s;</span><br><span class="line">    </span><br><span class="line">    server&#123;</span><br><span class="line">        location /interface&#123;</span><br><span class="line">            ...</span><br><span class="line">            limit_req zone=myRateLimit burst=5  #nodelay;</span><br><span class="line">            limit_req_status 520;</span><br><span class="line">            limit_req_log_level info;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>打开nodelay</p>
<p>我们上边说过打开nodlay的话，代表放到burst队列的请求直接处理 ，不再按速率 200ms&#x2F;次 拿了，配置如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">    ...</span><br><span class="line">    # 对请求速率限流</span><br><span class="line">    limit_req_zone $binary_remote_addr zone=myRateLimit:10m rate=5r/s;</span><br><span class="line">    </span><br><span class="line">    server&#123;</span><br><span class="line">        location /interface&#123;</span><br><span class="line">            ...</span><br><span class="line">            limit_req zone=myRateLimit burst=5  nodelay;</span><br><span class="line">            limit_req_status 520;</span><br><span class="line">            limit_req_log_level info;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>开启nodelay后响应时间10几秒明显比不开启nodelay快很多，但是请求成功的还是6个，因为就像我们上边说的ngdelay虽然会即时处理，但是释放坑位是200ms释放一个 （也就是说即时开启了nodelay 但释放令牌的速度是不变的） ，所以nodelay参数本质上并没有提高访问速率，而仅仅是让处于burst队列的请求 ”被快速处理“ 罢了。</p>
<h2 id="nginx限流（针对连接数量）"><a href="#nginx限流（针对连接数量）" class="headerlink" title="nginx限流（针对连接数量）"></a>nginx限流（针对连接数量）</h2><p>针对连接数量的限流和速率不一样，即使你速率是1ms一次，只要你连接数量不超过设置的，那么也访问成功。如果连接数超过设置的值将会请求失败。值得注意的是他是 ngx_http_limit_conn_module模块中的，不要和 速率限流的 ngx_http_limit_req_module模块搞混了。<br>配置如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">    # 针对ip  对请求连接数限流</span><br><span class="line">    ...</span><br><span class="line">    limit_conn_zone $binary_remote_addr zone=myConnLimit:10m; </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    server&#123;</span><br><span class="line">       ...</span><br><span class="line">       limit_conn myConnLimit 12;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>
<p>limit_conn_zone $binary_remote_addr zone&#x3D;myConnLimit:10m; 代表的意思 是 基于连接数量限流，限流的对象是ip 名称是myConnLimit 存储空间大小10mb（即存放某ip的访问记录），limit_conn myConnLimit 12;标识该ip最大支持12个连接超过则返回503（被限流后状态码默认是503，当然你也可以修改返回码 像上边的 针对请求速率限流 ，返回码就是 我修改的520）。</p>
<h1 id="if"><a href="#if" class="headerlink" title="if"></a>if</h1><p>该指令用于条件判断，并且根据条件判断结果来选择不同的配置，其作用于为：server&#x2F;location 块。这个指令比较简单，因为编程中if语句都是非常高频使用的。因为我们很多时候，都是在对 比如：url  参数 ip 域名等等做比对或者判断（一般都使用正则的方式）,而这些都在nginx全局变量中可以拿到。</p>
<p><strong>if判断指令语法为</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if(condition)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;，</span><br></pre></td></tr></table></figure>
<p>对给定的条件condition进行判断。如果为真，大括号内的rewrite等指令将被执行，if条件(conditon)可以是如下任何内容：</p>
<ol>
<li>一个变量名，如果变量 $variable 的值为空字符串或者字符串”0”，则为false</li>
<li>变量与一个字符串的比较 相等为(&#x3D;) 不相等为(!&#x3D;) 注意此处不要把相等当做赋值语句啊</li>
<li>变量与一个正则表达式的模式匹配 操作符可以是(<code>~ 区分大小写的正则匹配， ~*不区分大小写的正则匹配， !~ !~*，前面两者的非</code>)</li>
<li>检测文件是否存在 使用 -f(存在) 和 !-f(不存在)</li>
<li>检测路径是否存在 使用 -d(存在) 和 !-d(不存在) 后面判断可以是字符串也可是变量</li>
<li>检测文件、路径、或者链接文件是否存在 使用 -e(存在) 和 !-e(不存在) 后面判断可以是字符串也可是变量</li>
<li>检测文件是否为可执行文件 使用 -x(可执行) 和 !-x(不可执行) 后面判断可以是字符串也可是变量</li>
</ol>
<p><strong>注意 上面 第1，2，3条被判断的必须是 变量， 4, 5, 6, 7则可以是变量也可是字符串</strong></p>
<h2 id="例如"><a href="#例如" class="headerlink" title="例如"></a>例如</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">set $variable &quot;0&quot;; </span><br><span class="line">if ($variable) &#123;</span><br><span class="line">    # 不会执行，因为 &quot;0&quot; 为 false</span><br><span class="line">    break;            </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用变量与正则表达式匹配 没有问题</span></span><br><span class="line">if ( $http_host ~ &quot;^star\.igrow\.cn$&quot; ) &#123;</span><br><span class="line">    break;            </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">字符串与正则表达式匹配 报错</span></span><br><span class="line">if ( &quot;star&quot; ~ &quot;^star\.igrow\.cn$&quot; ) &#123;</span><br><span class="line">    break;            </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查文件类的 字符串与变量均可</span></span><br><span class="line">if ( !-f &quot;/data.log&quot; ) &#123;</span><br><span class="line">    break;            </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if ( !-f $filename ) &#123;</span><br><span class="line">    break;            </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"> # </span><span class="language-bash">指定 username 参数中只要有字母 就不走nginx缓存</span></span><br><span class="line">if ($arg_username ~ [a-z]) &#123;</span><br><span class="line">    set $cache_name &quot;no cache&quot;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">如果UA包含<span class="string">&quot;MSIE&quot;</span>，rewrite请求到/msid/目录下</span></span><br><span class="line">if ($http_user_agent ~ MSIE) &#123; </span><br><span class="line">    rewrite ^(.)$ /msie/$1break;</span><br><span class="line">&#125; </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">如果cookie匹配正则，设置变量<span class="variable">$id</span>等于正则引用部分</span></span><br><span class="line">if ($http_cookie ~ &quot;id=([^;]+)(?:;|$)&quot;) </span><br><span class="line">&#123; </span><br><span class="line">    set$id$1; </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">如果提交方法为POST，则返回状态405（Method not allowed）。<span class="built_in">return</span>不能返回301,302</span></span><br><span class="line">if ($request_method = POST) &#123; </span><br><span class="line">    return405; </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">限速，<span class="variable">$slow</span>可以通过 <span class="built_in">set</span> 指令设置</span></span><br><span class="line">if ($slow) &#123; </span><br><span class="line">    limit_rate 10k; </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">如果请求的文件名不存在，则反向代理到localhost 。这里的<span class="built_in">break</span>也是停止rewrite检查</span></span><br><span class="line">if (!-f $request_filename)&#123; </span><br><span class="line">    break; </span><br><span class="line">    proxy_pass http://127.0.0.1; </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">如果querystring中包含<span class="string">&quot;post=140&quot;</span>，永久重定向到example.com</span></span><br><span class="line">if ($args ~ post=140)&#123; </span><br><span class="line">    rewrite ^ http://example.com/ permanent; </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">防盗链</span> </span><br><span class="line">location ~* .(gif|jpg|png|swf|flv)$ &#123; </span><br><span class="line">    valid_referers none blocked www.jefflei.com www.leizhenfang.com; </span><br><span class="line">    if ($invalid_referer) &#123; </span><br><span class="line">        return 404; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="auto-index"><a href="#auto-index" class="headerlink" title="auto_index"></a>auto_index</h1><p>我们配置nginx， 使得访问 hzznb-xzll.xyz&#x2F;book&#x2F; 时,返回 &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;test&#x2F;book&#x2F;目录下的书籍，配置如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location /book/ &#123;</span><br><span class="line">          root /usr/local/nginx/test;</span><br><span class="line">          autoindex on; # 打开 autoindex，，可选参数有 on | off</span><br><span class="line">          autoindex_format html; # 以html的方式进行格式化，可选参数有 html | json | xml</span><br><span class="line">          autoindex_exact_size on; # 修改为off，会以KB、MB、GB显示文件大小，默认为on以bytes显示出⽂件的确切⼤⼩</span><br><span class="line">          autoindex_localtime off; # 显示⽂件时间 GMT格式</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重启nginx并在浏览器输入 hzznb-xzll.xyz&#x2F;book&#x2F; （注意book后边的斜线 &#x2F; 不能去掉，否则404了，具体原因我们下边马上会说），看下效果：<br><img src="f4f34bae19b892b142a7735f26ec381fcd823f55180592588fb7bd37cedd2034.png" alt="图 20">  </p>
<h1 id="root-amp-alias"><a href="#root-amp-alias" class="headerlink" title="root&amp;alias"></a>root&amp;alias</h1><p>root和alias 一般都是用于指定静态资源目录，但是还是有区别的，虽然这是个小知识点但是如果你不清楚规则，很容易走弯路，所以这里阐明并演示这俩的区别。</p>
<h2 id="root"><a href="#root" class="headerlink" title="root"></a>root</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /static/ &#123; #注意static后边的斜线 / 不能去掉，否则404了</span><br><span class="line">    root /usr/local/nginx/test;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时，当你请求 <a target="_blank" rel="noopener" href="http://www.hzznb-xzll.xyz/static/imag%E2%80%A6">www.hzznb-xzll.xyz/static/imag…</a> 时，&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;test&#x2F;static&#x2F;image2.jpg  文件将被作为响应内容响应给客户端,也就是说 :<br>root指令会 将 &#x2F;static&#x2F; 拼接到 &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;test 后边<br>即完整目录路径为： &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;test&#x2F;static&#x2F;</p>
<h2 id="alias"><a href="#alias" class="headerlink" title="alias"></a>alias</h2><p>alias 中文意思别名，这个和root最大区别就是 不会进行拼接，下边我们改下nginx.conf文件来演示下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /static &#123; # 注意一般 alias的 url都不带后边的/</span><br><span class="line">     alias /usr/local/nginx/test/; # 使用alias时  这里的目录最后边一定要加/ 否则就404</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上边配置的意思就是当前你访问 <a target="_blank" rel="noopener" href="http://www.hzznb-xzll.xyz/static/imag%E2%80%A6">www.hzznb-xzll.xyz/static/imag…</a> 时，nginx会去alias配置的路径：&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;test&#x2F;目录下找 image2.jpg 这个文件从而返回。比如我现在的&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;test&#x2F;目录下没有image2.jpg 文件则返回404。</p>
<h2 id="proxy-pass-中的斜线与root和-alias的相似之处"><a href="#proxy-pass-中的斜线与root和-alias的相似之处" class="headerlink" title="proxy_pass 中的斜线与root和 alias的相似之处"></a>proxy_pass 中的斜线与root和 alias的相似之处</h2><p>在我们上边的负载均衡以及动静锋利等等演示中，可以看到我们的proxy_pass的配置基本上都是这么配的：</p>
<p><code>proxy_pass http://mybackendserver/</code></p>
<p>这里有个东西和root与alias的规则很像，所以我们在这里也提一下，就是 <a target="_blank" rel="noopener" href="http://mybackendserver/">http://mybackendserver/</a> 后边这个斜线 &#x2F;，如果你不写 &#x2F; 则会将location的url拼接到路径后边，如果你写了则不会。</p>
<h1 id="upstream-中常用的几个指令"><a href="#upstream-中常用的几个指令" class="headerlink" title="upstream 中常用的几个指令"></a>upstream 中常用的几个指令</h1><table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>server</td>
<td>反向服务地址</td>
</tr>
<tr>
<td>weight</td>
<td>权重</td>
</tr>
<tr>
<td>fail_timeout</td>
<td>与max_fails结合使用。</td>
</tr>
<tr>
<td>max_fails</td>
<td>设置在fail_timeout参数设置的时间内最大失败次数，如果在这个时间内，所有针对该服务器的请求都失败了，那么认为该服务器会被认为是停机了。</td>
</tr>
<tr>
<td>max_conns</td>
<td>允许最大连接数</td>
</tr>
<tr>
<td>fail_time</td>
<td>服务器会被认为停机的时间长度,默认为10s</td>
</tr>
<tr>
<td>backup</td>
<td>标记该服务器为备用服务器，当主服务器停止时，请求会被发送到它这里。</td>
</tr>
<tr>
<td>down</td>
<td>标记服务器永久停机</td>
</tr>
<tr>
<td>slow_start</td>
<td>当节点恢复，不立即加入</td>
</tr>
</tbody></table>
<h1 id="重试策略"><a href="#重试策略" class="headerlink" title="重试策略"></a>重试策略</h1><h2 id="服务不可用重试"><a href="#服务不可用重试" class="headerlink" title="服务不可用重试"></a>服务不可用重试</h2><p>重试是在发生错误时的一种不可缺少的手段，这样当某一个或者某几个服务宕机时（因为我们现在大多都是多实例部署），如果有正常服务，那么将请求 重试到正常服务的机器上去。</p>
<p>下边我们先修改下nginx.conf文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">upstream mybackendserver &#123;</span><br><span class="line">        # 60秒内 如果请求8081端口这个应用失败</span><br><span class="line">        # 3次，则认为该应用宕机 时间到后再有请求进来继续尝试连接宕机应用且仅尝试 1 次，如果还是失败，</span><br><span class="line">        # 则继续等待 60 秒...以此循环，直到恢复</span><br><span class="line">        server 172.30.128.64:8081 fail_timeout=60s max_fails=3; </span><br><span class="line">        </span><br><span class="line">        server 172.30.128.64:8082;</span><br><span class="line">        server 172.30.128.64:8083;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="错误重试"><a href="#错误重试" class="headerlink" title="错误重试"></a>错误重试</h2><p>可以配置哪些状态下 才会执行重试，比如如下这个配置：<br> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定哪些错误状态才执行 重试 比如下边的 error 超时，500,502,503 504</span></span><br><span class="line">proxy_next_upstream error timeout http_500 http_502 http_503 http_504;</span><br></pre></td></tr></table></figure></p>
<h2 id="backup"><a href="#backup" class="headerlink" title="backup"></a>backup</h2><p>Nginx 支持设置备用节点，当所有线上节点都异常时会启用备用节点，同时备用节点也会影响到失败<br>重试的逻辑。</p>
<p>我们可以通过 backup 指令来定义备用服务器，backup有如下特征：</p>
<ol>
<li>正常情况下，请求不会转到 backup 服务器，包括失败重试的场景</li>
<li>当所有正常节点全部不可用时，backup 服务器生效，开始处理请求</li>
<li>一旦有正常节点恢复，就使用已经恢复的正常节点</li>
<li>backup 服务器生效期间，不会存在所有正常节点一次性恢复的逻辑</li>
<li>如果全部 backup 服务器也异常，则会将所有节点一次性恢复，加入存活列表</li>
<li>如果全部节点（包括 backup）都异常了，则 Nginx 返回 502 错误</li>
</ol>
<p>接着我们修改下nginx.conf文件演示下backup的作用：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream mybackendserver &#123;</span><br><span class="line">    server 172.30.128.64:8081 fail_timeout=60s max_fails=3; # 60秒内 如果请求某一个应用失败3次，则认为该应用宕机 时间到后再有请求进来继续尝试连接宕机应用且仅尝试 1 次，如果还是失败，则继续等待 60 秒...以此循环，直到恢复</span><br><span class="line">    server 172.30.128.64:8082;</span><br><span class="line">    server 172.30.128.64:8083 backup; # 设置8083位备机</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>即使8081 不可用也只是去8082重试而不会到备机重试，如果8081 8082都不可用则请求重试到备机：8083。</p>
<h1 id="压缩"><a href="#压缩" class="headerlink" title="压缩"></a>压缩</h1><p>压缩功能比较实用尤其是处理一些大文件时，而gzip 是规定的三种标准 HTTP 压缩格式之一。目前绝大多数的网站都在使用 gzip 传输 HTML 、CSS 、 JavaScript 等资源文件。需要知道的是，并不是每个浏览器都支持 gzip 压缩，如何知道客户端（浏览器）是否支持 压缩 呢？ 可以通过观察 某请求头中的 Accept-Encoding 来观察是否支持压缩，另外只有客户端支持也不顶事，服务端得返回gzip格式的文件呀，那么这件事nginx可以帮我们做，我们可以通过 Nginx 的配置来让服务端支持 gzip。服务端返回压缩文件后浏览器进行解压缩从而展示正常内容。</p>
<p>想要压缩就得配置nginx,修改nginx.conf文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    # 开启/关闭 压缩机制</span><br><span class="line">    gzip on;</span><br><span class="line">    # 根据文件类型选择 是否开启压缩机制</span><br><span class="line">    gzip_types text/plain application/javascript text/css application/xml text/javascript image/jpeg image/jpg image/gif image/png  application/json;</span><br><span class="line">    # 设置压缩级别，一共9个级别  1-9   ，越高资源消耗越大 越耗时，但压缩效果越好，</span><br><span class="line">    gzip_comp_level 9;</span><br><span class="line">    # 设置是否携带Vary:Accept-Encoding 的响应头</span><br><span class="line">    gzip_vary on;</span><br><span class="line">    # 处理压缩请求的 缓冲区数量和大小</span><br><span class="line">    gzip_buffers 32 64k;</span><br><span class="line">    # 对于不支持压缩功能的客户端请求 不开启压缩机制</span><br><span class="line">    gzip_disable &quot;MSIE [1-6]\.&quot;; # 比如低版本的IE浏览器不支持压缩</span><br><span class="line">    # 设置压缩功能所支持的HTTP最低版本</span><br><span class="line">    gzip_http_version 1.1;</span><br><span class="line">    # 设置触发压缩的最小阈值</span><br><span class="line">    gzip_min_length 2k;</span><br><span class="line">    # off/any/expired/no-cache/no-store/private/no_last_modified/no_etag/auth 根据不同配置对后端服务器的响应结果进行压缩</span><br><span class="line">    gzip_proxied any;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>不管是html还是接口响应数据， 压缩后的体积变得非常小了，压缩的效果还是不错的，但是值得注意的是压缩后虽然体积变小了，但是响应的时间会变长，因为压缩&#x2F;解压也需要时间呀！压缩功能似乎有点：用时间换空间的感觉！，当然压缩级别可以调的，你可以选择较低级别的压缩，这样既能实现压缩功能使得数据包体积降下来，同时压缩时间也会缩短是比较折中的一种方案。</p>
<h1 id="完整nginx-conf文件"><a href="#完整nginx-conf文件" class="headerlink" title="完整nginx.conf文件"></a>完整nginx.conf文件</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">user  nginx;</span><br><span class="line">worker_processes  auto;</span><br><span class="line"></span><br><span class="line">error_log  /var/log/nginx/error.log notice;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    # log_format  debug  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">    #                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">    #                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line">    #</span><br><span class="line">    log_format  debug  &#x27; $remote_user [$time_local]  $http_x_Forwarded_for $remote_addr  $request &#x27;  </span><br><span class="line">                      &#x27;$http_x_forwarded_for &#x27;  </span><br><span class="line">                      &#x27;$upstream_addr &#x27;  </span><br><span class="line">                      &#x27;ups_resp_time: $upstream_response_time &#x27;  </span><br><span class="line">                      &#x27;request_time: $request_time&#x27;; </span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  debug;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    upstream mybackendserver &#123;</span><br><span class="line">        server 172.30.128.64:8081 fail_timeout=60s max_fails=3; # 60秒内 如果请求某一个应用失败3次，则认为该应用宕机 时间到后再有请求进来继续尝试连接宕机应用且仅尝试 1 次，如果还是失败，则继续等待 60 秒...以此循环，直到恢复</span><br><span class="line">        server 172.30.128.64:8082;</span><br><span class="line">        server 172.30.128.64:8083 backup; # 设置8083位备机</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     # 开启/关闭 压缩机制</span><br><span class="line">    gzip on;</span><br><span class="line">    # 根据文件类型选择 是否开启压缩机制</span><br><span class="line">    gzip_types text/plain application/javascript text/css application/xml text/javascript image/jpeg image/jpg image/gif image/png  application/json;</span><br><span class="line">    # 设置压缩级别，越高资源消耗越大越耗时，但压缩效果越好</span><br><span class="line">    gzip_comp_level 9;</span><br><span class="line">    # 设置是否携带Vary:Accept-Encoding 的响应头</span><br><span class="line">    gzip_vary on;</span><br><span class="line">    # 处理压缩请求的 缓冲区数量和大小</span><br><span class="line">    gzip_buffers 32 64k;</span><br><span class="line">    # 对于不支持压缩功能的客户端请求 不开启压缩机制</span><br><span class="line">    gzip_disable &quot;MSIE [1-6]\.&quot;; # 比如低版本的IE浏览器不支持压缩</span><br><span class="line">    # 设置压缩功能所支持的HTTP最低版本</span><br><span class="line">    gzip_http_version 1.1;</span><br><span class="line">    # 设置触发压缩的最小阈值</span><br><span class="line">    gzip_min_length 2k;</span><br><span class="line">    # off/any/expired/no-cache/no-store/private/no_last_modified/no_etag/auth 根据不同配置对后端服务器的响应结果进行压缩</span><br><span class="line">    gzip_proxied any;</span><br><span class="line"></span><br><span class="line">    # 指定缓存存放目录为/usr/local/nginx/test/nginx_cache_storage，并设置缓存名称为mycache，大小为64m， 1天未被访问过的缓存将自动清除，磁盘中缓存的最大容量为1gb</span><br><span class="line">    proxy_cache_path /usr/local/nginx/test/nginx_cache_storage levels=1:2 keys_zone=mycache:64m inactive=1d max_size=1g;</span><br><span class="line">    # 对请求速率限流</span><br><span class="line">    #limit_req_zone $binary_remote_addr zone=myRateLimit:10m rate=5r/s;</span><br><span class="line">    # 对请求连接数限流</span><br><span class="line">    limit_conn_zone $binary_remote_addr zone=myConnLimit:10m; </span><br><span class="line">    </span><br><span class="line">    # --------------------HTTP 演示 配置---------------------</span><br><span class="line">    server &#123;</span><br><span class="line">      listen 80 default;</span><br><span class="line">      charset utf-8;</span><br><span class="line">      server_name www.hzznb-xzll.xyz hzznb-xzll.xyz;</span><br><span class="line"></span><br><span class="line">      #location /static/ &#123;</span><br><span class="line">      #    root /usr/local/nginx/test;  # /usr/local/nginx/test/static/xxx.jpg</span><br><span class="line">      #&#125;</span><br><span class="line"></span><br><span class="line">      location /static &#123; # 注意一般 alias的 url都不带后边的/ </span><br><span class="line">          alias /usr/local/nginx/test/; # 使用alias时  这里的目录最后边一定要加/ 否则就404</span><br><span class="line">      &#125;</span><br><span class="line">      # 测试autoindex效果</span><br><span class="line">      location /book/ &#123;</span><br><span class="line">          root /usr/local/nginx/test;</span><br><span class="line">          autoindex on; # 打开 autoindex，，可选参数有 on | off</span><br><span class="line">          autoindex_format html; # 以html的方式进行格式化，可选参数有 html | json | xml</span><br><span class="line">          autoindex_exact_size on; # 修改为off，会以KB、MB、GB显示文件大小，默认为on以bytes显示出⽂件的确切⼤⼩</span><br><span class="line">          autoindex_localtime off; # 显示⽂件时间 GMT格式</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      # 临时重定向</span><br><span class="line">      location /temp_redir &#123;</span><br><span class="line">          rewrite ^/(.*) https://www.baidu.com redirect;</span><br><span class="line">      &#125;</span><br><span class="line">      # 永久重定向</span><br><span class="line">      location /forever_redir &#123;</span><br><span class="line">          </span><br><span class="line">          rewrite ^/(.*) https://www.baidu.com permanent;</span><br><span class="line">      &#125;</span><br><span class="line">      # rewrite last规则测试</span><br><span class="line">      location /1 &#123;</span><br><span class="line">        rewrite /1/(.*) /2/$1 last;</span><br><span class="line">      &#125;</span><br><span class="line">      location /2 &#123;</span><br><span class="line">        rewrite /2/(.*) /3/$1 last;</span><br><span class="line">      &#125;</span><br><span class="line">      location /3 &#123;</span><br><span class="line">        alias  &#x27;/usr/local/nginx/test/static/&#x27;;</span><br><span class="line">        index location_last_test.html; </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # --------------------HTTP配置---------------------</span><br><span class="line">    server &#123;</span><br><span class="line">      listen 80;</span><br><span class="line">      charset utf-8;</span><br><span class="line">      #server_name www.xxxadminsystem.com;</span><br><span class="line">      server_name www.hzznbc-xzll.xyz hzznbc-xzll.xyz;</span><br><span class="line">      # 重定向，会显示跳转的地址server_name,如果访问的地址没有匹配会默认使用第一个，即www.likeong.icu</span><br><span class="line">      return 301 https://$server_name$request_uri;</span><br><span class="line"></span><br><span class="line">        # # 指定 username 参数中只要有字母 就不走nginx缓存  </span><br><span class="line">        # if ($arg_username ~ [a-z]) &#123;</span><br><span class="line">        #     set $cache_name &quot;no cache&quot;;</span><br><span class="line">        # &#125;</span><br><span class="line">        # # 前端页面资源</span><br><span class="line">        # location  /page &#123;</span><br><span class="line">        #   alias  &#x27;/usr/local/nginx/test/static/&#x27;;</span><br><span class="line">        #   index index_page.html; </span><br><span class="line"></span><br><span class="line">        #   allow all;</span><br><span class="line">        # &#125;</span><br><span class="line">        # # 后端服务</span><br><span class="line">        # location  /interface &#123;</span><br><span class="line">        #   proxy_pass http://mybackendserver/;</span><br><span class="line">        #   # 使用名为 mycache 的缓存空间</span><br><span class="line">        #   proxy_cache mycache;</span><br><span class="line">        #   # 对于200 206 状态码的数据缓存2分钟</span><br><span class="line">        #   proxy_cache_valid 200 206 1m;</span><br><span class="line">        #   # 定义生成缓存键的规则（请求的url+参数作为缓存key）</span><br><span class="line">        #   proxy_cache_key $host$uri$is_args$args;</span><br><span class="line">        #   # 资源至少被重复访问2次后再加入缓存</span><br><span class="line">        #   proxy_cache_min_uses 3;</span><br><span class="line">        #   # 出现重复请求时，只让其中一个去后端读数据，其他的从缓存中读取</span><br><span class="line">        #   proxy_cache_lock on;</span><br><span class="line">        #   # 上面的锁 超时时间为4s，超过4s未获取数据，其他请求直接去后端</span><br><span class="line">        #   proxy_cache_lock_timeout 4s;</span><br><span class="line">        #   # 对于请求参数中有字母的 不走nginx缓存</span><br><span class="line">        #   proxy_no_cache $cache_name; # 判断该变量是否有值，如果有值则不进行缓存，没有值则进行缓存</span><br><span class="line">        #   # 在响应头中添加一个缓存是否命中的状态（便于调试）</span><br><span class="line">        #   add_header Cache-status $upstream_cache_status;</span><br><span class="line">          </span><br><span class="line">        #   limit_conn myConnLimit 12;</span><br><span class="line"></span><br><span class="line">        # limit_req zone=myRateLimit burst=5  nodelay;</span><br><span class="line">        # limit_req_status 520;</span><br><span class="line">        # limit_req_log_level info;</span><br><span class="line">        #&#125;  </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # --------------------HTTPS 配置---------------------</span><br><span class="line">    server &#123;</span><br><span class="line">        #SSL 默认访问端口号为 443</span><br><span class="line">        listen 443 ssl; </span><br><span class="line">        #填写绑定证书的域名 </span><br><span class="line">        server_name www.hzznb-xzll.xyz hzznb-xzll.xyz; </span><br><span class="line">        #请填写证书文件的相对路径或绝对路径</span><br><span class="line">        ssl_certificate /usr/local/nginx/certificate/hzznb-xzll.xyz_bundle.crt; </span><br><span class="line">        #请填写私钥文件的相对路径或绝对路径</span><br><span class="line">        ssl_certificate_key /usr/local/nginx/certificate/hzznb-xzll.xyz.key; </span><br><span class="line">        #停止通信时，加密会话的有效期，在该时间段内不需要重新交换密钥</span><br><span class="line">        ssl_session_timeout 5m;</span><br><span class="line">        #服务器支持的TLS版本</span><br><span class="line">        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; </span><br><span class="line">        #请按照以下套件配置，配置加密套件，写法遵循 openssl 标准。</span><br><span class="line">        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE; </span><br><span class="line">        #开启由服务器决定采用的密码套件</span><br><span class="line">        ssl_prefer_server_ciphers on;</span><br><span class="line">        </span><br><span class="line">        # 指定 username 参数中只要有字母 就不走nginx缓存  </span><br><span class="line">        if ($arg_username ~ [a-z]) &#123;</span><br><span class="line">            set $cache_name &quot;no cache&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        # 前端页面资源</span><br><span class="line">        location  /page &#123;</span><br><span class="line">          alias  &#x27;/usr/local/nginx/test/static/&#x27;;</span><br><span class="line">          index index_page.html; </span><br><span class="line"></span><br><span class="line">          allow all;</span><br><span class="line">        &#125;</span><br><span class="line">        # 后端服务</span><br><span class="line">        location  /interface &#123;</span><br><span class="line">          proxy_pass http://mybackendserver/;</span><br><span class="line"></span><br><span class="line">          # 指定哪些错误状态才执行 重试</span><br><span class="line">          proxy_next_upstream error timeout http_500 http_502 http_503 http_504 http_404;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">          # 使用名为 mycache 的缓存空间</span><br><span class="line">          proxy_cache mycache;</span><br><span class="line">          # 对于200 206 状态码的数据缓存2分钟</span><br><span class="line">          proxy_cache_valid 200 206 1m;</span><br><span class="line">          # 定义生成缓存键的规则（请求的url+参数作为缓存key）</span><br><span class="line">          proxy_cache_key $host$uri$is_args$args;</span><br><span class="line">          # 资源至少被重复访问2次后再加入缓存</span><br><span class="line">          proxy_cache_min_uses 3;</span><br><span class="line">          # 出现重复请求时，只让其中一个去后端读数据，其他的从缓存中读取</span><br><span class="line">          proxy_cache_lock on;</span><br><span class="line">          # 上面的锁 超时时间为4s，超过4s未获取数据，其他请求直接去后端</span><br><span class="line">          proxy_cache_lock_timeout 4s;</span><br><span class="line">          # 对于请求参数中有字母的 不走nginx缓存</span><br><span class="line">          proxy_no_cache $cache_name; # 判断该变量是否有值，如果有值则不进行缓存，没有值则进行缓存</span><br><span class="line">          # 在响应头中添加一个缓存是否命中的状态（便于调试）</span><br><span class="line">          add_header Cache-status $upstream_cache_status;</span><br><span class="line">          </span><br><span class="line">          limit_conn myConnLimit 12;</span><br><span class="line"></span><br><span class="line">        # limit_req zone=myRateLimit burst=5  nodelay;</span><br><span class="line">        # limit_req_status 520;</span><br><span class="line">        # limit_req_log_level info;</span><br><span class="line">        &#125; </span><br><span class="line"></span><br><span class="line">        # 后端服务</span><br><span class="line">        location  /interface2 &#123;</span><br><span class="line">          proxy_pass http://mybackendserver;</span><br><span class="line">          # 使用名为 mycache 的缓存空间</span><br><span class="line">          proxy_cache mycache;</span><br><span class="line">          # 对于200 206 状态码的数据缓存2分钟</span><br><span class="line">          proxy_cache_valid 200 206 1m;</span><br><span class="line">          # 定义生成缓存键的规则（请求的url+参数作为缓存key）</span><br><span class="line">          proxy_cache_key $host$uri$is_args$args;</span><br><span class="line">          # 资源至少被重复访问2次后再加入缓存</span><br><span class="line">          proxy_cache_min_uses 3;</span><br><span class="line">          # 出现重复请求时，只让其中一个去后端读数据，其他的从缓存中读取</span><br><span class="line">          proxy_cache_lock on;</span><br><span class="line">          # 上面的锁 超时时间为4s，超过4s未获取数据，其他请求直接去后端</span><br><span class="line">          proxy_cache_lock_timeout 4s;</span><br><span class="line">          # 对于请求参数中有字母的 不走nginx缓存</span><br><span class="line">          proxy_no_cache $cache_name; # 判断该变量是否有值，如果有值则不进行缓存，没有值则进行缓存</span><br><span class="line">          # 在响应头中添加一个缓存是否命中的状态（便于调试）</span><br><span class="line">          add_header Cache-status $upstream_cache_status;</span><br><span class="line">          </span><br><span class="line">          limit_conn myConnLimit 12;</span><br><span class="line"></span><br><span class="line">        # limit_req zone=myRateLimit burst=5  nodelay;</span><br><span class="line">        # limit_req_status 520;</span><br><span class="line">        # limit_req_log_level info;</span><br><span class="line">        &#125; </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # include /etc/nginx/conf.d/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7306041273822527514#heading-67">https://juejin.cn/post/7306041273822527514#heading-67</a><br><a target="_blank" rel="noopener" href="https://openresty.org/download/agentzh-nginx-tutorials-zhcn.html#00-Foreword02">https://openresty.org/download/agentzh-nginx-tutorials-zhcn.html#00-Foreword02</a></p>
<p><a target="_blank" rel="noopener" href="https://openresty.org/cn/">https://openresty.org/cn/</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7166923395802595336?searchId=2024052312322984A6B385B1DDE00B11FC#heading-13">https://juejin.cn/post/7166923395802595336?searchId=2024052312322984A6B385B1DDE00B11FC#heading-13</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://leetao50.github.io/2024/05/23/sundries/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F-%E7%8E%AF%E8%A7%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="InfoPool">
      <meta itemprop="description" content="记录信息来源网络，内容只为方便查找，非公开信息，非请勿入">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | InfoPool">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/23/sundries/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F-%E7%8E%AF%E8%A7%86/" class="post-title-link" itemprop="url">正则表达式-环视</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-05-23 10:38:02 / 修改时间：11:59:42" itemprop="dateCreated datePublished" datetime="2024-05-23T10:38:02+08:00">2024-05-23</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="环视基础"><a href="#环视基础" class="headerlink" title="环视基础"></a>环视基础</h1><p>环视只进行子表达式的匹配，不占有字符，匹配到的内容不保存到最终的匹配结果，是零宽度的。环视匹配的最终结果就是一个位置。</p>
<p>环视的作用相当于对所在位置加了一个附加条件，只有满足这个条件，环视子表达式才能匹配成功。</p>
<p><img src="63fde1e69dfec6f17cfdbb122124dcff80ab46058c165f3b56371f5c42ac1ee5.png" alt="图 0"><br>对于字符串”abc”，正则表达式可以匹配的元素有三个字符与四个位置，分别是字符“a”,“b”,“c”与位置0,1,2,3。正则中类似a，\d，\w，.，*之类的，都是用来匹配的字符的，而环视是用来匹配位置的。</p>
<p>环视按照方向划分有顺序和逆序两种，按照是否匹配有肯定和否定两种，组合起来就有四种环视。顺序环视相当于在当前位置右侧附加一个条件，而逆序环视相当于在当前位置左侧附加一个条件。</p>
<table>
<thead>
<tr>
<th>表达式</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>(?&#x3D;Expression)</td>
<td>顺序肯定环视，表示所在位置右侧能够匹配Expression</td>
</tr>
<tr>
<td>(?!Expression)</td>
<td>顺序否定环视，表示所在位置右侧不能匹配Expression</td>
</tr>
<tr>
<td>(?&lt;&#x3D;Expression)</td>
<td>逆序肯定环视，表示所在位置左侧能够匹配Expression</td>
</tr>
<tr>
<td>(?&lt;!Expression)</td>
<td>逆序否定环视，表示所在位置左侧不能匹配Expression</td>
</tr>
</tbody></table>
<p>所谓顺序、逆序，说的其实就是对此位置的左侧还是右侧进行约束。因为正则表达式的匹配顺序是从左至右的，所以顺序环视就是对匹配位置的右侧进行约束，逆序环视就是对匹配位置的左侧进行约束。肯定说的是需要此位置的左侧或者右侧是什么，否定说的是需要此位置的左侧或者右侧不是什么。</p>
<p>对于环视的叫法，有的文档里叫预搜索，有的叫什么什么断言的，这里使用了更多人容易接受的《精通正则表达式》中“环视”的叫法，其实叫什么无所谓，只要知道是什么作用就是了，就这么几个语法规则， 还是很容易记的。</p>
<h1 id="顺序肯定环视"><a href="#顺序肯定环视" class="headerlink" title="顺序肯定环视"></a>顺序肯定环视</h1><p>顺序肯定环视的表达式为(?&#x3D;expression)，要求位置右侧要符合expression，这个位置才能成功匹配整个的环视表达式。(?&#x3D;b)即要求匹配位置的右侧为b。对于字符串abb，共有四个位置可供匹配。<br><img src="d0d09b1dea11df4799aba786fa8c439a88b2f81879a7e00734adff5549cf7b6c.png" alt="图 1">  </p>
<p><strong>(?&#x3D;b)的简要匹配过程如下：</strong></p>
<ol>
<li>(?&#x3D;b)先去尝试匹配位置0，发现位置0的右侧是a，不是b，不符合(?&#x3D;b)；</li>
<li>字符a不是位置，不进行匹配；</li>
<li>(?&#x3D;b)尝试匹配位置1，位置1的右侧是b，符合(?&#x3D;b)，保存匹配结果；</li>
<li>字符b不是位置，不进行匹配；</li>
<li>(?&#x3D;b)尝试匹配位置2，位置2的右侧是b，符合(?&#x3D;b)，保存匹配结果；</li>
<li>字符b不是位置，不进行匹配；</li>
<li>(?&#x3D;b)尝试匹配位置3，位置3的右侧没有字符，不是b，不符合(?&#x3D;b)。</li>
</ol>
<p>最终匹配结果，只有位置1与位置2匹配成功，如下图所示。<br><img src="5b92811d43a6ad8cf1882dd2ac913007d8cf7e5fb0bfeab84af21ff01db56c14.png" alt="图 3">  </p>
<p>环视单独使用作用不明显，因为它是零宽度的，不占有字符，匹配成功也不会返回字符。环视与字符配合使用，才能发挥它的最大威力。</p>
<p>要求匹配字符a，并且a的右侧必须是b。相应的正则表达式为a(?&#x3D;b)。准备匹配的字符串为abb、ada、acb。</p>
<p><code>正则表达式a</code>匹配，abb、ada、acb中的所有a都会被匹配到，如下图。<br><img src="55bf568b7c9bd8d3102649068167f4022b58fac30ddd13f955b858c6eb8c1295.png" alt="图 4">  </p>
<p><code>当正则表达式改为a(?=b)</code>，就只有一个a符合要求。<br><img src="35e4a8f284b71445a275cc4a1a5b53c76e1f21a34496673f7856012747fbb45b.png" alt="图 5">  </p>
<p>下面解释一下a(?&#x3D;b)。为了方便理解，将正则表达式a(?&#x3D;b)的匹配分为两步。</p>
<p>先用a去匹配字符串中的a，这时会有4个字符符合要求。分别是abb中的a，ada中两个a，acb中的a。表达式中(?&#x3D;b)用来匹配位置，因为(?&#x3D;b)在表达式a(?&#x3D;b)中位于a的右侧，意味着它对匹配到的a的右侧位置提出了要求。如下图所示，有四个位置需要匹配。<br><img src="eb7bd1286e6f89bc96bf44d38fc35de9d5ba94561ab311177c6554782a34f497.png" alt="图 7">  </p>
<p><img src="8c799521c4348867188ff251bbaa86ff049bc1366505c375071c27afceb86fd5.png" alt="图 6">  </p>
<p><img src="3ab2384d4b452b7b7671226a6608a66616aa4624f18b022762979c2f2bb212e0.png" alt="图 8">  </p>
<p>(?&#x3D;b)是顺序肯定环视，即需要匹配的位置的右侧是表达式b。用(?&#x3D;b)去匹配位置1，位置1的右侧是字符b，符合要求，所以位置1符合要求。用(?&#x3D;b)匹配位置2，位置2的右侧是字符d，所以位置2不符合要求。用(?&#x3D;b)匹配位置3，位置3的右侧是换行符或是没有字符(这取决于ada是不是字符串结尾)，不符合(?&#x3D;b)。位置4也不符合(?&#x3D;b)。最终只有abb中的a符合整体正则表达式a(?&#x3D;b)。</p>
<blockquote>
<p><strong>匹配过程不是上文说的那样，上述说法只是为了方便理解。实际上，正则引擎会先用正则表达式a(?&#x3D;b)中最左侧的字符a去尝试匹配到abb中的第一个a，匹配成功，再用(?&#x3D;b)去匹配a右侧的位置，符合要求，所以abb中的a符合正则表达式a(?&#x3D;b)的整体要求，匹配成功。然后正则引擎会用a去尝试匹配abb中的第一个b，不符合要求，舍弃，继续用a尝试匹配abb中的第二个b，仍然不符合要求。正则引擎继续用正则表达式中的a匹配ada中的第一个a，符合要求，再用(?&#x3D;b)尝试匹配此a的右侧位置，此位置的右侧不是b，不符合要求。ada中的第一个a不符合正则表达式a(?&#x3D;b)的整体要求，舍弃，继续向右匹配，直到所有的字符都被匹配一遍。</strong></p>
</blockquote>
<p>需要注意的是，正则表达式a(?&#x3D;b)最终匹配的是abb中的a，而不是abb中的ab，时刻牢记，环视匹配的是位置，不占有字符，所以也被称为零宽断言。</p>
<h1 id="顺序否定环视"><a href="#顺序否定环视" class="headerlink" title="顺序否定环视"></a>顺序否定环视</h1><p>顺序否定环视的表达式为(?!expression)，要求匹配的位置右侧不能是expression。(?!b)即要求匹配位置的右侧不能是b。</p>
<p><code>正则表达式a</code>匹配，abb、ada、acb中的所有a都会被匹配到，如下图。<br><img src="2191f8d152aa01d17b1d05aaadb8e3db1d8ad24837c47cc4b42905f3e8449513.png" alt="图 10">  </p>
<p><code>当正则表达式改为a(?!b)</code>，则abb中的a会不符合正则表达式。<br><img src="abe2116a4a7b4cf3a71995f306b1365ab53a41100776d3e4c7f8445a5907298b.png" alt="图 11">  </p>
<p><strong>匹配过程简述如下：</strong></p>
<ol>
<li>正则引擎先尝试用a匹配abb中的a，符合要求；</li>
<li>引擎继续用(?!b)匹配a的右侧位置，要求此位置的右侧不能是b，匹配后发现位置不符合此要求，则abb中的字符a不符合整个正则表达式a(?!b)；</li>
<li>正则引擎舍弃abb中的a，继续向右匹配；</li>
<li>匹配到ada中的第一个a，符合正则表达式中的a；</li>
<li>正则引擎继续用(?!b)匹配a的右侧位置，要求此位置的右侧不能是b，符合要求，所以ada中的第一个a符合正则表达式a(?!b)的整体要求，匹配成功；</li>
<li>剩下的两个a也是同样是匹配过程。</li>
</ol>
<p>就上面的问题而言，使用a[^b]同样可以只匹配到ada、acb中的a，而不去匹配abb中的a。但是这样有两个问题，一是a[^b]不只是匹配了a一个字符，实际匹配到了a与a后面的字符；二是若是想要匹配abb、abd、ab中的a，并且排除abc中的a，上述正则表达式就会失效。这时环视就显示出优势了，通过a(?!bc)就可以区分。<br><img src="42214cfec24371af7a6c34bbfc713a883100e118364db2cb221c322c6a959f43.png" alt="图 12">  </p>
<p>所以，环视在针对表达式进行匹配时，会很方便。</p>
<h1 id="逆序肯定环视"><a href="#逆序肯定环视" class="headerlink" title="逆序肯定环视"></a>逆序肯定环视</h1><p>逆序肯定环视的表达式为(?&lt;&#x3D;expression)，要求匹配位置的左侧必须是expression，例如(?&lt;&#x3D;b)即要求匹配位置的左侧必须是b。</p>
<p><code>正则表达式a</code>匹配，abc、bab、dad中的所有a都会被匹配到，如下图。<br><img src="f1c470132df22952c97ea8da853c657dfa1a5aaff127e750a25b13894291fb86.png" alt="图 13"><br><code>当正则表达式改为(?&lt;=b)a</code>，则只有bab中的a符合正则表达式。<br><img src="e9adcc05c8fecbb508e8508f32067a055d8e59172f3b7c0513b8db3255e4d6e1.png" alt="图 14">  </p>
<p><code>匹配过程简述如下：</code></p>
<ol>
<li>表达式(?&lt;&#x3D;b)a会先用(?&lt;&#x3D;b)对字符串abc中的位置0进行匹配，也就是abc中a的左侧位置，此位置的左侧无字符，自然也不是b，不符合(?&lt;&#x3D;b)；</li>
<li>继续使用(?&lt;&#x3D;b)匹配abc中的位置1，也就是b的左侧位置，此位置左侧为a，不符合(?&lt;&#x3D;b)；</li>
<li>继续向左匹配，直到匹配到bab中的位置1，也就是a的左侧位置，位置1的左侧为b，符合(?&lt;&#x3D;b)；</li>
<li>然后用正则表达式(?&lt;&#x3D;b)a中的a继续进行匹配，因为a位于(?&lt;&#x3D;b)的右侧，所以用a去匹配bab中位置1的右侧字符，匹配成功；</li>
<li>至此，bab中的位置1与位置1右侧的字符a对表达式(?&lt;&#x3D;b)a全部匹配成功，将匹配结果保存；</li>
<li>正则表达式继续向左匹配，直到全部匹配结束。</li>
</ol>
<p>可以看到，对正则表达式进行匹配时，也是先对表达式中的左侧元素匹配，成功后才会匹配表达式中的下一个元素。</p>
<h1 id="逆序否定环视"><a href="#逆序否定环视" class="headerlink" title="逆序否定环视"></a>逆序否定环视</h1><p>逆序否定环视的表达式为(?&lt;!expression)，要求匹配位置的左侧不是expression，例如(?&lt;!b)即要求匹配位置的左侧不能是b。<br><code>正则表达式a</code>匹配，abc、bab、dad中的所有a都会被匹配到，如下图。<br><img src="02d6a6377e8fc699694f58b7b4022c72b264c0d81a14797f0c06c02aa413da77f.png" alt="图 15"><br><code>当正则表达式改为(?&lt;!b)a</code>，则只有abc、dad中的a符合正则表达式。<br><img src="3bf7a1c628fa9be1b7c2bcd80303a08986a763502abd3315cdf54e1b29fe1f9b.png" alt="图 16">  </p>
<p><strong>匹配过程简述如下：</strong></p>
<ol>
<li>表达式(?&lt;!b)a首先用(?&lt;!b)去尝试匹配abc中的位置0，也就是abc中的a的左侧位置，位置0的左边无字符，自然也不是字符b，符合(?&lt;!b)；</li>
<li>然后用(?&lt;!b)a中的a继续匹配，因为表达式中a在(?&lt;!b)的右侧，所以会尝试匹配位置0的右侧字符，匹配成功；</li>
<li>abc中的位置0与位置0右侧的字符a对整个正则表达式(?&lt;!b)a匹配成功；</li>
<li>表达式(?&lt;!b)a用(?&lt;!b)去继续尝试匹配abc中的位置1，匹配成功；</li>
<li>正则中的a继续匹配位置1的右侧字符，匹配失败，</li>
<li>abc中的位置1与位置1右侧的字符b对整个正则表达式(?&lt;!b)a匹配失败；</li>
<li>正则表达式(?&lt;!b)a继续向左匹配，直到所有的位置与字符都匹配完毕。</li>
</ol>
<h1 id="其他环视"><a href="#其他环视" class="headerlink" title="其他环视"></a>其他环视</h1><p>既然是对位置的匹配，那么\b，^，$也可以视为环视。\b匹配单词边界或是字符串的起始或结束，要求是此位置的前后，分别是单词字符和不是单词字符，等价于(?&lt;!\w)(?&#x3D;\w)|(?&lt;&#x3D;\w)(?!\w)，但是不等价于(?&lt;&#x3D;\W)(?&#x3D;\w)|(?&lt;&#x3D;\w)(?&#x3D;\W)。同样的，^也是匹配一个位置，要求是此位置左侧非字符，右侧任意字符，等价于(?&lt;![\w\W])(?&#x3D;[\w\W])。$匹配一个位置，要求是此位置左侧任意字符，右侧非字符，等价于(?&lt;&#x3D;[\w\W])(?![\w\W])。</p>
<p>\b匹配单词边界或是字符串的起始或结束，如下图所示，\b匹配了word单词前后，on单词前后，off单词前后共6个位置。</p>
<p><img src="86d302288a321338f42a15eb248676c0185311ee021a5249e6c4c10c68e11926.png" alt="图 17">  </p>
<p>(?&lt;!\w)(?&#x3D;\w)|(?&lt;&#x3D;\w)(?!\w)匹配同样的内容，结果如下所示，匹配结果与\b一致。</p>
<p><img src="ae305a63135bb7e24fb8bda1c65269dc149b3de05b5586a7de009c2711d658b7.png" alt="图 18"><br>(?&lt;&#x3D;\W)(?&#x3D;\w)|(?&lt;&#x3D;\w)(?&#x3D;\W)匹配同样的内容，结果如下所示。<br><img src="486bc489c87bc66c7104c6ccaac964602f8c28a13731d4f3dcdfd9330123fd4d.png" alt="图 19"><br>可以看到，字符串内的单词间隔都可以正确匹配，问题出在字符串的起始与结束。表达式的本意是通过(?&lt;&#x3D;\W)(?&#x3D;\w)匹配单词与字符串的起始位置，(?&lt;&#x3D;\w)(?&#x3D;\W)匹配单词与字符串的终止位置。</p>
<p>但(?&lt;&#x3D;\W)(?&#x3D;\w)要求匹配的位置，左侧是非单词字符，但其中隐含要求左侧需要有字符，然后右侧为单词字符。但是对于字符串起始位置，左侧是没有字符的，自然也就就无法匹配(?&lt;&#x3D;\W)，所以字符串起始位置匹配失败。字符串终止位置是同样的问题。</p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p>正则大神主页：<a target="_blank" rel="noopener" href="https://blog.csdn.net/lxcnn?t=1">https://blog.csdn.net/lxcnn?t=1</a><br>正则表达式入门教程：<a target="_blank" rel="noopener" href="https://deerchao.cn/tutorials/regex/regex.htm#top">https://deerchao.cn/tutorials/regex/regex.htm#top</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://leetao50.github.io/2024/05/22/nginx/location%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="InfoPool">
      <meta itemprop="description" content="记录信息来源网络，内容只为方便查找，非公开信息，非请勿入">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | InfoPool">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/22/nginx/location%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99/" class="post-title-link" itemprop="url">Nginx中location 匹配规则</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-05-22 15:20:26" itemprop="dateCreated datePublished" datetime="2024-05-22T15:20:26+08:00">2024-05-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-24 18:11:53" itemprop="dateModified" datetime="2024-05-24T18:11:53+08:00">2024-05-24</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="location-匹配的变量"><a href="#location-匹配的变量" class="headerlink" title="location 匹配的变量"></a>location 匹配的变量</h1><p>Nginx 的 location 规则匹配的变量是 $uri, 所以不用管后面的参数 $query_string (或者 $args)</p>
<h1 id="location-匹配的种类"><a href="#location-匹配的种类" class="headerlink" title="location 匹配的种类"></a>location 匹配的种类</h1><p>匹配格式:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location <span class="punctuation">[</span>空格 | = | ~ | ~* | ^~ | @ <span class="punctuation">]</span> /uri/ <span class="punctuation">&#123;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>上面匹配格式分为三部分:</p>
<ol>
<li>修饰符匹配规则<br><code>[空格 | = | ~ | ~* | ^~ | @ ]</code></li>
<li>uri匹配规则<br><code>/uri/</code></li>
<li>大括号内的路由转发<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="修饰符匹配规则"><a href="#修饰符匹配规则" class="headerlink" title="修饰符匹配规则"></a>修饰符匹配规则</h1><p>格式:<br><code>[空格 | ^~ |  = | ~ | ~* |@ ]</code></p>
<p>接下来解释一下，这些都表示啥意思:</p>
<table>
<thead>
<tr>
<th>字符</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>空格</td>
<td>无修饰符的前缀匹配，匹配前缀是 你配置的（比如说你配的是 &#x2F;aaa） 的url</td>
</tr>
<tr>
<td>^~</td>
<td>常规字符串匹配（跟空格类似，但是它优先级比空格高）。^表示“非”，即不查询正则表达式。如果匹配成功，并且所匹配的字符串是最长的， 则不再匹配其他location。</td>
</tr>
<tr>
<td>&#x3D;</td>
<td>表示精确匹配，如果找到，立即停止搜索并立即处理此请求。</td>
</tr>
<tr>
<td>~</td>
<td>表示执行一个正则匹配，区分大小写</td>
</tr>
<tr>
<td><code>~*</code></td>
<td>表示执行一个正则匹配，不区分大小写。注意，如果是运行 Nginx server 的系统本身对大小写不敏感，比如 Windows ，那么 ~* 和 ~ 这两个表现是一样的</td>
</tr>
<tr>
<td>@</td>
<td>用于定义一个 Location块，且该块不能被外部Client 所访问，只能被Nginx内部配置指令所访问，比如try_files 或 error_page</td>
</tr>
</tbody></table>
<h2 id="修饰符的匹配顺序"><a href="#修饰符的匹配顺序" class="headerlink" title="修饰符的匹配顺序"></a>修饰符的匹配顺序</h2><ol>
<li>优先查找精确匹配，精确匹配 (&#x3D;) 的 location 如果匹配请求 URI 的话，此 location 被马上使用，匹配过程结束。</li>
<li>接下来进行常规字符串匹配(空格 和 <del>^), 如果发现匹配最长的那个是 ^</del> 前缀, 那么也停止搜索并且马上使用，匹配过程结束。 否则继续往下走。</li>
<li>如果常规字符串匹配失败，或者匹配的最长字符串不是 ^~ 前缀 (比如是空格匹配)，那么继续搜索正则表达式匹配， 这时候就根据在配置文件定义的顺序，取最上面的配置(正则匹配跟匹配长度没关系，只跟位置有关系，只取顺序最上面的匹配)</li>
<li>如果第三步找到了，那么就用第三步的匹配，否则就用第二步的匹配(字符匹配最长的空格匹配)</li>
</ol>
<p>简单的来说就是顺序如下:<br><code>精确匹配 &gt; 字符串匹配( 长 &gt; 短 [ 注: ^~ 匹配则停止匹配 ]) &gt; 正则匹配( 上 &gt; 下 )</code></p>
<p>换成符号的优先级就是:<br><code>[=] &gt; [^~] &gt; [~/~*] &gt; [空格]</code></p>
<p><strong>注意几个细节:</strong></p>
<ol>
<li>常规字符串匹配类型。是按前缀匹配(从根开始)。 而正则表达式匹配是包含匹配，只要包含就可以匹配</li>
<li><del>和</del>*的优先级一样，取决于在配置文件中的位置，最上面的为主，跟匹配的字符串长度没关系，所以在写的时候，应该越精准的要放在越前面</li>
<li>空格匹配和^~都是字符串匹配，所以如果两个后面的匹配字符串一样，是会报错的，因为 nginx 会认为两者的匹配规则一致，所以会有冲突</li>
<li>^~, &#x3D;, ~, ~* 这些修饰符和后面的 URI 字符串中间可以不使用空格隔开(大部分都是用空格隔开)。但是 @ 修饰符必须和 URI 字符串直接连接。</li>
</ol>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">200</span> <span class="string">&#x27;404&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ~ /hello &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">200</span> <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ^~ /hello &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">200</span> <span class="string">&#x27;2&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location = /hello &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">200</span> <span class="string">&#x27;3&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ~* /hello &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">200</span> <span class="string">&#x27;4&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个是测试结果</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_156_200_centos ~]<span class="comment"># curl 127.0.0.1/hello  #精确匹配，直接结束</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line">[root@VM_156_200_centos ~]<span class="comment"># curl 127.0.0.1/hello11 #字符串匹配，并且最大长度的匹配是 ^~,直接结束</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">[root@VM_156_200_centos ~]<span class="comment"># curl 127.0.0.1/hello/22 #字符串匹配，并且最大长度的匹配是 ~^,直接结束</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">[root@VM_156_200_centos ~]<span class="comment"># curl 127.0.0.1/11/hello/ #字符串不匹配(前缀匹配)，正则匹配有两个，取最上面的那个</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">[root@VM_156_200_centos ~]<span class="comment"># curl 127.0.0.1/11/Hello/ #字符串不匹配(前缀匹配)，正则匹配有一个(大小写不敏感)，取最上面的那个</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line">[root@VM_156_200_centos ~]<span class="comment"># curl 127.0.0.1/11/Hell #都不匹配，有设置通用匹配，取通用匹配</span></span><br><span class="line"><span class="number">404</span></span><br></pre></td></tr></table></figure>

<p>配置文件配置:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">location /images/test.png &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">200</span>  <span class="string">&#x27;1&#x27;</span>;     </span><br><span class="line">&#125;        </span><br><span class="line"></span><br><span class="line">location ^~ /images/ &#123; </span><br><span class="line">  <span class="keyword">return</span> <span class="number">200</span>  <span class="string">&#x27;2&#x27;</span>;      </span><br><span class="line">&#125;    </span><br><span class="line"></span><br><span class="line">location ~ /images/ &#123;        </span><br><span class="line">  <span class="keyword">return</span> <span class="number">200</span>  <span class="string">&#x27;3&#x27;</span>;   </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">location ~ /images/test.png &#123;        </span><br><span class="line">  <span class="keyword">return</span> <span class="number">200</span>  <span class="string">&#x27;4&#x27;</span>;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个是测试结果</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_156_200_centos ~]<span class="comment">#  curl http://127.0.0.1/images/test.png </span></span><br><span class="line"><span class="number">3</span></span><br><span class="line">[root@VM_156_200_centos ~]<span class="comment">#  curl http://127.0.0.1/images/1 </span></span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>第一个返回 3 是因为本例是 普通匹配和正则匹配都存在， 并且因为 ^~ 匹配不是最长的话，那么就取 正则匹配， 正则匹配满足条件的有两个， 取最上面那个， 所以是 3， (本例的字符串最长匹配是空格匹配)。(对于本例来说，如果去掉后面的两个正则匹配，那么返回的就是 1， 因为空格匹配的字符串是最长的)<br>第二个返回 2 是因为普通匹配和正则匹配都存在，但是这个^~ 匹配是最长的，所以就是 2。</p>
<p>普通字符串的匹配冲突<br>如果我这样子写:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location /images/test.png &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="number">200</span>  <span class="string">&#x27;1&#x27;</span>;     </span><br><span class="line"> &#125;        </span><br><span class="line"></span><br><span class="line"> location ^~ /images/test.png &#123; </span><br><span class="line">      <span class="keyword">return</span> <span class="number">200</span>  <span class="string">&#x27;2&#x27;</span>;      </span><br><span class="line"> &#125;  </span><br></pre></td></tr></table></figure>

<p>这时候我 reload 是会报错的:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@VM_156_200_centos sbin]<span class="comment"># ./nginx -s reload</span></span><br><span class="line">nginx: [emerg] duplicate location <span class="string">&quot;/images/test.png&quot;</span> <span class="keyword">in</span> /usr/local/nginx/conf/nginx.conf:<span class="number">20</span></span><br></pre></td></tr></table></figure>

<h2 id="辟谣-比-优先级高"><a href="#辟谣-比-优先级高" class="headerlink" title="辟谣 ~ 比 ~* 优先级高"></a>辟谣 ~ 比 ~* 优先级高</h2><p>之前也有在网上看到这种说法，就是匹配顺序的时候，如果都匹配了，那么 ~ 比 ~* 优先级高，其实这个说法是错误的，这哥俩并没有谁比谁高贵，根据上面的匹配顺序，如果都是正则匹配，那么就是谁排在前面，就采用谁。 做个实践, 我的执行顺序是这样子的:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location ~* \.jpG$ &#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="number">200</span>  <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ~ \.jpg$ &#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="number">200</span>  <span class="string">&#x27;2&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我的测试结果如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_156_200_centos ~]<span class="comment"># curl 127.0.0.1/1.jpg</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">[root@VM_156_200_centos ~]<span class="comment"># curl 127.0.0.1/1.JPG</span></span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>只要有匹配，肯定是最上面的那个 1。</p>
<h2 id="辟谣之-修饰符-包含-和"><a href="#辟谣之-修饰符-包含-和" class="headerlink" title="辟谣之  修饰符 包含 !~ 和 !~*"></a>辟谣之  修饰符 包含 !~ 和 !~*</h2><p>我看到有些网上的文章说 nginx 的 location modifier 还包含 !~ 和 !~* 这两个，其实是不对的(也有可能是旧版本的，至少我的最新版本的 nginx 不支持)， 如果你这样子:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location !~ \.(gif|jpg)$ &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">200</span>  <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么在 reload 的时候， nginx 会报这个错误:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx: [emerg] invalid location modifier <span class="string">&quot;!~&quot;</span> <span class="keyword">in</span> /usr/local/nginx/conf/nginx.conf:<span class="number">25</span></span><br></pre></td></tr></table></figure>
<p>不过因为 Nginx 的正则是使用PCRE（Perl Compatible Regular Expressions）, 所以我们可以这样子写来达到我们想要的目的:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location ~ \.*(?&lt;!(gif|jpg))$ &#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="number">200</span>  <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>做个实践，假设我的路由是这样子: 如果后缀含有 gif 或者是 jpg， 那么就会返回 200， 否则就会返回 404</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">200</span> <span class="string">&#x27;404&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ~ \.(gif|jpg)$ &#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="number">200</span>  <span class="string">&#x27;200&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试结果如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_156_200_centos ~]<span class="comment"># curl 127.0.0.1/1.gif</span></span><br><span class="line"><span class="number">200</span></span><br><span class="line">[root@VM_156_200_centos ~]<span class="comment"># curl 127.0.0.1/1.jpg</span></span><br><span class="line"><span class="number">200</span></span><br><span class="line">[root@VM_156_200_centos ~]<span class="comment"># curl 127.0.0.1/1.js</span></span><br><span class="line"><span class="number">404</span></span><br><span class="line">[root@VM_156_200_centos ~]<span class="comment"># curl 127.0.0.1/1.css</span></span><br><span class="line"><span class="number">404</span></span><br></pre></td></tr></table></figure>
<p>这个结果是对的。 那么就换成，如果后缀不是 gif 或者是 jpg，那么才返回 200， 否则就返回 404 (相当于上述的 !~):</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">200</span> <span class="string">&#x27;404&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line">location ~ \.*(?&lt;!(gif|jpg))$ &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">200</span>  <span class="string">&#x27;200&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，同样的结果，结果相反了:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_156_200_centos ~]<span class="comment"># curl 127.0.0.1/1.gif</span></span><br><span class="line"><span class="number">404</span></span><br><span class="line">[root@VM_156_200_centos ~]<span class="comment"># curl 127.0.0.1/1.jpg</span></span><br><span class="line"><span class="number">404</span></span><br><span class="line">[root@VM_156_200_centos ~]<span class="comment"># curl 127.0.0.1/1.js</span></span><br><span class="line"><span class="number">200</span></span><br><span class="line">[root@VM_156_200_centos ~]<span class="comment"># curl 127.0.0.1/1.css</span></span><br><span class="line"><span class="number">200</span></span><br></pre></td></tr></table></figure>
<p>所以是可以实现这种效果的。</p>
<h2 id="前缀的命名匹配"><a href="#前缀的命名匹配" class="headerlink" title="@前缀的命名匹配"></a>@前缀的命名匹配</h2><p>这个主要是内部定义一个 location 块，举个例子，因为 location 只验证 uri，参数是没有验证的，如果我们要验证参数，并且要根据不同的参数来进行不同的操作的话，就可以用这个内部定义块，举个例子:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    error_page <span class="number">418</span> = @queryone;</span><br><span class="line">    error_page <span class="number">419</span> = @querytwo;</span><br><span class="line">    error_page <span class="number">420</span> = @querythree;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( $args ~ <span class="string">&quot;service=one&quot;</span> ) &#123; <span class="keyword">return</span> <span class="number">418</span>; &#125;</span><br><span class="line">    <span class="keyword">if</span> ( $args ~ <span class="string">&quot;service=two&quot;</span> ) &#123; <span class="keyword">return</span> <span class="number">419</span>; &#125;</span><br><span class="line">    <span class="keyword">if</span> ( $args ~ <span class="string">&quot;service=three&quot;</span> ) &#123; <span class="keyword">return</span> <span class="number">420</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># do the remaining stuff</span></span><br><span class="line">    <span class="comment"># ex: try_files $uri =404;</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  location @queryone &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">200</span> <span class="string">&#x27;do stuff for one&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  location @querytwo &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">200</span> <span class="string">&#x27;do stuff for two&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  location @querythree &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">200</span> <span class="string">&#x27;do stuff for three&#x27;</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>测试结果如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_156_200_centos ~]<span class="comment">#  curl http://127.0.0.1/?service=one</span></span><br><span class="line">do stuff <span class="keyword">for</span> one</span><br><span class="line"></span><br><span class="line">[root@VM_156_200_centos ~]<span class="comment">#  curl http://127.0.0.1/?service=two</span></span><br><span class="line">do stuff <span class="keyword">for</span> two</span><br><span class="line"></span><br><span class="line">[root@VM_156_200_centos ~]<span class="comment">#  curl http://127.0.0.1/?service=three</span></span><br><span class="line">do stuff <span class="keyword">for</span> three</span><br></pre></td></tr></table></figure>

<h1 id="location-uri匹配规则"><a href="#location-uri匹配规则" class="headerlink" title="location uri匹配规则"></a>location uri匹配规则</h1><p>根据前面的符号，这里可以填写精确到 path 路径，也可以填正则表达式，Nginx 用的是 PCRE正则表达式语法，下表是在PCRE中元字符及其在正则表达式上下文中的行为的一个完整列表：</p>
<table>
<thead>
<tr>
<th>字符</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>|将下一个字符标记为一个特殊字符、或一个原义字符、或一个向后引用、或一个八进制转义符。例如，\n 匹配 \n。\n 匹配换行符。序列 \ 匹配 \ , 而 ( 则匹配 (。即相当于多种编程语言中都有的转义字符的概念。</td>
<td></td>
</tr>
<tr>
<td>^</td>
<td>匹配输入字符串的开始位置。如果设置了 RegExp 对象的 Multiline 属性，^ 也匹配\n 或 \r 之后的位置。</td>
</tr>
<tr>
<td>$</td>
<td>匹配输入字符串的结束位置。如果设置了 RegExp 对象的 Multiline 属性，$ 也匹配\n 或 \r 之前的位置。</td>
</tr>
<tr>
<td><code>*</code></td>
<td>匹配前面的子表达式零次或多次。例如，zo* 能匹配 z 以及zoo。 * 等价于 {0,}。</td>
</tr>
<tr>
<td>+</td>
<td>匹配前面的子表达式一次或多次。例如，zo+ 能匹配 zo 以及 zoo，但不能匹配 z。+ 等价于 {1,}。</td>
</tr>
<tr>
<td>?</td>
<td>匹配前面的子表达式零次或一次。例如，do(es)? 可以匹配 does 或 do。? 等价于 {0,1}。</td>
</tr>
<tr>
<td>{n}</td>
<td>n 是一个非负整数。匹配确定的n次。例如，o{2} 不能匹配 Bob 中的 o，但是能匹配 food 中的两个o。</td>
</tr>
<tr>
<td>{n,}</td>
<td>n 是一个非负整数。至少匹配n次。例如，o{2,} 不能匹配 Bob 中的 o，但能匹配 foooood 中的所有o。o{1,} 等价于 o+ 。o{0,} 则等价于 o*。</td>
</tr>
<tr>
<td>{n,m}</td>
<td>m和n均为非负整数，其中n&lt;&#x3D;m。最少匹配n次且最多匹配m次。例如，o{1,3} 将匹配 fooooood 中的前三个o。o{0,1} 等价于o?。 请注意在逗号和两个数之间不能有空格。</td>
</tr>
<tr>
<td>?</td>
<td>当该字符紧跟在任何一个其他限制符（*,+,?，{n}，{n,}，{n,m}）后面时，匹配模式是非贪婪的。非贪婪模式尽可能少的匹配所搜索的字符串，而默认的贪婪模式则尽可能多的匹配所搜索的字符串。例如，对于字符串oooo，o+? 将匹配单个 o，而 o+ 将匹配所有 o。</td>
</tr>
<tr>
<td>.</td>
<td>匹配除\n和\r之外的任何单个字符。要匹配包括\n和\r在内的任何字符，请使用像[\s\S]的模式。</td>
</tr>
<tr>
<td>(pattern)</td>
<td>匹配pattern并获取这一匹配。所获取的匹配可以从产生的 Matches 集合得到，在 VBScript 中使用 SMatches 集合，在JScript中则使用 0…0…0…9 属性。要匹配圆括号字符，请使用( 或 )。</td>
</tr>
<tr>
<td>(?:pattern)</td>
<td>匹配 pattern 但不获取匹配结果，也就是说这是一个非获取匹配，不进行存储供以后使用。这在使用或字符 “(</td>
</tr>
<tr>
<td>(?&#x3D;pattern)</td>
<td>非获取匹配，正向肯定预查，在任何匹配 pattern 的字符串开始处匹配查找字符串。这是一个非获取匹配，也就是说，该匹配不需要获取供以后使用。例如，”Windows(?&#x3D;95</td>
</tr>
<tr>
<td>(?!pattern)</td>
<td>非获取匹配，正向否定预查，在任何不匹配 pattern 的字符串开始处匹配查找字符串。这是一个非获取匹配，也就是说，该匹配不需要获取供以后使用。例如”Windows(?!95</td>
</tr>
<tr>
<td>(?&lt;&#x3D;pattern)</td>
<td>非获取匹配，反向肯定预查，与正向肯定预查类似，只是方向相反。例如，”(?&lt;&#x3D;95</td>
</tr>
<tr>
<td>(?&lt;!pattern)</td>
<td>非获取匹配，反向否定预查，与正向否定预查类似，只是方向相反。例如 “(?&lt;!95</td>
</tr>
<tr>
<td>x</td>
<td>y</td>
</tr>
<tr>
<td>[xyz]</td>
<td>字符集合。匹配所包含的任意一个字符。例如，[abc] 可以匹配 plain 中的 a。</td>
</tr>
<tr>
<td>[^xyz]</td>
<td>否定字符集合。匹配未包含的任意字符。例如，[^abc] 可以匹配 plain 中的 p。</td>
</tr>
<tr>
<td>[a-z]</td>
<td>字符范围。匹配指定范围内的任意字符。例如，[a-z] 可以匹配 a 到 z 范围内的任意小写字母字符。</td>
</tr>
<tr>
<td>[^a-z]</td>
<td>否定字符范围。匹配任何不在指定范围内的任意字符。例如，[^a-z] 可以匹配任何不在 a 到 z 范围内的任意字符。</td>
</tr>
<tr>
<td>\b</td>
<td>匹配一个单词边界，也就是指单词和空格间的位置。例如，er\b 可以匹配 never 中的 er ，但不能匹配 verb 中的 er。\b1_ 可以匹配1_23中的1_，但不能匹配21_3中的1_。</td>
</tr>
<tr>
<td>\B</td>
<td>匹配非单词边界。er\B 能匹配 verb 中的 er ，但不能匹配never 中的 er。</td>
</tr>
<tr>
<td>\cx</td>
<td>匹配由x指明的控制字符。例如，\cM 匹配一个Control-M 或 回车符。x 的值必须为A-Z或a-z之一。否则，将c视为一个原义的c字符。</td>
</tr>
<tr>
<td>\d</td>
<td>匹配一个数字字符。等价于 [0-9]。</td>
</tr>
<tr>
<td>\D</td>
<td>匹配一个非数字字符。等价于[^0-9]。</td>
</tr>
<tr>
<td>\f</td>
<td>匹配一个换页符。等价于\x0c和\cL。</td>
</tr>
<tr>
<td>\n</td>
<td>匹配一个换行符。等价于\x0a和\cJ。</td>
</tr>
<tr>
<td>\r</td>
<td>匹配一个回车符。等价于\x0d和\cM。</td>
</tr>
<tr>
<td>\t</td>
<td>匹配一个制表符。等价于\x09和\cI。</td>
</tr>
<tr>
<td>\v</td>
<td>匹配一个垂直制表符。等价于\x0b和\cK。</td>
</tr>
<tr>
<td>\s</td>
<td>匹配任何空白字符，包括空格、制表符、换页符等等。等价于[\f\n\r\t\v]。</td>
</tr>
<tr>
<td>\S</td>
<td>匹配任何非空白字符。等价于[^\f\n\r\t\v]。</td>
</tr>
<tr>
<td>\w</td>
<td>匹配包括下划线的任何单词字符。类似但不等价于[A-Za-z0-9_]，这里的单词字符使用Unicode字符集。</td>
</tr>
<tr>
<td>\W</td>
<td>匹配任何非单词字符。等价于[^A-Za-z0-9_]。</td>
</tr>
<tr>
<td>\xn</td>
<td>匹配n，其中n为十六进制转义值。十六进制转义值必须为确定的两个数字长。例如，\x41匹配A。\x041则等价于\x04&amp;1。正則表达式中可以使用ASCII编码。</td>
</tr>
<tr>
<td>\num</td>
<td>匹配num，其中num是一个正整数。对所获取的匹配的引用。例如，(.)\1匹配两个连续的相同字符。</td>
</tr>
<tr>
<td>\n</td>
<td>标识一个八进制转义值或一个向后引用。如果\n之前至少 n 个获取的子表达式，则 n 为向后引用。否则，如果 n 为八进制数字（0-7），则 n 为一个八进制转义值。</td>
</tr>
<tr>
<td>\nm</td>
<td>标识一个八进制转义值或一个向后引用。如果\nm之前至少有 nm 个获得子表达式，则 nm 为向后引用。如果\nm 之前至少有 n 个获取，则 n 为一个后跟文字m的向后引用。如果前面的条件都不满足，若n和m均为八进制数字（0-7），则\nm将匹配八进制转义值nm。</td>
</tr>
<tr>
<td>\nml</td>
<td>如果n为八进制数字（0-7），且m和l均为八进制数字（0-7），则匹配八进制转义值nml。</td>
</tr>
<tr>
<td>\un</td>
<td>匹配n，其中n是一个用四个十六进制数字表示的Unicode字符。例如，\u00A9 匹配版权符号（©）。</td>
</tr>
</tbody></table>
<h2 id="例子-1"><a href="#例子-1" class="headerlink" title="例子"></a>例子</h2><ol>
<li><p>判断是不是 IP 白名单:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#定义初始值</span></span><br><span class="line"><span class="built_in">set</span> $my_ip <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#判断是否为指定的白名单</span></span><br><span class="line"><span class="keyword">if</span> ( $http_x_forwarded_for ~* <span class="string">&quot;10.0.0.1|172.16.0.1&quot;</span> )&#123;</span><br><span class="line">    <span class="built_in">set</span> $my_ip <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#不是白名单的IP进行重定向跳转</span></span><br><span class="line"><span class="keyword">if</span> ( $my_ip = <span class="number">0</span> )&#123;</span><br><span class="line">    rewrite ^/$ /40x.html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果页面有多语言，但是这个多语言所在的文件找不到，那么就将多语言路径去掉，重新跳转</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    <span class="keyword">if</span> (!-e $request_filename) &#123;</span><br><span class="line">        rewrite ^/([A-Za-z0-9_-]+)/(.*) /$<span class="number">2</span> permanent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>比如你请求是这样子的 <a target="_blank" rel="noopener" href="https://foo.com/zh-cn/a.html">https://foo.com/zh-cn/a.html</a> 这时候服务端找不到这个文件，那么就会重定向到 <a target="_blank" rel="noopener" href="https://foo.com/a.html%E3%80%82">https://foo.com/a.html。</a> 这个很适合那种有多语言静态页面的站点</p>
</li>
<li><p>如果是一些特殊的静态文件，那么额外配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location ~* \.(gif|jpg|jpeg|png|css|js|ico)$ &#123;</span><br><span class="line">    root /webroot/res/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>针对国内的搜索爬虫，返回中文的页面</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> $chinaspider <span class="string">&quot;0&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> ($http_user_agent ~* <span class="string">&quot;Baiduspider|Sogou spider|Sogou web spider&quot;</span>) &#123;</span><br><span class="line">    <span class="built_in">set</span> $chinaspider <span class="string">&quot;1&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ($chinaspider = <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">301</span> https://$server_name/zh-cn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>禁止以&#x2F;data开头的文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location ~ ^/data &#123;</span><br><span class="line">  deny <span class="built_in">all</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>文件反盗链并设置过期时间</p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">location ~* ^.+\.(jpg|jpeg|gif|png|swf|rar|<span class="built_in">zip</span>|css|js)$ &#123;</span><br><span class="line">   valid_referers none blocked *.domain.com *.domain.net localhost <span class="number">208.97</span><span class="number">.167</span><span class="number">.194</span>;</span><br><span class="line">    <span class="keyword">if</span> ($invalid_referer) &#123;</span><br><span class="line">       rewrite ^/ http://error.domain.com/error.gif;</span><br><span class="line">       <span class="keyword">return</span> <span class="number">412</span>;</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    access_log  off;</span><br><span class="line">    root /opt/lampp/htdocs/web;</span><br><span class="line">    expires 3d;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>这里的 return 412 为自定义的 http 状态码，默认为403，方便找出正确的盗链的请求</p>
</li>
</ol>
<ul>
<li>rewrite ^&#x2F; <a target="_blank" rel="noopener" href="http://error.domain.com/error.gif;%E6%98%BE%E7%A4%BA%E4%B8%80%E5%BC%A0%E9%98%B2%E7%9B%97%E9%93%BE%E5%9B%BE%E7%89%87">http://error.domain.com/error.gif;显示一张防盗链图片</a></li>
<li>access_log off;不记录访问日志，减轻压力</li>
<li>expires 3d所有文件3天的浏览器缓存</li>
</ul>
<h2 id="最后附上可以用作判断的全局变量"><a href="#最后附上可以用作判断的全局变量" class="headerlink" title="最后附上可以用作判断的全局变量"></a>最后附上可以用作判断的全局变量</h2><table>
<thead>
<tr>
<th>全局变量</th>
<th>内容</th>
</tr>
</thead>
<tbody><tr>
<td>$remote_addr</td>
<td>获取客户端ip</td>
</tr>
<tr>
<td>$binary_remote_addr</td>
<td>客户端ip（二进制)</td>
</tr>
<tr>
<td>$remote_port</td>
<td>客户端port，如：50472</td>
</tr>
<tr>
<td>$remote_user</td>
<td>已经经过Auth Basic Module验证的用户名</td>
</tr>
<tr>
<td>$host</td>
<td>请求主机头字段，否则为服务器名称，如:blog.sakmon.com$request用户请求信息，如：GET ?a&#x3D;1&amp;b&#x3D;2 HTTP&#x2F;1.1</td>
</tr>
<tr>
<td>$request_filename</td>
<td>当前请求的文件的路径名，由root或alias和URI request组合而成，如：&#x2F;2013&#x2F;81.html</td>
</tr>
<tr>
<td>$status</td>
<td>请求的响应状态码,如:200</td>
</tr>
<tr>
<td>$body_bytes_sent</td>
<td>响应时送出的body字节数数量。即使连接中断，这个数据也是精确的,如：40</td>
</tr>
<tr>
<td>$content_length</td>
<td>等于请求行的Content_Length的值</td>
</tr>
<tr>
<td>$content_type</td>
<td>等于请求行的Content_Type的值</td>
</tr>
<tr>
<td>$http_referer</td>
<td>引用地址</td>
</tr>
<tr>
<td>$http_user_agent</td>
<td>客户端agent信息,如：Mozilla&#x2F;5.0 (Windows NT 5.1) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;29.0.1547.76 Safari&#x2F;537.36</td>
</tr>
<tr>
<td>$args</td>
<td>与 $query_string 相同 等于当中URL的参数(GET)，如a&#x3D;1&amp;b&#x3D;2</td>
</tr>
<tr>
<td>$document_uri</td>
<td>与$uri相同, 这个变量指当前的请求URI，不包括任何参数(见$args) 如:&#x2F;2013&#x2F;81.html</td>
</tr>
<tr>
<td>$document_root</td>
<td>针对当前请求的根路径设置值</td>
</tr>
<tr>
<td>$hostname</td>
<td>如：centos53.localdomain</td>
</tr>
<tr>
<td>$http_cookie</td>
<td>客户端cookie信息</td>
</tr>
<tr>
<td>$cookie_COOKIEcookie</td>
<td>COOKIE变量的值</td>
</tr>
<tr>
<td>$is_args</td>
<td>如果有$args参数，这个变量等于 ”?”，否则等于””</td>
</tr>
<tr>
<td>$limit_rate</td>
<td>这个变量可以限制连接速率，0 表示不限速</td>
</tr>
<tr>
<td>$query_string</td>
<td>与$args相同,等于当中URL的参数(GET)，如a&#x3D;1&amp;b&#x3D;2</td>
</tr>
<tr>
<td>$request_body</td>
<td>记录POST过来的数据信息</td>
</tr>
<tr>
<td>$request_body_file</td>
<td>客户端请求主体信息的临时文件名</td>
</tr>
<tr>
<td>$request_method</td>
<td>客户端请求的动作，通常为GET或POST,如：GET</td>
</tr>
<tr>
<td>$request_uri</td>
<td>包含请求参数的原始URI，不包含主机名，如：&#x2F;2013&#x2F;81.html?a&#x3D;1&amp;b&#x3D;2</td>
</tr>
<tr>
<td>$scheme</td>
<td>HTTP方法（如http，https）,如：http</td>
</tr>
<tr>
<td>$uri</td>
<td>这个变量指当前的请求URI，不包括任何参数(见$args) 如:&#x2F;2013&#x2F;81.html</td>
</tr>
<tr>
<td>$request_completion</td>
<td>如果请求结束，设置为OK。当请求未结束或如果该请求不是请求链串的最后一个时，为空(Empty)，如：OK</td>
</tr>
<tr>
<td>$server_protocol</td>
<td>请求使用的协议，通常是HTTP&#x2F;1.0或HTTP&#x2F;1.1，如：HTTP&#x2F;1.1</td>
</tr>
<tr>
<td>$server_addr</td>
<td>服务器IP地址，在完成一次系统调用后可以确定这个值</td>
</tr>
<tr>
<td>$server_name</td>
<td>服务器名称，如：blog.sakmon.com</td>
</tr>
<tr>
<td>$server_port</td>
<td>请求到达服务器的端口号,如：80</td>
</tr>
</tbody></table>
<h1 id="路由转发"><a href="#路由转发" class="headerlink" title="路由转发"></a>路由转发</h1><h1 id="Rewrite语法规则"><a href="#Rewrite语法规则" class="headerlink" title="Rewrite语法规则"></a>Rewrite语法规则</h1><p>rewrite功能就是，使用nginx提供的全局变量或自己设置的变量，结合正则表达式和标志位实现url重写以及重定向。rewrite只能放在server{},location{},if{}中，并且只能对域名后边的除去传递的参数外的字符串起作用，例如<a target="_blank" rel="noopener" href="http://seanlook.com/a/we/index.php?id=1&amp;u=str">http://seanlook.com/a/we/index.php?id=1&amp;u=str</a> 只对&#x2F;a&#x2F;we&#x2F;index.php重写。</p>
<p>如果想修改域名或参数字符串，可以使用全局变量匹配，也可以使用proxy_pass反向代理。</p>
<p>rewrite和location功能有点像，都能实现跳转，主要区别在于rewrite是在同一域名内更改获取资源的路径，而location是对一类路径做控制访问或反向代理，可以proxy_pass到其他机器。</p>
<p>rewrite语法：<code>rewrite 正则表达式 要替换的内容 [flag];</code></p>
<p>其中flag有如下几个值：</p>
<ol>
<li>last – 本条规则匹配完成后，立即发起新一轮的location 匹配规则</li>
<li>break – 本条规则匹配完成即终止，不再匹配后面的任何规则</li>
<li>redirect – 返回302临时重定向，浏览器地址会显示跳转新的URL地址</li>
<li>permanent – 返回301永久重定向。浏览器地址会显示跳转新的URL地址</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rewrite 后面没有任何 flag 时就顺序执行</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当 location 中没有 rewrite 模块指令可被执行时 就重写发起新一轮location匹配</span></span><br><span class="line">location / &#123;</span><br><span class="line">    # 顺序执行如下两条rewrite指令 </span><br><span class="line">    rewrite ^/test1 /test2;</span><br><span class="line">    rewrite ^/test2 /test3;  # 此处发起新一轮location匹配 uri为/test3</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location = /test2 &#123;</span><br><span class="line">    return 200 &quot;/test2&quot;;</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line">location = /test3 &#123;</span><br><span class="line">    return 200 &quot;/test3&quot;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">发送如下请求</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">curl 127.0.0.1:8080/test1</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/test3</span></span><br></pre></td></tr></table></figure>
<p><strong>很多情况下rewrite也会写在location里，它们的执行顺序是：</strong></p>
<ol>
<li>顺序执行server块中的rewrite模块指令，得到rewrite后的请求URI</li>
<li>执行location匹配 </li>
<li>执行选定的location中的rewrite指令 </li>
<li>如果其中某步URI被重写，则重新循环执行1-3，直到找到真实存在的文件；</li>
<li>循环超过10次，则返回500 Internal Server Error错误。</li>
</ol>
<h2 id="last-和-break的区别"><a href="#last-和-break的区别" class="headerlink" title="last 和 break的区别"></a>last 和 break的区别</h2><ol>
<li>last 和 break一样 它们都会终止此 location 中其他它rewrite模块指令的执行</li>
<li>但是 last 立即发起新一轮的 location 匹配 而 break 则不会</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    rewrite ^/test1 /test2;</span><br><span class="line">    rewrite ^/test2 /test3 last;  # 此处发起新一轮location匹配 uri为/test3</span><br><span class="line">    rewrite ^/test3 /test4;</span><br><span class="line">    proxy_pass http://www.baidu.com;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location = /test2 &#123;</span><br><span class="line">    return 200 &quot;/test2&quot;;</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line">location = /test3 &#123;</span><br><span class="line">    return 200 &quot;/test3&quot;;</span><br><span class="line">&#125;</span><br><span class="line">location = /test4 &#123;</span><br><span class="line">    return 200 &quot;/test4&quot;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">发送如下请求</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">curl 127.0.0.1:8080/test1</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/test3</span> </span><br><span class="line"></span><br><span class="line">当如果将上面的 location / 改成如下代码</span><br><span class="line">location / &#123;</span><br><span class="line">    rewrite ^/test1 /test2;</span><br><span class="line">    # 此处 不会 发起新一轮location匹配；会终止执行后续rewrite 重写后的uri为 /more/index.html</span><br><span class="line">    rewrite ^/test2 /more/index.html break;  </span><br><span class="line">    rewrite /more/index\.html /test4; # 这条指令会被忽略</span><br><span class="line"></span><br><span class="line">    # 因为 proxy_pass 不是rewrite模块的指令 所以它不会被 break终止</span><br><span class="line">    proxy_pass https://www.baidu.com;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">发送如下请求</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">浏览器输入 127.0.0.1:8080/test1</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">代理到 百度产品大全页面 https://www.baidu.com/more/index.html;</span></span><br></pre></td></tr></table></figure>

<h2 id="redirect-和-permanent"><a href="#redirect-和-permanent" class="headerlink" title="redirect 和 permanent"></a>redirect 和 permanent</h2><ol>
<li>临时重定向：对旧网址没有影响，但新网址不会有排名</li>
<li>永久重定向：新网址完全继承旧网址，旧网址的排名等完全清零</li>
</ol>
<p>修改nginx.conf文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">      listen 80 default;</span><br><span class="line">      charset utf-8;</span><br><span class="line">      server_name www.hzznb-xzll.xyz hzznb-xzll.xyz;</span><br><span class="line"></span><br><span class="line">      # 临时（redirect）重定向配置 当访问 hzznb-xzll.xyz/temp_redir/ 这个请求会临时（302）重定向到百度页面</span><br><span class="line">      location /temp_redir &#123;</span><br><span class="line">          rewrite ^/(.*) https://www.baidu.com redirect;</span><br><span class="line">      &#125;</span><br><span class="line">      # 永久重定向（permanent）配置 当访问 hzznb-xzll.xyz/forever_red… 这个请求会永久（301）重定向到百度页面</span><br><span class="line">      location /forever_redir &#123;</span><br><span class="line"></span><br><span class="line">          rewrite ^/(.*) https://www.baidu.com permanent;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      # rewrite last配置 可以看到我们定义 访问 hzznb-xzll.xyz/1/ 的请求被替换为 hzznb-xzll.xyz/2/ 之后再被替换为 hzznb-xzll.xyz/3/  最后找到/usr/local/nginx/test/static/location_last_test.html 这个文件并返回。</span><br><span class="line">      location /1 &#123;</span><br><span class="line">        rewrite /1/(.*) /2/$1 last;</span><br><span class="line">      &#125;</span><br><span class="line">      location /2 &#123;</span><br><span class="line">        rewrite /2/(.*) /3/$1 last;</span><br><span class="line">      &#125;</span><br><span class="line">      location /3 &#123;</span><br><span class="line">        alias  &#x27;/usr/local/nginx/test/static/&#x27;;</span><br><span class="line">        index location_last_test.html;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="rewrite-后的请求参数"><a href="#rewrite-后的请求参数" class="headerlink" title="rewrite 后的请求参数"></a>rewrite 后的请求参数</h2><p>如果替换字符串replacement包含新的请求参数，则在它们之后附加先前的请求参数。如果你不想要之前的参数，则在替换字符串 replacement 的末尾放置一个问号，避免附加它们。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">由于最后加了个 ?，原来的请求参数将不会被追加到rewrite之后的url后面</span> </span><br><span class="line">rewrite ^/users/(.*)$ /show?user=$1? last;</span><br></pre></td></tr></table></figure>

<h2 id="rewrite-log"><a href="#rewrite-log" class="headerlink" title="rewrite_log"></a>rewrite_log</h2><p>开启或者关闭 rewrite模块指令执行的日志，如果开启，则重写将记录下notice 等级的日志到nginx 的 error_log 中，默认为关闭 off</p>
<p><code>Syntax: rewrite_log on | off;</code></p>
<h2 id="return"><a href="#return" class="headerlink" title="return"></a>return</h2><p>格式：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">return code [text];</span><br><span class="line">return code URL;</span><br><span class="line">return URL;</span><br></pre></td></tr></table></figure>
<p>停止处理并将指定的code码返回给客户端。 非标准code码 444 关闭连接而不发送响应报头。</p>
<p>从0.8.42版本开始， return 语句可以指定重定向 url (状态码可以为如下几种 301,302,303,307),也可以为其他状态码指定响应的文本内容，并且重定向的url和响应的文本可以包含变量。</p>
<p>有一种特殊情况，就是重定向的url可以指定为此服务器本地的uri，这样的话，nginx会依据请求的协议$scheme， server_name_in_redirect 和 port_in_redirect自动生成完整的 url </p>
<p><strong>此处要说明的是server_name_in_redirect和port_in_redirect 指令是表示是否将server块中的 server_name 和 listen 的端口 作为redirect用 ）</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">return</span> code [text]; 返回 ok 给客户端</span></span><br><span class="line">location = /ok &#123;</span><br><span class="line">    return 200 &quot;ok&quot;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">return</span> code URL; 临时重定向到 百度</span></span><br><span class="line">location = /redirect &#123;</span><br><span class="line">    return 302 http://www.baidu.com;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">return</span> URL; 和上面一样 默认也是临时重定向</span></span><br><span class="line">location = /redirect &#123;</span><br><span class="line">    return http://www.baidu.com;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="break"><a href="#break" class="headerlink" title="break"></a>break</h2><p>停止执行 ngx_http_rewrite_module 的指令集，但是其他模块指令是不受影响的</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 8080;</span><br><span class="line">    # 此处 break 会停止执行 server 块的 return 指令(return 指令属于rewrite模块)</span><br><span class="line">    # 如果把它注释掉 则所有请求进来都返回 ok</span><br><span class="line">    break;</span><br><span class="line">    return 200 &quot;ok&quot;;</span><br><span class="line">    location = /testbreak &#123;</span><br><span class="line">        break;</span><br><span class="line">        return 200 $request_uri;</span><br><span class="line">        proxy_pass http://127.0.0.1:8080/other;</span><br><span class="line">    &#125;</span><br><span class="line">    location / &#123;</span><br><span class="line">        return 200 $request_uri;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">发送请求如下</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">curl 127.0.0.1:8080/testbreak</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/other</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可以看到 返回 `/other` 而不是 `/testbreak`，说明 `proxy_pass` 指令还是被执行了</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">也就是说 其他模块的指令是不会被 <span class="built_in">break</span> 中断执行的</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">(proxy_pass是ngx_http_proxy_module的指令)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://leetao50.github.io/2024/05/15/vue/%E7%BB%84%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="InfoPool">
      <meta itemprop="description" content="记录信息来源网络，内容只为方便查找，非公开信息，非请勿入">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | InfoPool">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/15/vue/%E7%BB%84%E4%BB%B6/" class="post-title-link" itemprop="url">组件</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-05-15 10:46:19" itemprop="dateCreated datePublished" datetime="2024-05-15T10:46:19+08:00">2024-05-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-17 17:16:12" itemprop="dateModified" datetime="2024-05-17T17:16:12+08:00">2024-05-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>一个 Vue 组件在使用前需要先被“注册”，这样 Vue 才能在渲染模板时找到其对应的实现。组件注册有两种方式：全局注册和局部注册。</p>
<h1 id="全局注册"><a href="#全局注册" class="headerlink" title="全局注册"></a>全局注册</h1><p>我们可以使用 Vue 应用实例的 .component() 方法，让组件在当前 Vue 应用中全局可用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(&#123;&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">component</span>(</span><br><span class="line">  <span class="comment">// 注册的名字</span></span><br><span class="line">  <span class="string">&#x27;MyComponent&#x27;</span>,</span><br><span class="line">  <span class="comment">// 组件的实现</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//---//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//如果使用单文件组件，你可以注册被导入的 .vue 文件：</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">MyComponent</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">component</span>(<span class="string">&#x27;MyComponent&#x27;</span>, <span class="title class_">MyComponent</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//.component() 方法可以被链式调用：</span></span><br><span class="line">app</span><br><span class="line">  .<span class="title function_">component</span>(<span class="string">&#x27;ComponentA&#x27;</span>, <span class="title class_">ComponentA</span>)</span><br><span class="line">  .<span class="title function_">component</span>(<span class="string">&#x27;ComponentB&#x27;</span>, <span class="title class_">ComponentB</span>)</span><br><span class="line">  .<span class="title function_">component</span>(<span class="string">&#x27;ComponentC&#x27;</span>, <span class="title class_">ComponentC</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//全局注册的组件可以在此应用的任意组件的模板中使用：</span></span><br><span class="line"><span class="comment">//&lt;!-- 这在当前应用的任意组件中都可用 --&gt;</span></span><br><span class="line">&lt;<span class="title class_">ComponentA</span>/&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">ComponentB</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">ComponentC</span>/&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>所有的子组件也可以使用全局注册的组件，这意味着这三个组件也都可以在彼此内部使用。</p>
<h1 id="局部注册"><a href="#局部注册" class="headerlink" title="局部注册"></a>局部注册</h1><p><strong>全局注册虽然很方便，但有以下几个问题：</strong></p>
<ul>
<li><p>全局注册，但并没有被使用的组件无法在生产打包时被自动移除 (也叫“tree-shaking”)。如果你全局注册了一个组件，即使它并没有被实际使用，它仍然会出现在打包后的 JS 文件中。</p>
</li>
<li><p>全局注册在大型项目中使项目的依赖关系变得不那么明确。在父组件中使用子组件时，不太容易定位子组件的实现。和使用过多的全局变量一样，这可能会影响应用长期的可维护性。</p>
</li>
</ul>
<p>相比之下，局部注册的组件需要在使用它的父组件中显式导入，并且只能在该父组件中使用。它的优点是使组件之间的依赖关系更加明确，并且对 tree-shaking 更加友好。</p>
<p>在使用 <script setup> 的单文件组件中，导入的组件可以直接在模板中使用，无需注册：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ComponentA</span> <span class="keyword">from</span> <span class="string">&#x27;./ComponentA.vue&#x27;</span></span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">ComponentA</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//如果没有使用 &lt;script setup&gt;，则需要使用 components 选项来显式注册：</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ComponentA</span> <span class="keyword">from</span> <span class="string">&#x27;./ComponentA.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">components</span>: &#123;</span><br><span class="line">    <span class="title class_">ComponentA</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>对于每个 components 对象里的属性，它们的 key 名就是注册的组件名，而值就是相应组件的实现。上面的例子中使用的是 ES2015 的缩写语法，等价于：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">components</span>: &#123;</span><br><span class="line">    <span class="title class_">ComponentA</span>: <span class="title class_">ComponentA</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="组件名格式"><a href="#组件名格式" class="headerlink" title="组件名格式"></a>组件名格式</h1><p>在整个指引中，我们都使用 PascalCase 作为组件名的注册格式，这是因为：</p>
<ul>
<li><p>PascalCase 是合法的 JavaScript 标识符。这使得在 JavaScript 中导入和注册组件都很容易，同时 IDE 也能提供较好的自动补全。</p>
</li>
<li><p><code>&lt;PascalCase /&gt; </code>在模板中更明显地表明了这是一个 Vue 组件，而不是原生 HTML 元素。同时也能够将 Vue 组件和自定义元素 (web components) 区分开来。</p>
</li>
</ul>
<p>在单文件组件和内联字符串模板中，我们都推荐这样做。但是，PascalCase 的标签名在 DOM 内模板中是不可用的，详情参见 DOM 内模板解析注意事项。</p>
<p>为了方便，Vue 支持将模板中使用 kebab-case 的标签解析为使用 PascalCase 注册的组件。这意味着一个以 MyComponent 为名注册的组件，在模板中可以通过 <code>&lt;MyComponent&gt; 或 &lt;my-component&gt;</code> 引用。这让我们能够使用同样的 JavaScript 组件注册代码来配合不同来源的模板。</p>
</script></p>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://leetao50.github.io/2024/05/09/Spring/RestTemplate/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="InfoPool">
      <meta itemprop="description" content="记录信息来源网络，内容只为方便查找，非公开信息，非请勿入">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | InfoPool">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/09/Spring/RestTemplate/" class="post-title-link" itemprop="url">RestTemplate</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-05-09 17:07:01" itemprop="dateCreated datePublished" datetime="2024-05-09T17:07:01+08:00">2024-05-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-11 10:51:17" itemprop="dateModified" datetime="2024-05-11T10:51:17+08:00">2024-05-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="RestTemplate-概述"><a href="#RestTemplate-概述" class="headerlink" title="RestTemplate 概述"></a>RestTemplate 概述</h1><p>Spring 框架提供的 RestTemplate 类可用于在应用中调用 rest 服务，它简化了与 http 服务的通信方式，统一了 RESTful 的标准，封装了 http 链接， 我们只需要传入 url 及返回值类型即可。相较于之前常用的 HttpClient，RestTemplate 是一种更优雅的调用 RESTful 服务的方式。</p>
<p>RestTemplate 默认依赖 JDK 提供 http 连接的能力（HttpURLConnection），如果有需要的话也可以通过 setRequestFactory 方法替换为 Apache HttpComponents、Netty 或 OkHttp 等其它 HTTP library。</p>
<p>考虑到 RestTemplate 类是为调用 REST 服务而设计的，因此它的主要方法与 REST 的基础紧密相连就不足为奇了，后者是 HTTP 协议的方法:HEAD、GET、POST、PUT、DELETE 和 OPTIONS。例如，RestTemplate 类具有 headForHeaders()、getForObject()、postForObject()、put()和 delete()等方法。</p>
<h1 id="发送-Get-请求"><a href="#发送-Get-请求" class="headerlink" title="发送 Get 请求"></a>发送 Get 请求</h1><p>接口代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/test/get&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> BookDto <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BookDto</span>(<span class="number">1</span>, <span class="string">&quot;SpringMVC系列&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 RestTemplate 调用上面这个接口，通常有 2 种写法，如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/chat16/test/get&quot;</span>;</span><br><span class="line">    <span class="comment">//getForObject方法，获取响应体，将其转换为第二个参数指定的类型</span></span><br><span class="line">    <span class="type">BookDto</span> <span class="variable">bookDto</span> <span class="operator">=</span> restTemplate.getForObject(url, BookDto.class);</span><br><span class="line">    System.out.println(bookDto);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/chat16/test/get&quot;</span>;</span><br><span class="line">    <span class="comment">//getForEntity方法，返回值为ResponseEntity类型</span></span><br><span class="line">    <span class="comment">// ResponseEntity中包含了响应结果中的所有信息，比如头、状态、body</span></span><br><span class="line">    ResponseEntity&lt;BookDto&gt; responseEntity = restTemplate.getForEntity(url, BookDto.class);</span><br><span class="line">    <span class="comment">//状态码</span></span><br><span class="line">    System.out.println(responseEntity.getStatusCode());</span><br><span class="line">    <span class="comment">//获取头</span></span><br><span class="line">    System.out.println(<span class="string">&quot;头：&quot;</span> + responseEntity.getHeaders());</span><br><span class="line">    <span class="comment">//获取body</span></span><br><span class="line">    <span class="type">BookDto</span> <span class="variable">bookDto</span> <span class="operator">=</span> responseEntity.getBody();</span><br><span class="line">    System.out.println(bookDto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="url-中含有动态参数"><a href="#url-中含有动态参数" class="headerlink" title="url 中含有动态参数"></a>url 中含有动态参数</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/test/get/&#123;id&#125;/&#123;name&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> BookDto <span class="title function_">get</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id, <span class="meta">@PathVariable(&quot;name&quot;)</span> String name)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BookDto</span>(id, name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 RestTemplate 调用上面这个接口，通常有 2 种写法，如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test3</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    <span class="comment">//url中有动态参数</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/chat16/test/get/&#123;id&#125;/&#123;name&#125;&quot;</span>;</span><br><span class="line">    Map&lt;String, String&gt; uriVariables = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    uriVariables.put(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">    uriVariables.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;SpringMVC系列&quot;</span>);</span><br><span class="line">    <span class="comment">//使用getForObject或者getForEntity方法</span></span><br><span class="line">    <span class="type">BookDto</span> <span class="variable">bookDto</span> <span class="operator">=</span> restTemplate.getForObject(url, BookDto.class, uriVariables);</span><br><span class="line">    System.out.println(bookDto);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test4</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    <span class="comment">//url中有动态参数</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/chat16/test/get/&#123;id&#125;/&#123;name&#125;&quot;</span>;</span><br><span class="line">    Map&lt;String, String&gt; uriVariables = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    uriVariables.put(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">    uriVariables.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;SpringMVC系列&quot;</span>);</span><br><span class="line">    <span class="comment">//getForEntity方法</span></span><br><span class="line">    ResponseEntity&lt;BookDto&gt; responseEntity = restTemplate.getForEntity(url, BookDto.class, uriVariables);</span><br><span class="line">    <span class="type">BookDto</span> <span class="variable">bookDto</span> <span class="operator">=</span> responseEntity.getBody();</span><br><span class="line">    System.out.println(bookDto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="接口返回值为泛型"><a href="#接口返回值为泛型" class="headerlink" title="接口返回值为泛型"></a>接口返回值为泛型</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/test/getList&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> List&lt;BookDto&gt; <span class="title function_">getList</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Arrays.asList(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">BookDto</span>(<span class="number">1</span>, <span class="string">&quot;Spring高手系列&quot;</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">BookDto</span>(<span class="number">2</span>, <span class="string">&quot;SpringMVC系列&quot;</span>)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当接口的返回值为泛型的时候，这种情况比较特殊，使用 RestTemplate 调用上面这个接口，代码如下，需要用到restTemplate.exchange的方法，这个方法中有个参数是ParameterizedTypeReference类型，通过这个参数类指定泛型类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test5</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    <span class="comment">//返回值为泛型</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/chat16/test/getList&quot;</span>;</span><br><span class="line">    <span class="comment">//若返回结果是泛型类型的，需要使用到exchange方法，</span></span><br><span class="line">    <span class="comment">//这个方法中有个参数是ParameterizedTypeReference类型，通过这个参数类指定泛型类型</span></span><br><span class="line">    ResponseEntity&lt;List&lt;BookDto&gt;&gt; responseEntity =</span><br><span class="line">            restTemplate.exchange(url,</span><br><span class="line">                    HttpMethod.GET,</span><br><span class="line">                    <span class="literal">null</span>,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">ParameterizedTypeReference</span>&lt;List&lt;BookDto&gt;&gt;() &#123;</span><br><span class="line">                    &#125;);</span><br><span class="line">    List&lt;BookDto&gt; bookDtoList = responseEntity.getBody();</span><br><span class="line">    System.out.println(bookDtoList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="下载小文件"><a href="#下载小文件" class="headerlink" title="下载小文件"></a>下载小文件</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/test/downFile&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> HttpEntity&lt;InputStreamResource&gt; <span class="title function_">downFile</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//将文件流封装为InputStreamResource对象</span></span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getResourceAsStream(<span class="string">&quot;/1.txt&quot;</span>);</span><br><span class="line">    <span class="type">InputStreamResource</span> <span class="variable">inputStreamResource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputStreamResource</span>(inputStream);</span><br><span class="line">    <span class="comment">//设置header</span></span><br><span class="line">    MultiValueMap&lt;String, String&gt; headers = <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">    headers.add(HttpHeaders.CONTENT_DISPOSITION, <span class="string">&quot;attachment;filename=1.txt&quot;</span>);</span><br><span class="line">    HttpEntity&lt;InputStreamResource&gt; httpEntity = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(inputStreamResource);</span><br><span class="line">    <span class="keyword">return</span> httpEntity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 RestTemplate 调用这个接口，代码如下，目前这个文件的内容比较少，可以直接得到一个数组。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test6</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/chat16/test/downFile&quot;</span>;</span><br><span class="line">    <span class="comment">//文件比较小的情况，直接返回字节数组</span></span><br><span class="line">    ResponseEntity&lt;<span class="type">byte</span>[]&gt; responseEntity = restTemplate.getForEntity(url, <span class="type">byte</span>[].class);</span><br><span class="line">    <span class="comment">//获取文件的内容</span></span><br><span class="line">    <span class="type">byte</span>[] body = responseEntity.getBody();</span><br><span class="line">    <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(body);</span><br><span class="line">    System.out.println(content);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="下载大文件"><a href="#下载大文件" class="headerlink" title="下载大文件"></a>下载大文件</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/test/downFile&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> HttpEntity&lt;InputStreamResource&gt; <span class="title function_">downFile</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//将文件流封装为InputStreamResource对象</span></span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getResourceAsStream(<span class="string">&quot;/1.txt&quot;</span>);</span><br><span class="line">    <span class="type">InputStreamResource</span> <span class="variable">inputStreamResource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputStreamResource</span>(inputStream);</span><br><span class="line">    <span class="comment">//设置header</span></span><br><span class="line">    MultiValueMap&lt;String, String&gt; headers = <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">    headers.add(HttpHeaders.CONTENT_DISPOSITION, <span class="string">&quot;attachment;filename=1.txt&quot;</span>);</span><br><span class="line">    HttpEntity&lt;InputStreamResource&gt; httpEntity = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(inputStreamResource);</span><br><span class="line">    <span class="keyword">return</span> httpEntity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时使用 RestTemplate 调用这个接口，代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test7</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/chat16/test/downFile&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件比较大的时候，比如好几个G，就不能返回字节数组了，会把内存撑爆，导致OOM</span></span><br><span class="line"><span class="comment">     * 需要这么玩：</span></span><br><span class="line"><span class="comment">     * 需要使用execute方法了，这个方法中有个ResponseExtractor类型的参数，</span></span><br><span class="line"><span class="comment">     * restTemplate拿到结果之后，会回调&#123;<span class="doctag">@link</span> ResponseExtractor#extractData&#125;这个方法，</span></span><br><span class="line"><span class="comment">     * 在这个方法中可以拿到响应流，然后进行处理，这个过程就是变读边处理，不会导致内存溢出</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> restTemplate.execute(url,</span><br><span class="line">            HttpMethod.GET,</span><br><span class="line">            <span class="literal">null</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ResponseExtractor</span>&lt;String&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> String <span class="title function_">extractData</span><span class="params">(ClientHttpResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;状态：&quot;</span>+response.getStatusCode());</span><br><span class="line">                    System.out.println(<span class="string">&quot;头：&quot;</span>+response.getHeaders());</span><br><span class="line">                    <span class="comment">//获取响应体流</span></span><br><span class="line">                    <span class="type">InputStream</span> <span class="variable">body</span> <span class="operator">=</span> response.getBody();</span><br><span class="line">                    <span class="comment">//处理响应体流</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> IOUtils.toString(body, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> content;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;());</span><br><span class="line"></span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="传递头"><a href="#传递头" class="headerlink" title="传递头"></a>传递头</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/test/header&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;String&gt;&gt; <span class="title function_">header</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    Map&lt;String, List&lt;String&gt;&gt; header = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">    Enumeration&lt;String&gt; headerNames = request.getHeaderNames();</span><br><span class="line">    <span class="keyword">while</span> (headerNames.hasMoreElements()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> headerNames.nextElement();</span><br><span class="line">        Enumeration&lt;String&gt; values = request.getHeaders(name);</span><br><span class="line">        List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">while</span> (values.hasMoreElements()) &#123;</span><br><span class="line">            list.add(values.nextElement());</span><br><span class="line">        &#125;</span><br><span class="line">        header.put(name, list);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> header;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 RestTemplate 调用接口，请求头中传递数据，代码如下，注意代码①和②，这两处是关键，用到了HttpHeaders和RequestEntity</p>
<ul>
<li>请求头放在 HttpHeaders 对象中</li>
<li>RequestEntity：请求实体，请求的所有信息都可以放在 RequestEntity 中，比如 body 部分、头、请求方式、url 等信息</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test8</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/chat16/test/header&quot;</span>;</span><br><span class="line">    <span class="comment">//①：请求头放在HttpHeaders对象中</span></span><br><span class="line">    MultiValueMap&lt;String, String&gt; headers = <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">    headers.add(<span class="string">&quot;header-1&quot;</span>, <span class="string">&quot;V1&quot;</span>);</span><br><span class="line">    headers.add(<span class="string">&quot;header-2&quot;</span>, <span class="string">&quot;Spring&quot;</span>);</span><br><span class="line">    headers.add(<span class="string">&quot;header-2&quot;</span>, <span class="string">&quot;SpringBoot&quot;</span>);</span><br><span class="line">    <span class="comment">//②：RequestEntity：请求实体，请求的所有信息都可以放在RequestEntity中，比如body部分、头、请求方式、url等信息</span></span><br><span class="line">    <span class="type">RequestEntity</span> <span class="variable">requestEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestEntity</span>(</span><br><span class="line">            <span class="literal">null</span>, <span class="comment">//body部分数据</span></span><br><span class="line">            headers, <span class="comment">//头</span></span><br><span class="line">            HttpMethod.GET,<span class="comment">//请求方法</span></span><br><span class="line">            URI.create(url) <span class="comment">//地址</span></span><br><span class="line">    );</span><br><span class="line">    ResponseEntity&lt;Map&lt;String, List&lt;String&gt;&gt;&gt; responseEntity = restTemplate.exchange(requestEntity,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ParameterizedTypeReference</span>&lt;Map&lt;String, List&lt;String&gt;&gt;&gt;() &#123;</span><br><span class="line">            &#125;);</span><br><span class="line">    Map&lt;String, List&lt;String&gt;&gt; result = responseEntity.getBody();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="综合案例：含头、url-动态参数"><a href="#综合案例：含头、url-动态参数" class="headerlink" title="综合案例：含头、url 动态参数"></a>综合案例：含头、url 动态参数</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/test/getAll/&#123;path1&#125;/&#123;path2&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getAll</span><span class="params">(<span class="meta">@PathVariable(&quot;path1&quot;)</span> String path1,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@PathVariable(&quot;path2&quot;)</span> String path2,</span></span><br><span class="line"><span class="params">                                  HttpServletRequest request)</span> &#123;</span><br><span class="line">    Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">    result.put(<span class="string">&quot;path1&quot;</span>, path1);</span><br><span class="line">    result.put(<span class="string">&quot;path2&quot;</span>, path2);</span><br><span class="line">    <span class="comment">//头</span></span><br><span class="line">    Map&lt;String, List&lt;String&gt;&gt; header = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">    Enumeration&lt;String&gt; headerNames = request.getHeaderNames();</span><br><span class="line">    <span class="keyword">while</span> (headerNames.hasMoreElements()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> headerNames.nextElement();</span><br><span class="line">        Enumeration&lt;String&gt; values = request.getHeaders(name);</span><br><span class="line">        List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">while</span> (values.hasMoreElements()) &#123;</span><br><span class="line">            list.add(values.nextElement());</span><br><span class="line">        &#125;</span><br><span class="line">        header.put(name, list);</span><br><span class="line">    &#125;</span><br><span class="line">    result.put(<span class="string">&quot;header&quot;</span>, header);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如下，使用 RestTemplate 调用接口，GET 方式、传递 header、path 中动态参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test9</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/chat16/test/getAll/&#123;path1&#125;/&#123;path2&#125;&quot;</span>;</span><br><span class="line">    <span class="comment">//①：请求头</span></span><br><span class="line">    MultiValueMap&lt;String, String&gt; headers = <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">    headers.add(<span class="string">&quot;header-1&quot;</span>, <span class="string">&quot;V1&quot;</span>);</span><br><span class="line">    headers.add(<span class="string">&quot;header-2&quot;</span>, <span class="string">&quot;Spring&quot;</span>);</span><br><span class="line">    headers.add(<span class="string">&quot;header-2&quot;</span>, <span class="string">&quot;SpringBoot&quot;</span>);</span><br><span class="line">    <span class="comment">//②：url中的2个参数</span></span><br><span class="line">    Map&lt;String, String&gt; uriVariables = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    uriVariables.put(<span class="string">&quot;path1&quot;</span>, <span class="string">&quot;v1&quot;</span>);</span><br><span class="line">    uriVariables.put(<span class="string">&quot;path2&quot;</span>, <span class="string">&quot;v2&quot;</span>);</span><br><span class="line">    <span class="comment">//③：HttpEntity：HTTP实体，内部包含了请求头和请求体</span></span><br><span class="line">    <span class="type">HttpEntity</span> <span class="variable">requestEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpEntity</span>(</span><br><span class="line">        <span class="literal">null</span>,<span class="comment">//body部分，get请求没有body，所以为null</span></span><br><span class="line">        headers <span class="comment">//头</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">//④：使用exchange发送请求</span></span><br><span class="line">    ResponseEntity&lt;Map&lt;String, Object&gt;&gt; responseEntity = restTemplate.exchange(</span><br><span class="line">        url, <span class="comment">//url</span></span><br><span class="line">        HttpMethod.GET, <span class="comment">//请求方式</span></span><br><span class="line">        requestEntity, <span class="comment">//请求实体（头、body）</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ParameterizedTypeReference</span>&lt;Map&lt;String, Object&gt;&gt;() &#123;</span><br><span class="line">        &#125;,<span class="comment">//返回的结果类型</span></span><br><span class="line">        uriVariables <span class="comment">//url中的占位符对应的值</span></span><br><span class="line">    );</span><br><span class="line">    Map&lt;String, Object&gt; result = responseEntity.getBody();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="POST-请求"><a href="#POST-请求" class="headerlink" title="POST 请求"></a>POST 请求</h1><p>http 请求头中的 Content-Type 用来指定请求的类型，常见的有 3 种</p>
<table>
<thead>
<tr>
<th>Content-Type</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>application&#x2F;x-www-form-urlencoded</td>
<td>页面中普通的 form 表单提交时就是这种类型，表单中的元素会按照名称和值拼接好，然后之间用&amp;连接，格式如：p1&#x3D;v1&amp;p2&#x3D;v2&amp;p3&#x3D;v3然后通过 urlencoded 编码之后丢在 body 中发送</td>
</tr>
<tr>
<td>multipart&#x2F;form-data</td>
<td>页面中表单上传文件的时候，用到的就是这种格式</td>
</tr>
<tr>
<td>application&#x2F;json</td>
<td>将发送的数据转换为 json 格式，丢在 http 请求的 body 中发送，后端接口通常用@RequestBody 配合对象来接收。</td>
</tr>
</tbody></table>
<h2 id="普通表单请求"><a href="#普通表单请求" class="headerlink" title="普通表单请求"></a>普通表单请求</h2><p>普通表单默认为 application&#x2F;x-www-form-urlencoded 类型的请求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/test/form1&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> BookDto <span class="title function_">form1</span><span class="params">(BookDto bookDto)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> bookDto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 RestTemplate 调用接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test10</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/chat16/test/form1&quot;</span>;</span><br><span class="line">    <span class="comment">//①：表单信息，需要放在MultiValueMap中，MultiValueMap相当于Map&lt;String,List&lt;String&gt;&gt;</span></span><br><span class="line">    MultiValueMap&lt;String, String&gt; body = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//调用add方法填充表单数据(表单名称:值)</span></span><br><span class="line">    body.add(<span class="string">&quot;id&quot;</span>,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    body.add(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;SpringMVC系列&quot;</span>);</span><br><span class="line">    <span class="comment">//②：发送请求(url,请求体，返回值需要转换的类型)</span></span><br><span class="line">    <span class="type">BookDto</span> <span class="variable">result</span> <span class="operator">=</span> restTemplate.postForObject(url, body, BookDto.class);</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果想携带头信息，代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test11</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/chat16/test/form1&quot;</span>;</span><br><span class="line">    <span class="comment">//①：表单信息，需要放在MultiValueMap中，MultiValueMap相当于Map&lt;String,List&lt;String&gt;&gt;</span></span><br><span class="line">    MultiValueMap&lt;String, String&gt; body = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//调用add方法放入表单元素(表单名称:值)</span></span><br><span class="line">    body.add(<span class="string">&quot;id&quot;</span>,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    body.add(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;SpringMVC系列&quot;</span>);</span><br><span class="line">    <span class="comment">//②：请求头</span></span><br><span class="line">    <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">    <span class="comment">//调用set方法放入请求头</span></span><br><span class="line">    headers.set(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_FORM_URLENCODED_VALUE);</span><br><span class="line">    <span class="comment">//③：请求实体：包含了请求体和请求头</span></span><br><span class="line">    HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt; httpEntity = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(body, headers);</span><br><span class="line">    <span class="comment">//④：发送请求(url,请求实体，返回值需要转换的类型)</span></span><br><span class="line">    <span class="type">BookDto</span> <span class="variable">result</span> <span class="operator">=</span> restTemplate.postForObject(url, httpEntity, BookDto.class);</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="上传本地文件"><a href="#上传本地文件" class="headerlink" title="上传本地文件"></a>上传本地文件</h2><p>上传文件 Content-Type 为 multipart&#x2F;form-data 类型。</p>
<p>接口如下，上传上传单个文件，返回值为一个 Map 类型，是泛型类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(value = &quot;/test/form2&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">form2</span><span class="params">(<span class="meta">@RequestParam(&quot;file1&quot;)</span> MultipartFile file1)</span> &#123;</span><br><span class="line">    Map&lt;String, String&gt; fileMetadata = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">    fileMetadata.put(<span class="string">&quot;文件名&quot;</span>, file1.getOriginalFilename());</span><br><span class="line">    fileMetadata.put(<span class="string">&quot;文件类型&quot;</span>, file1.getContentType());</span><br><span class="line">    fileMetadata.put(<span class="string">&quot;文件大小(byte)&quot;</span>, String.valueOf(file1.getSize()));</span><br><span class="line">    <span class="keyword">return</span> fileMetadata;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 RestTemplate 调用接口，主要下面代码②上传的文件需要包装为org.springframework.core.io.Resource，常用的有 3 中[FileSystemResource、InputStreamResource、ByteArrayResource]，这里案例中我们用到的是 FileSystemResource 来上传本地文件，另外 2 种（InputStreamResource、ByteArrayResource）用法就比较特殊了，见下个案例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test12</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/chat16/test/form2&quot;</span>;</span><br><span class="line">    <span class="comment">//①：表单信息，需要放在MultiValueMap中，MultiValueMap相当于Map&lt;String,List&lt;String&gt;&gt;</span></span><br><span class="line">    MultiValueMap&lt;String, Object&gt; body = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//调用add方法放入表单元素(表单名称:值)</span></span><br><span class="line">    <span class="comment">//②：文件对应的类型，需要是org.springframework.core.io.Resource类型的，常见的有[FileSystemResource、InputStreamResource、ByteArrayResource]</span></span><br><span class="line">    body.add(<span class="string">&quot;file1&quot;</span>, <span class="keyword">new</span> <span class="title class_">FileSystemResource</span>(<span class="string">&quot;.\\src\\main\\java\\com\\javacode2018\\springmvc\\chat16\\dto\\UserDto.java&quot;</span>));</span><br><span class="line">    <span class="comment">//③：头</span></span><br><span class="line">    <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">    headers.add(<span class="string">&quot;header1&quot;</span>, <span class="string">&quot;v1&quot;</span>);</span><br><span class="line">    headers.add(<span class="string">&quot;header2&quot;</span>, <span class="string">&quot;v2&quot;</span>);</span><br><span class="line">    <span class="comment">//④：请求实体</span></span><br><span class="line">    RequestEntity&lt;MultiValueMap&lt;String, Object&gt;&gt; requestEntity = <span class="keyword">new</span> <span class="title class_">RequestEntity</span>&lt;&gt;(body, headers, HttpMethod.POST, URI.create(url));</span><br><span class="line">    <span class="comment">//⑤：发送请求(请求实体，返回值需要转换的类型)</span></span><br><span class="line">    ResponseEntity&lt;Map&lt;String, String&gt;&gt; responseEntity = restTemplate.exchange(</span><br><span class="line">        requestEntity,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ParameterizedTypeReference</span>&lt;Map&lt;String, String&gt;&gt;() &#123;</span><br><span class="line">        &#125;);</span><br><span class="line">    Map&lt;String, String&gt; result = responseEntity.getBody();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="通过流或字节数组的方式上传文件"><a href="#通过流或字节数组的方式上传文件" class="headerlink" title="通过流或字节数组的方式上传文件"></a>通过流或字节数组的方式上传文件</h2><blockquote>
<p>有时候，上传的文件是通过流的方式或者字节数组的方式，那么就需要用到 InputStreamResource、ByteArrayResource 这俩了。<br><strong>注意：</strong>使用这俩的时候，需要重写 2 个方法，否则会上传失败</p>
</blockquote>
<ul>
<li>getFilename：文件名称</li>
<li>contentLength：长度</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test13</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/chat16/test/form2&quot;</span>;</span><br><span class="line">    <span class="comment">//①：表单信息，需要放在MultiValueMap中，MultiValueMap相当于Map&lt;String,List&lt;String&gt;&gt;</span></span><br><span class="line">    MultiValueMap&lt;String, Object&gt; body = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ②：通过流的方式上传文件，流的方式需要用到InputStreamResource类，需要重写2个方法</span></span><br><span class="line"><span class="comment">     * getFilename：文件名称</span></span><br><span class="line"><span class="comment">     * contentLength：长度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> RestTemplateTest.class.getResourceAsStream(<span class="string">&quot;/1.txt&quot;</span>);</span><br><span class="line">    <span class="type">InputStreamResource</span> <span class="variable">inputStreamResource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputStreamResource</span>(inputStream) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getFilename</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;1.txt&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">contentLength</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="keyword">return</span> inputStream.available();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    body.add(<span class="string">&quot;file1&quot;</span>, inputStreamResource);</span><br><span class="line">    <span class="comment">//③：头</span></span><br><span class="line">    <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">    headers.add(<span class="string">&quot;header1&quot;</span>, <span class="string">&quot;v1&quot;</span>);</span><br><span class="line">    headers.add(<span class="string">&quot;header2&quot;</span>, <span class="string">&quot;v2&quot;</span>);</span><br><span class="line">    <span class="comment">//④：请求实体</span></span><br><span class="line">    RequestEntity&lt;MultiValueMap&lt;String, Object&gt;&gt; requestEntity = <span class="keyword">new</span> <span class="title class_">RequestEntity</span>&lt;&gt;(body, headers, HttpMethod.POST, URI.create(url));</span><br><span class="line">    <span class="comment">//⑤：发送请求(请求实体，返回值需要转换的类型)</span></span><br><span class="line">    ResponseEntity&lt;Map&lt;String, String&gt;&gt; responseEntity = restTemplate.exchange(</span><br><span class="line">            requestEntity,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ParameterizedTypeReference</span>&lt;Map&lt;String, String&gt;&gt;() &#123;</span><br><span class="line">            &#125;);</span><br><span class="line">    Map&lt;String, String&gt; result = responseEntity.getBody();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="复杂表单：多个普通元素-多文件上传"><a href="#复杂表单：多个普通元素-多文件上传" class="headerlink" title="复杂表单：多个普通元素+多文件上传"></a>复杂表单：多个普通元素+多文件上传</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/test/form3&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">form3</span><span class="params">(UserDto userDto)</span> &#123;</span><br><span class="line">    Map&lt;String, String&gt; result = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">    result.put(<span class="string">&quot;name&quot;</span>, userDto.getName());</span><br><span class="line">    result.put(<span class="string">&quot;headImg&quot;</span>, userDto.getHeadImg().getOriginalFilename());</span><br><span class="line">    result.put(<span class="string">&quot;idImgList&quot;</span>, Arrays.toString(userDto.getIdImgList().stream().</span><br><span class="line">                                            map(MultipartFile::getOriginalFilename).toArray()));</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UserDto：包含了多个元素（姓名、头像、多张证件照），这种可以模拟复杂的表单</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDto</span> &#123;</span><br><span class="line">    <span class="comment">//姓名</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">//头像</span></span><br><span class="line">    <span class="keyword">private</span> MultipartFile headImg;</span><br><span class="line">    <span class="comment">//多张证件照</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;MultipartFile&gt; idImgList;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//get set 省略了...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test14</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/chat16/test/form3&quot;</span>;</span><br><span class="line">    <span class="comment">//①：表单信息，需要放在MultiValueMap中，MultiValueMap相当于Map&lt;String,List&lt;String&gt;&gt;</span></span><br><span class="line">    MultiValueMap&lt;String, Object&gt; body = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line">    body.add(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;路人&quot;</span>);</span><br><span class="line">    body.add(<span class="string">&quot;headImg&quot;</span>, <span class="keyword">new</span> <span class="title class_">FileSystemResource</span>(<span class="string">&quot;.\\src\\main\\resources\\1.jpg&quot;</span>));</span><br><span class="line">    <span class="comment">//来2张证件照，元素名称一样</span></span><br><span class="line">    body.add(<span class="string">&quot;idImgList&quot;</span>, <span class="keyword">new</span> <span class="title class_">FileSystemResource</span>(<span class="string">&quot;.\\src\\main\\resources\\2.jpg&quot;</span>));</span><br><span class="line">    body.add(<span class="string">&quot;idImgList&quot;</span>, <span class="keyword">new</span> <span class="title class_">FileSystemResource</span>(<span class="string">&quot;.\\src\\main\\resources\\3.jpg&quot;</span>));</span><br><span class="line">    <span class="comment">//③：头</span></span><br><span class="line">    <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">    headers.add(<span class="string">&quot;header1&quot;</span>, <span class="string">&quot;v1&quot;</span>);</span><br><span class="line">    headers.add(<span class="string">&quot;header2&quot;</span>, <span class="string">&quot;v2&quot;</span>);</span><br><span class="line">    <span class="comment">//④：请求实体</span></span><br><span class="line">    RequestEntity&lt;MultiValueMap&lt;String, Object&gt;&gt; requestEntity = <span class="keyword">new</span> <span class="title class_">RequestEntity</span>&lt;&gt;(body, headers, HttpMethod.POST, URI.create(url));</span><br><span class="line">    <span class="comment">//⑤：发送请求(请求实体，返回值需要转换的类型)</span></span><br><span class="line">    ResponseEntity&lt;Map&lt;String, String&gt;&gt; responseEntity = restTemplate.exchange(</span><br><span class="line">            requestEntity,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ParameterizedTypeReference</span>&lt;Map&lt;String, String&gt;&gt;() &#123;</span><br><span class="line">            &#125;);</span><br><span class="line">    Map&lt;String, String&gt; result = responseEntity.getBody();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="发送-json-格式数据：传递-java-对象"><a href="#发送-json-格式数据：传递-java-对象" class="headerlink" title="发送 json 格式数据：传递 java 对象"></a>发送 json 格式数据：传递 java 对象</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/test/form4&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> BookDto <span class="title function_">form4</span><span class="params">(<span class="meta">@RequestBody</span> BookDto bookDto)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> bookDto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test15</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/chat16/test/form4&quot;</span>;</span><br><span class="line">    <span class="type">BookDto</span> <span class="variable">body</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BookDto</span>(<span class="number">1</span>, <span class="string">&quot;SpringMVC系列&quot;</span>);</span><br><span class="line">    <span class="type">BookDto</span> <span class="variable">result</span> <span class="operator">=</span> restTemplate.postForObject(url, body, BookDto.class);</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="发送-json-格式数据：传递-java-对象，返回值为泛型"><a href="#发送-json-格式数据：传递-java-对象，返回值为泛型" class="headerlink" title="发送 json 格式数据：传递 java 对象，返回值为泛型"></a>发送 json 格式数据：传递 java 对象，返回值为泛型</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/test/form5&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> List&lt;BookDto&gt; <span class="title function_">form5</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;BookDto&gt; bookDtoList)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> bookDtoList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test16</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/chat16/test/form5&quot;</span>;</span><br><span class="line">    <span class="comment">//①：请求体，发送的时候会被转换为json格式数据</span></span><br><span class="line">    List&lt;BookDto&gt; body = Arrays.asList(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">BookDto</span>(<span class="number">1</span>, <span class="string">&quot;SpringMVC系列&quot;</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">BookDto</span>(<span class="number">2</span>, <span class="string">&quot;MySQL系列&quot;</span>));</span><br><span class="line">    <span class="comment">//②：头</span></span><br><span class="line">    <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">    headers.add(<span class="string">&quot;header1&quot;</span>, <span class="string">&quot;v1&quot;</span>);</span><br><span class="line">    headers.add(<span class="string">&quot;header2&quot;</span>, <span class="string">&quot;v2&quot;</span>);</span><br><span class="line">    <span class="comment">//③：请求实体</span></span><br><span class="line">    <span class="type">RequestEntity</span> <span class="variable">requestEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestEntity</span>(body, headers, HttpMethod.POST, URI.create(url));</span><br><span class="line">    <span class="comment">//④：发送请求(请求实体，返回值需要转换的类型)</span></span><br><span class="line">    ResponseEntity&lt;List&lt;BookDto&gt;&gt; responseEntity = restTemplate.exchange(</span><br><span class="line">            requestEntity,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ParameterizedTypeReference</span>&lt;List&lt;BookDto&gt;&gt;() &#123;</span><br><span class="line">            &#125;);</span><br><span class="line">    <span class="comment">//⑤：获取结果</span></span><br><span class="line">    List&lt;BookDto&gt; result = responseEntity.getBody();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="发送-json-字符串格式数据"><a href="#发送-json-字符串格式数据" class="headerlink" title="发送 json 字符串格式数据"></a>发送 json 字符串格式数据</h2><p>上面 2 个 json 案例 body 都是 java 对象，RestTemplate 默认自动配上 Content-Type&#x3D;application&#x2F;json</p>
<p>但是如果 body 的值是 json 格式字符串的时候，调用的时候需要在头中明确指定 Content-Type&#x3D;application&#x2F;json，写法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test17</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/chat16/test/form5&quot;</span>;</span><br><span class="line">    <span class="comment">//①：请求体为一个json格式的字符串</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">&quot;[&#123;\&quot;id\&quot;:1,\&quot;name\&quot;:\&quot;SpringMVC系列\&quot;&#125;,&#123;\&quot;id\&quot;:2,\&quot;name\&quot;:\&quot;MySQL系列\&quot;&#125;]&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ②：若请求体为json字符串的时候，需要在头中设置Content-Type=application/json；</span></span><br><span class="line"><span class="comment">     * 若body是普通的java类的时候，无需指定这个，RestTemplate默认自动配上Content-Type=application/json</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">    headers.setContentType(MediaType.APPLICATION_JSON);</span><br><span class="line">    <span class="comment">//③：请求实体（body，头、请求方式，uri）</span></span><br><span class="line">    <span class="type">RequestEntity</span> <span class="variable">requestEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestEntity</span>(body, headers, HttpMethod.POST, URI.create(url));</span><br><span class="line">    <span class="comment">//④：发送请求(请求实体，返回值需要转换的类型)</span></span><br><span class="line">    ResponseEntity&lt;List&lt;BookDto&gt;&gt; responseEntity = restTemplate.exchange(</span><br><span class="line">            requestEntity,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ParameterizedTypeReference</span>&lt;List&lt;BookDto&gt;&gt;() &#123;</span><br><span class="line">            &#125;);</span><br><span class="line">    <span class="comment">//⑤：获取结果</span></span><br><span class="line">    List&lt;BookDto&gt; result = responseEntity.getBody();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="DELETE、PUT、OPTION-请求"><a href="#DELETE、PUT、OPTION-请求" class="headerlink" title="DELETE、PUT、OPTION 请求"></a>DELETE、PUT、OPTION 请求</h1><h2 id="DELETE-请求"><a href="#DELETE-请求" class="headerlink" title="DELETE 请求"></a>DELETE 请求</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(String url, Object... uriVariables)</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(String url, Map&lt;String, ?&gt; uriVariables)</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(URI url)</span>;</span><br></pre></td></tr></table></figure>
<h2 id="PUT-请求"><a href="#PUT-请求" class="headerlink" title="PUT 请求"></a>PUT 请求</h2><p>PUT 请求和 POST 请求类似，将类型改为 PUT 就可以了。</p>
<h2 id="OPTIONS-请求"><a href="#OPTIONS-请求" class="headerlink" title="OPTIONS 请求"></a>OPTIONS 请求</h2><blockquote>
<p>OPTIONS 请求用来探测接口支持哪些 http 方法</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Set&lt;HttpMethod&gt; <span class="title function_">optionsForAllow</span><span class="params">(String url, Object... uriVariables)</span>;</span><br><span class="line"><span class="keyword">public</span> Set&lt;HttpMethod&gt; <span class="title function_">optionsForAllow</span><span class="params">(String url, Map&lt;String, ?&gt; uriVariables)</span>;</span><br><span class="line"><span class="keyword">public</span> Set&lt;HttpMethod&gt; <span class="title function_">optionsForAllow</span><span class="params">(URI url)</span>;</span><br></pre></td></tr></table></figure>

<h1 id="集成-HttpClient"><a href="#集成-HttpClient" class="headerlink" title="集成 HttpClient"></a>集成 HttpClient</h1><p>RestTemplate 内部默认用的是 jdk 自带的 HttpURLConnection 发送请求的，性能上面并不是太突出。<br>可以将其替换为 httpclient 或者 okhttp。<br>先来看下如何替换为 HttpClient。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.httpcomponents&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;httpclient&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.5.7&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> HttpClient <span class="title function_">httpClient</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">HttpClientBuilder</span> <span class="variable">httpClientBuilder</span> <span class="operator">=</span> HttpClientBuilder.create();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//设置信任ssl访问</span></span><br><span class="line">        <span class="type">SSLContext</span> <span class="variable">sslContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SSLContextBuilder</span>().loadTrustMaterial(<span class="literal">null</span>, (arg0, arg1) -&gt; <span class="literal">true</span>).build();</span><br><span class="line">        httpClientBuilder.setSSLContext(sslContext);</span><br><span class="line">        <span class="type">HostnameVerifier</span> <span class="variable">hostnameVerifier</span> <span class="operator">=</span> NoopHostnameVerifier.INSTANCE;</span><br><span class="line">        <span class="type">SSLConnectionSocketFactory</span> <span class="variable">sslConnectionSocketFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SSLConnectionSocketFactory</span>(sslContext, hostnameVerifier);</span><br><span class="line">        Registry&lt;ConnectionSocketFactory&gt; socketFactoryRegistry = RegistryBuilder.&lt;ConnectionSocketFactory&gt;create()</span><br><span class="line">                <span class="comment">// 注册http和https请求</span></span><br><span class="line">                .register(<span class="string">&quot;http&quot;</span>, PlainConnectionSocketFactory.getSocketFactory())</span><br><span class="line">                .register(<span class="string">&quot;https&quot;</span>, sslConnectionSocketFactory).build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用Httpclient连接池的方式配置(推荐)，同时支持netty，okHttp以及其他http框架</span></span><br><span class="line">        <span class="type">PoolingHttpClientConnectionManager</span> <span class="variable">poolingHttpClientConnectionManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PoolingHttpClientConnectionManager</span>(socketFactoryRegistry);</span><br><span class="line">        <span class="comment">// 最大连接数</span></span><br><span class="line">        poolingHttpClientConnectionManager.setMaxTotal(<span class="number">1000</span>);</span><br><span class="line">        <span class="comment">// 同路由并发数</span></span><br><span class="line">        poolingHttpClientConnectionManager.setDefaultMaxPerRoute(<span class="number">100</span>);</span><br><span class="line">        <span class="comment">//配置连接池</span></span><br><span class="line">        httpClientBuilder.setConnectionManager(poolingHttpClientConnectionManager);</span><br><span class="line">        <span class="comment">// 重试次数</span></span><br><span class="line">        httpClientBuilder.setRetryHandler(<span class="keyword">new</span> <span class="title class_">DefaultHttpRequestRetryHandler</span>(<span class="number">0</span>, <span class="literal">true</span>));</span><br><span class="line">        <span class="comment">//设置默认请求头</span></span><br><span class="line">        List&lt;Header&gt; headers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        httpClientBuilder.setDefaultHeaders(headers);</span><br><span class="line">        <span class="keyword">return</span> httpClientBuilder.build();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> ClientHttpRequestFactory <span class="title function_">clientHttpRequestFactory</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">HttpComponentsClientHttpRequestFactory</span> <span class="variable">clientHttpRequestFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpComponentsClientHttpRequestFactory</span>(httpClient());</span><br><span class="line">    <span class="comment">// 连接超时(毫秒)，这里设置10秒</span></span><br><span class="line">    clientHttpRequestFactory.setConnectTimeout(<span class="number">10</span> * <span class="number">1000</span>);</span><br><span class="line">    <span class="comment">// 数据读取超时时间(毫秒)，这里设置60秒</span></span><br><span class="line">    clientHttpRequestFactory.setReadTimeout(<span class="number">60</span> * <span class="number">1000</span>);</span><br><span class="line">    <span class="comment">// 从连接池获取请求连接的超时时间(毫秒)，不宜过长，必须设置，比如连接不够用时，时间过长将是灾难性的</span></span><br><span class="line">    clientHttpRequestFactory.setConnectionRequestTimeout(<span class="number">10</span> * <span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">return</span> clientHttpRequestFactory;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//创建RestTemplate的时候，指定ClientHttpRequestFactory</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>(<span class="built_in">this</span>.clientHttpRequestFactory());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test18</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="built_in">this</span>.restTemplate();</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/chat16/test/get&quot;</span>;</span><br><span class="line">    <span class="comment">//getForObject方法，获取响应体，将其转换为第二个参数指定的类型</span></span><br><span class="line">    <span class="type">BookDto</span> <span class="variable">bookDto</span> <span class="operator">=</span> restTemplate.getForObject(url, BookDto.class);</span><br><span class="line">    System.out.println(bookDto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="集成-okhttp"><a href="#集成-okhttp" class="headerlink" title="集成 okhttp"></a>集成 okhttp</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.squareup.okhttp3&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;okhttp&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.3.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>创建 RestTemplate</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">RestTemplate</span>(<span class="keyword">new</span> <span class="title class_">OkHttp3ClientHttpRequestFactory</span>());</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://leetao50.github.io/2024/05/07/Spring/EnableMethodSecurity%E6%B3%A8%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="InfoPool">
      <meta itemprop="description" content="记录信息来源网络，内容只为方便查找，非公开信息，非请勿入">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | InfoPool">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/07/Spring/EnableMethodSecurity%E6%B3%A8%E8%A7%A3/" class="post-title-link" itemprop="url">EnableMethodSecurity注解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-05-07 18:06:09" itemprop="dateCreated datePublished" datetime="2024-05-07T18:06:09+08:00">2024-05-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-23 12:13:43" itemprop="dateModified" datetime="2024-05-23T12:13:43+08:00">2024-05-23</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Spring Security支持方法级别的权限控制。我们可以在任意层的任意方法上加入权限注解，加入注解的方法将自动被Spring Security保护起来，仅仅允许特定的用户访问，从而还到权限控制的目的，当然如果现有的权限注解不满足我们也可以自定义。</p>
<p>Spring Security默认是禁用注解的，要想开启注解，要在继承WebSecurityConfigurerAdapter的类加@EnableMethodSecurity注解，并在该类中将AuthenticationManager定义为Bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(</span></span><br><span class="line"><span class="meta">  prePostEnabled = true, </span></span><br><span class="line"><span class="meta">  securedEnabled = true, </span></span><br><span class="line"><span class="meta">  jsr250Enabled = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到@EnableGlobalMethodSecurity 分别有prePostEnabled 、securedEnabled、jsr250Enabled三个字段，其中每个字段代码一种注解支持，默认为false，true为开启。那么我们就一一来说一下这三总注解支持。</p>
<ul>
<li><p>prePostEnabled &#x3D; true 的作用的是启用Spring Security的@PreAuthorize 以及@PostAuthorize 注解。</p>
</li>
<li><p>securedEnabled &#x3D; true 的作用是启用Spring Security的@Secured 注解。</p>
</li>
<li><p>jsr250Enabled &#x3D; true 的作用是启用@RoleAllowed 注解</p>
</li>
</ul>
<h1 id="在方法上设置权限认证"><a href="#在方法上设置权限认证" class="headerlink" title="在方法上设置权限认证"></a>在方法上设置权限认证</h1><h2 id="RolesAllowed"><a href="#RolesAllowed" class="headerlink" title="@RolesAllowed"></a>@RolesAllowed</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RolesAllowed(&quot;ROLE_VIEWER&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getUsername2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line">     </span><br><span class="line"><span class="meta">@RolesAllowed(&#123; &quot;USER&quot;, &quot;ADMIN&quot; &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isValidUsername2</span><span class="params">(String username)</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代表标注的方法只要具有USER, ADMIN任意一种权限就可以访问。这里可以省略前缀ROLE_，实际的权限可能是ROLE_ADMIN</p>
<p>在功能及使用方法上与 @Secured 完全相同</p>
<h2 id="securedEnabled注解"><a href="#securedEnabled注解" class="headerlink" title="securedEnabled注解"></a>securedEnabled注解</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Secured(&quot;ROLE_VIEWER&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">SecurityContext</span> <span class="variable">securityContext</span> <span class="operator">=</span> SecurityContextHolder.getContext();</span><br><span class="line">    <span class="keyword">return</span> securityContext.getAuthentication().getName();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Secured(&#123; &quot;ROLE_DBA&quot;, &quot;ROLE_ADMIN&quot; &#125;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getUsername2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@Secured 规定了访问访方法的角色列表，在列表中最少指定一种角色。@Secured在方法上指定安全性，要求 角色&#x2F;权限等 只有对应 角色&#x2F;权限 的用户才可以调用这些方法。</p>
<blockquote>
<p>还有一点就是@Secured,不支持Spring EL表达式</p>
</blockquote>
<h2 id="prePostEnabled注解"><a href="#prePostEnabled注解" class="headerlink" title="prePostEnabled注解"></a>prePostEnabled注解</h2><blockquote>
<p>这个开启后支持Spring EL表达式。如果没有访问方法的权限，会抛出AccessDeniedException。</p>
</blockquote>
<p>@PreAuthorize注解：<br>进入方法之前验证授权。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreAuthorize(&quot;hasRole(&#x27;ROLE_VIEWER&#x27;)&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getUsernameInUpperCase</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> getUsername().toUpperCase();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@PreAuthorize(“hasRole(‘ROLE_VIEWER’)”) 相当于@Secured(“ROLE_VIEWER”)。</p>
<p>同样的@Secured({“ROLE_VIEWER”,”ROLE_EDITOR”}) 也可以替换为：@PreAuthorize(“hasRole(‘ROLE_VIEWER’) or hasRole(‘ROLE_EDITOR’)”)。</p>
<p>在方法执行之前执行，这里可以调用方法的参数，也可以得到参数值，这里利用JAVA8的参数名反射特性，如果没有JAVA8，那么也可以利用Spring Secuirty的@P标注参数，或利用Spring Data的@Param标注参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//无java8</span></span><br><span class="line"><span class="meta">@PreAuthorize(&quot;#userId == authentication.principal.userId or hasAuthority(‘ADMIN’)&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">changePassword</span><span class="params">(<span class="meta">@P(&quot;userId&quot;)</span> <span class="type">long</span> userId )</span>&#123;&#125;</span><br><span class="line"><span class="comment">//有java8</span></span><br><span class="line"><span class="meta">@PreAuthorize(&quot;#userId == authentication.principal.userId or hasAuthority(‘ADMIN’)&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">changePassword</span><span class="params">(<span class="type">long</span> userId )</span>&#123;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里表示在changePassword方法执行之前，判断方法参数userId的值是否等于principal中保存的当前用户的userId，或者当前用户是否具有ROLE_ADMIN权限，两种符合其一，就可以访问该 方法。</p>
<p>@PostAuthorize注解：<br>在方法执行之后执行,以获取到方法的返回值，并且可以根据该方法来决定最终的授权结果（是允许访问还是不允许访问)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostAuthorize</span></span><br><span class="line">  (<span class="string">&quot;returnObject.username == authentication.principal.nickName&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> CustomUser <span class="title function_">loadUserDetail</span><span class="params">(String username)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> userRoleRepository.loadUserByUserName(username);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述代码中，仅当loadUserDetail方法的返回值中的username与当前登录用户的username相同时才被允许访问</p>
<blockquote>
<p>注意如果EL为false，那么该方法也已经执行完了，可能会回滚。EL变量returnObject表示返回的对象。</p>
</blockquote>
<p>@PreFilter注解：<br>在方法执行之前执行，而且这里可以调用方法的参数，然后对参数值进行过滤或处理或修改。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreFilter(&quot;filterObject != authentication.principal.username&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">joinUsernames</span><span class="params">(List&lt;String&gt; usernames)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> usernames.stream().collect(Collectors.joining(<span class="string">&quot;;&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当usernames中的子项与当前登录用户的用户名不同时，则保留；当usernames中的子项与当前登录用户的用户名相同时，则移除。比如当前使用用户的用户名为zhangsan，此时usernames的值为{“zhangsan”, “lisi”, “wangwu”}，则经@PreFilter过滤后，实际传入的usernames的值为{“lisi”, “wangwu”}</p>
<p>如果执行方法中包含有多个类型为Collection的参数，filterObject 就不太清楚是对哪个Collection参数进行过滤了。此时，便需要加入 filterTarget 属性来指定具体的参数名称：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreFilter(value = &quot;filterObject != authentication.principal.username&quot;,</span></span><br><span class="line"><span class="meta">  filterTarget = &quot;usernames&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">joinUsernamesAndRoles</span><span class="params">(List&lt;String&gt; usernames, List&lt;String&gt; roles)</span> &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> usernames.stream().collect(Collectors.joining(<span class="string">&quot;;&quot;</span>)) </span><br><span class="line">      + <span class="string">&quot;:&quot;</span> + roles.stream().collect(Collectors.joining(<span class="string">&quot;;&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@PostFilter：<br>在方法执行之后执行，而且这里可以调用方法的返回值，然后对返回值进行过滤或处理或修改并返回</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostFilter(&quot;filterObject != authentication.principal.username&quot;)</span></span><br><span class="line"><span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getAllUsernamesExceptCurrent</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> userRoleRepository.getAllUsernames();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时 filterObject 代表返回值。如果按照上述代码则实现了：移除掉返回值中与当前登录用户的用户名相同的子项。</p>
<h1 id="自定义元注解"><a href="#自定义元注解" class="headerlink" title="自定义元注解"></a>自定义元注解</h1><p>如果我们需要在多个方法中使用相同的安全注解，则可以通过创建元注解的方式来提升项目的可维护性。</p>
<p>比如创建以下元注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@PreAuthorize(&quot;hasRole(&#x27;ROLE_VIEWER&#x27;)&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> IsViewer &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后可以直接将该注解添加到对应的方法上：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@IsViewer</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getUsername4</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在生产项目中，由于元注解分离了业务逻辑与安全框架，所以使用元注解是一个非常不错的选择。</p>
<h1 id="类上使用安全注解"><a href="#类上使用安全注解" class="headerlink" title="类上使用安全注解"></a>类上使用安全注解</h1><p>如果一个类中的所有的方法我们全部都是应用的同一个安全注解，那么此时则应该把安全注解提升到类的级别上：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@PreAuthorize(&quot;hasRole(&#x27;ROLE_ADMIN&#x27;)&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SystemService</span> &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSystemYear</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSystemDate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码实现了：访问getSystemYear 以及getSystemDate 方法均需要ROLE_ADMIN权限。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>默认情况下，在方法中使用安全注解是由Spring AOP代理实现的，这意味着：如果我们在方法1中去调用同类中的使用安全注解的方法2，则方法2上的安全注解将失效。<br>Spring Security上下文是线程绑定的，这意味着：安全上下文将不会传递给子线程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isValidUsername4</span><span class="params">(String username)</span> &#123;</span><br><span class="line">    <span class="comment">// 以下的方法将会跳过安全认证</span></span><br><span class="line">    <span class="built_in">this</span>.getUsername();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://leetao50.github.io/2024/05/06/Spring/SpringSecurity-OAth2-JWT/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="InfoPool">
      <meta itemprop="description" content="记录信息来源网络，内容只为方便查找，非公开信息，非请勿入">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | InfoPool">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/06/Spring/SpringSecurity-OAth2-JWT/" class="post-title-link" itemprop="url">SpringSecurity+OAth2+JWT</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-05-06 16:00:17" itemprop="dateCreated datePublished" datetime="2024-05-06T16:00:17+08:00">2024-05-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-07 11:37:02" itemprop="dateModified" datetime="2024-05-07T11:37:02+08:00">2024-05-07</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>微服务中使用Spring Security + OAuth 2.0 + JWT 搭建认证授权服务</p>
<p>OAuth 是一种用来规范令牌（Token）发放的授权机制，主要包含了四种授权模式：</p>
<ol>
<li>授权码模式</li>
<li>简化模式</li>
<li>密码模式</li>
<li>客户端模式</li>
</ol>
<h1 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h1><p>spring-cloud-starter-oauth2 已经包含了 spring-cloud-starter-security、spring-security-oauth2、spring-security-jwt 这3个依赖，只需引入 spring-cloud-starter-oauth2 即可。</p>
<h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><ol>
<li>新建 UserDTO 类，实现 org.springframework.security.core.userdetails.UserDetails 接口</li>
</ol>
<p>nec-common:Account</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDTO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span>, UserDetails &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">5538522337801286424L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;SimpleGrantedAuthority&gt; authorities;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.authorities;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.userName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonLocked</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCredentialsNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>新建类 UserDetailsServiceImpl，实现 org.springframework.security.core.userdetails.UserDetailsService 接口，用于校验用户凭据。</li>
</ol>
<p>nec-auth:NecUserDetailService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDetailsServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPasswordEncoder</span><span class="params">(PasswordEncoder passwordEncoder)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.passwordEncoder = passwordEncoder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">        <span class="comment">// TODO 实际开发中，这里请修改从数据库中查询...</span></span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserDTO</span>();</span><br><span class="line">        user.setUserName(username);</span><br><span class="line">        <span class="comment">// 密码为 123456 ，且加密</span></span><br><span class="line">        user.setPassword(passwordEncoder.encode(<span class="string">&quot;123456&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="配置认证授权服务器"><a href="#配置认证授权服务器" class="headerlink" title="配置认证授权服务器"></a>配置认证授权服务器</h1><ol>
<li>新建类 Oauth2ServerConfig，继承 org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter 类；在 Oauth2ServerConfig 类上 添加注解 @EnableAuthorizationServer 。</li>
</ol>
<p>nec-auth:AuthorizationServer</p>
<p>框架提供了几个默认的端点：</p>
<ul>
<li>&#x2F;oauth&#x2F;authorize：授权端点</li>
<li>&#x2F;oauth&#x2F;token：获取令牌端点</li>
<li>&#x2F;oauth&#x2F;confirm_access：用户确认授权端点</li>
<li>&#x2F;oauth&#x2F;check_token：校验令牌端点</li>
<li>&#x2F;oauth&#x2F;error：用于在授权服务器中呈现错误</li>
<li>&#x2F;oauth&#x2F;token_key：获取 jwt 公钥端点</li>
</ul>
<ol start="2">
<li>继承 AuthorizationServerConfigurerAdapter 类后，我们需要重写以下三个方法扩展实现我们的需求。</li>
</ol>
<ul>
<li>configure(ClientDetailsServiceConfigurer clients) ：用于定义、初始化客户端信息</li>
<li>configure(AuthorizationServerEndpointsConfigurer endpoints)：用于定义授权令牌端点及服务</li>
<li>configure(AuthorizationServerSecurityConfigurer security)：用于定义令牌端点的安全约束</li>
</ul>
<h2 id="配置客户端详细信息-ClientDetailsServiceConfigurer"><a href="#配置客户端详细信息-ClientDetailsServiceConfigurer" class="headerlink" title="配置客户端详细信息 ClientDetailsServiceConfigurer"></a>配置客户端详细信息 ClientDetailsServiceConfigurer</h2><p>用于定义 内存 中或 基于JDBC存储实现 的客户端，其重要的几个属性有：</p>
<ol>
<li>clientId：客户端id，必填；</li>
<li>clientSecret：客户端密钥；</li>
<li>authorizedGrantTypes：客户端授权类型，有 5 种模式： authorization_code、password、client_credentials、implicit、refresh_token；</li>
<li>scope：授权范围；</li>
<li>accessTokenValiditySeconds：access_token 有效时间，单位为秒，默认为 12 小时；</li>
<li>refreshTokenValiditySeconds：refresh_token 有效时间，单位为秒，默认为 30 天；</li>
</ol>
<p>客户端信息一般保存在 Redis 或 数据库中</p>
<ol>
<li><p>使用以下 SQL（适用于MySQL） 来建表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `oauth_client_details`  (</span><br><span class="line">  `client_id` <span class="type">varchar</span>(<span class="number">256</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `resource_ids` <span class="type">varchar</span>(<span class="number">256</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `client_secret` <span class="type">varchar</span>(<span class="number">256</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `<span class="keyword">scope</span>` <span class="type">varchar</span>(<span class="number">256</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `authorized_grant_types` <span class="type">varchar</span>(<span class="number">256</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `web_server_redirect_uri` <span class="type">varchar</span>(<span class="number">256</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `authorities` <span class="type">varchar</span>(<span class="number">256</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `access_token_validity` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `refresh_token_validity` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `additional_information` <span class="type">varchar</span>(<span class="number">4096</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `autoapprove` <span class="type">varchar</span>(<span class="number">256</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`client_id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加一条客户端信息用于测试：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `oauth_client_details` <span class="keyword">VALUES</span> (<span class="string">&#x27;auth-server&#x27;</span>, <span class="keyword">NULL</span>, <span class="string">&#x27;$2a$10$mcEwJ8qqhk2DYIle6VfhEOZHRdDbCSizAQbIwBR7tTuv9Q7Fca9Gi&#x27;</span>, <span class="string">&#x27;all&#x27;</span>, <span class="string">&#x27;password,refresh_token&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="keyword">NULL</span>, <span class="keyword">NULL</span>, <span class="keyword">NULL</span>, <span class="keyword">NULL</span>, <span class="keyword">NULL</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>其中密码 123456 使用 BCryptPasswordEncoder 加密，加密后字符为 $2a$10$mcEwJ8qqhk2DYIle6VfhEOZHRdDbCSizAQbIwBR7tTuv9Q7Fca9Gi。</p>
</li>
<li><p>配置 ClientDetailsServiceConfigurer ，指定客户端信息：</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Oauth2ServerConfig</span> <span class="keyword">extends</span> <span class="title class_">AuthorizationServerConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataSource dataSource;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Oauth2ServerConfig</span><span class="params">(DataSource dataSource, PasswordEncoder passwordEncoder)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.dataSource = dataSource;</span><br><span class="line">        <span class="built_in">this</span>.passwordEncoder = passwordEncoder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 使用基于 JDBC 存储模式</span></span><br><span class="line">        <span class="type">JdbcClientDetailsService</span> <span class="variable">clientDetailsService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcClientDetailsService</span>(dataSource);</span><br><span class="line">        <span class="comment">// client_secret 加密</span></span><br><span class="line">        clientDetailsService.setPasswordEncoder(passwordEncoder);</span><br><span class="line">        clients.withClientDetails(clientDetailsService);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="配置授权令牌端点及服务-AuthorizationServerEndpointsConfigurer"><a href="#配置授权令牌端点及服务-AuthorizationServerEndpointsConfigurer" class="headerlink" title="配置授权令牌端点及服务 AuthorizationServerEndpointsConfigurer"></a>配置授权令牌端点及服务 AuthorizationServerEndpointsConfigurer</h2><p>需要指定 AuthenticationManager 及 UserDetailService，尤其是使用密码模式时，必须指定 AuthenticationManager，否则会报 Unsupported grant type: password 错误。</p>
<p>新建 WebSecurityConfig 类，继承 org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter 类，重写 authenticationManagerBean() 方法，并定义需要用到的 PasswordEncoder；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">                <span class="comment">// 支持跨域请求</span></span><br><span class="line">                .cors()</span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line">                <span class="comment">// 禁用 CSRF</span></span><br><span class="line">                .csrf().disable()</span><br><span class="line"></span><br><span class="line">                .formLogin().disable()</span><br><span class="line">                .httpBasic().disable()</span><br><span class="line">                .logout().disable()</span><br><span class="line"></span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/oauth/token&quot;</span>).permitAll();</span><br><span class="line"></span><br><span class="line">                .anyRequest().authenticated();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 重写 authenticationManagerBean()</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置 AuthorizationServerEndpointsConfigurer：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Oauth2ServerConfig</span> <span class="keyword">extends</span> <span class="title class_">AuthorizationServerConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserDetailsServiceImpl userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密码模式 grant_type:password 需指定 AuthenticationManager</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Oauth2ServerConfig</span><span class="params">(UserDetailsServiceImpl userDetailsService,</span></span><br><span class="line"><span class="params">                              AuthenticationManager authenticationManager)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userDetailsService = userDetailsService;</span><br><span class="line">        <span class="built_in">this</span>.authenticationManager = authenticationManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        endpoints</span><br><span class="line">                <span class="comment">// 开启密码模式授权</span></span><br><span class="line">                .authenticationManager(authenticationManager)</span><br><span class="line">                .userDetailsService(userDetailsService);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 JWT 作为令牌格式<br>生成 JWT 密钥对<br>使用 JDK 的 keytool 工具生成 JKS 密钥对 jwt.jks，并将 jwt.jks 放到 resources 目录下。</p>
<p>定位至 JDK 目录下的 bin 目录，执行以下命令生成密钥对，记住口令密钥，代码中需要用到密钥来读取密钥对，以下命令以 123456 为例：</p>
<p>keytool -genkey -alias weihong -keyalg RSA -keypass 123456 -keystore jwt.jks -storepass 123456</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-genkey 生成密钥</span><br><span class="line"></span><br><span class="line">-alias 别名</span><br><span class="line"></span><br><span class="line">-keyalg 密钥算法</span><br><span class="line"></span><br><span class="line">-keypass 密钥口令</span><br><span class="line"></span><br><span class="line">-keystore 生成密钥对的存储路径和名称</span><br><span class="line"></span><br><span class="line">-storepass 密钥对口令</span><br></pre></td></tr></table></figure>
<p>定义 token 转换器<br>在 Oauth2ServerConfig 类中定义 accessTokenConverter() 及 keyPair()：<br>指定令牌存储策略为 JWT<br>配置 AuthorizationServerEndpointsConfigurer 的令牌存储策略为 JWT，指定 accessTokenConverter 为我们定义好的 accessTokenConverter()：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Oauth2ServerConfig</span> <span class="keyword">extends</span> <span class="title class_">AuthorizationServerConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserDetailsServiceImpl userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密码模式 grant_type:password 需指定 AuthenticationManager</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Oauth2ServerConfig</span><span class="params">(UserDetailsServiceImpl userDetailsService,</span></span><br><span class="line"><span class="params">                              AuthenticationManager authenticationManager)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userDetailsService = userDetailsService;</span><br><span class="line">        <span class="built_in">this</span>.authenticationManager = authenticationManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> &#123;</span><br><span class="line">        endpoints</span><br><span class="line">                <span class="comment">// 开启密码模式授权</span></span><br><span class="line">                .authenticationManager(authenticationManager)</span><br><span class="line">                .userDetailsService(userDetailsService)</span><br><span class="line">                <span class="comment">// 指定令牌存储策略</span></span><br><span class="line">                .accessTokenConverter(accessTokenConverter());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * token 转换器</span></span><br><span class="line"><span class="comment">     * 默认是 uuid 格式，我们在这里指定 token 格式为 jwt</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JwtAccessTokenConverter <span class="title function_">accessTokenConverter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">JwtAccessTokenConverter</span> <span class="variable">converter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JwtAccessTokenConverter</span>();</span><br><span class="line">        <span class="comment">// 使用非对称加密算法对 token 签名</span></span><br><span class="line">        converter.setKeyPair(keyPair());</span><br><span class="line">        <span class="keyword">return</span> converter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> KeyPair <span class="title function_">keyPair</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 从 classpath 目录下的证书 jwt.jks 中获取秘钥对</span></span><br><span class="line">        <span class="type">KeyStoreKeyFactory</span> <span class="variable">keyStoreKeyFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">KeyStoreKeyFactory</span>(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;jwt.jks&quot;</span>), <span class="string">&quot;123456&quot;</span>.toCharArray());</span><br><span class="line">        <span class="keyword">return</span> keyStoreKeyFactory.getKeyPair(<span class="string">&quot;weihong&quot;</span>, <span class="string">&quot;123456&quot;</span>.toCharArray());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>

<p>扩展 JWT 存储内容</p>
<p>有时候我们需要扩展 JWT 存储的内容，比如存储一些用户数据、权限信息等。我们可以定义 TokenEnhancer 或继承 TokenEnhancer 来实现 JWT 内容增强器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Oauth2ServerConfig</span> <span class="keyword">extends</span> <span class="title class_">AuthorizationServerConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserDetailsServiceImpl userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Oauth2ServerConfig</span><span class="params">(UserDetailsServiceImpl userDetailsService,</span></span><br><span class="line"><span class="params">                              AuthenticationManager authenticationManager)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userDetailsService = userDetailsService;</span><br><span class="line">        <span class="built_in">this</span>.authenticationManager = authenticationManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TokenEnhancerChain</span> <span class="variable">enhancerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TokenEnhancerChain</span>();</span><br><span class="line">        List&lt;TokenEnhancer&gt; delegates = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        delegates.add(tokenEnhancer());</span><br><span class="line">        delegates.add(accessTokenConverter());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 配置 JWT 内容增强</span></span><br><span class="line">        enhancerChain.setTokenEnhancers(delegates);</span><br><span class="line"></span><br><span class="line">        endpoints</span><br><span class="line">                <span class="comment">// 开启密码模式授权</span></span><br><span class="line">                .authenticationManager(authenticationManager)</span><br><span class="line">                .userDetailsService(userDetailsService)</span><br><span class="line">                .accessTokenConverter(accessTokenConverter())</span><br><span class="line">                .tokenEnhancer(enhancerChain);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * token 转换器</span></span><br><span class="line"><span class="comment">     * 默认是 uuid 格式，我们在这里指定 token 格式为 jwt</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JwtAccessTokenConverter <span class="title function_">accessTokenConverter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">JwtAccessTokenConverter</span> <span class="variable">converter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JwtAccessTokenConverter</span>();</span><br><span class="line">        <span class="comment">// 使用非对称加密算法对 token 签名</span></span><br><span class="line">        converter.setKeyPair(keyPair());</span><br><span class="line">        <span class="keyword">return</span> converter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> KeyPair <span class="title function_">keyPair</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">KeyStoreKeyFactory</span> <span class="variable">keyStoreKeyFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">KeyStoreKeyFactory</span>(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;jwt.jks&quot;</span>), <span class="string">&quot;123456&quot;</span>.toCharArray());</span><br><span class="line">        <span class="keyword">return</span> keyStoreKeyFactory.getKeyPair(<span class="string">&quot;weihong&quot;</span>, <span class="string">&quot;123456&quot;</span>.toCharArray());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * JWT 内容增强器，用于扩展 JWT 内容，可以保存用户数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TokenEnhancer <span class="title function_">tokenEnhancer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (oAuth2AccessToken, oAuth2Authentication) -&gt; &#123;</span><br><span class="line">            Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">            <span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> (UserDTO) oAuth2Authentication.getPrincipal();</span><br><span class="line">            map.put(<span class="string">&quot;userName&quot;</span>, userDTO.getUsername());</span><br><span class="line">            <span class="comment">// TODO 其他信息可以自行添加</span></span><br><span class="line">            ((DefaultOAuth2AccessToken) oAuth2AccessToken).setAdditionalInformation(map);</span><br><span class="line">            <span class="keyword">return</span> oAuth2AccessToken;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 Redis 存储 token</p>
<p>添加 token 保存至 redis 的配置:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisTokenStoreConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisConnectionFactory connectionFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TokenStore <span class="title function_">redisTokenStore</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RedisTokenStore</span>(connectionFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在认证服务配置中指定 token 存储方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Oauth2ServerConfig</span> <span class="keyword">extends</span> <span class="title class_">AuthorizationServerConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserDetailsServiceImpl userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密码模式 grant_type:password 需指定 AuthenticationManager</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthenticationManager authenticationManager;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TokenStore tokenStore;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Oauth2ServerConfig</span><span class="params">(UserDetailsServiceImpl userDetailsService,</span></span><br><span class="line"><span class="params">                              AuthenticationManager authenticationManager,</span></span><br><span class="line"><span class="params">                              <span class="meta">@Qualifier(&quot;redisTokenStore&quot;)</span> TokenStore tokenStore)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userDetailsService = userDetailsService;</span><br><span class="line">        <span class="built_in">this</span>.authenticationManager = authenticationManager;</span><br><span class="line">        <span class="built_in">this</span>.tokenStore = tokenStore;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        endpoints</span><br><span class="line">                <span class="comment">// 开启密码模式授权</span></span><br><span class="line">                .authenticationManager(authenticationManager)</span><br><span class="line">                .userDetailsService(userDetailsService)</span><br><span class="line">                <span class="comment">// 设置 token 存储方式</span></span><br><span class="line">                .tokenStore(tokenStore);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="配置授权令牌安全约束-AuthorizationServerSecurityConfigurer"><a href="#配置授权令牌安全约束-AuthorizationServerSecurityConfigurer" class="headerlink" title="配置授权令牌安全约束 AuthorizationServerSecurityConfigurer"></a>配置授权令牌安全约束 AuthorizationServerSecurityConfigurer</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerSecurityConfigurer security)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        security</span><br><span class="line">                <span class="comment">// 允许表单认证</span></span><br><span class="line">                .allowFormAuthenticationForClients()</span><br><span class="line">                <span class="comment">// 开放 /oauth/token_key 获取 token 加密公钥</span></span><br><span class="line">                .tokenKeyAccess(<span class="string">&quot;permitAll()&quot;</span>)</span><br><span class="line">                <span class="comment">// 开放 /oauth/check_token</span></span><br><span class="line">                .checkTokenAccess(<span class="string">&quot;permitAll()&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://leetao50.github.io/2024/05/06/lombok/Lombok%E6%B3%A8%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="InfoPool">
      <meta itemprop="description" content="记录信息来源网络，内容只为方便查找，非公开信息，非请勿入">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | InfoPool">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/06/lombok/Lombok%E6%B3%A8%E8%A7%A3/" class="post-title-link" itemprop="url">Lombok注解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-05-06 11:20:13 / 修改时间：12:02:55" itemprop="dateCreated datePublished" datetime="2024-05-06T11:20:13+08:00">2024-05-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="AllArgsConstructor"><a href="#AllArgsConstructor" class="headerlink" title="@AllArgsConstructor"></a>@AllArgsConstructor</h1><p>生成包含所有字段的构造器，标记为的字段@NonNull将对这些参数进行空检查。</p>
<h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><ol>
<li>staticName : 不为空的话，生成一个静态方法返回实例，并把构造器设置为private</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor(staticName = &quot;create&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Example</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> foo;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String bar;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>生成：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Example</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> foo;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String bar;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Example</span><span class="params">(<span class="type">int</span> foo, String bar)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.foo = foo;</span><br><span class="line">        <span class="built_in">this</span>.bar = bar;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Example <span class="title function_">create</span><span class="params">(<span class="type">int</span> foo, String bar)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Example</span>(foo, bar);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>access : 这个选项可以用来改变生成的构造方法的访问级别，默认public</li>
</ol>
<h1 id="RequiredArgsConstructor"><a href="#RequiredArgsConstructor" class="headerlink" title="@RequiredArgsConstructor"></a>@RequiredArgsConstructor</h1><p>生成必须初始化字段的构造器，比如带final、@NonNull，对于标有@NonNull注解的字段，还将生成一个显式的null检查。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Example</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="keyword">private</span> Integer foo;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String bar;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Example</span> &#123;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="keyword">private</span> Integer foo;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String bar;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Example</span><span class="params">(<span class="meta">@NonNull</span> Integer foo, String bar)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (foo == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;foo is marked @NonNull but is null&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.foo = foo;</span><br><span class="line">            <span class="built_in">this</span>.bar = bar;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="NoArgsConstructor"><a href="#NoArgsConstructor" class="headerlink" title="@NoArgsConstructor"></a>@NoArgsConstructor</h1><p>生成无参数构造器</p>
<h2 id="参数-1"><a href="#参数-1" class="headerlink" title="参数"></a>参数</h2><ol>
<li>access：访问权限修饰符</li>
<li>force：为true时，当有 final 字段没有被初始化时，这个选项可以强制 Lombok 生成一个无参数的构造方法，并将所有 final 字段初始化为其默认值（0、false、null等）</li>
<li>onConstructor：添加注解，参考@Getter#onMethod</li>
</ol>
<h1 id="NoArgsConstructor、-AllArgsConstructor和-RequiredArgsConstructor区别"><a href="#NoArgsConstructor、-AllArgsConstructor和-RequiredArgsConstructor区别" class="headerlink" title="@NoArgsConstructor、@AllArgsConstructor和@RequiredArgsConstructor区别"></a>@NoArgsConstructor、@AllArgsConstructor和@RequiredArgsConstructor区别</h1><ol>
<li>@NoArgsConstructor：这个注解用于生成一个无参数的构造函数。当你在一个类上使用这个注解时，Lombok会自动为该类生成一个无参数的构造函数。这个注解在Spring Boot中常常被用在不需要参数就能创建对象的地方，例如单例模式或者作为其他构造函数的依赖注入。</li>
<li>@AllArgsConstructor：这个注解用于生成一个包含所有参数的构造函数。当你在一个类上使用这个注解时，Lombok会自动为该类的所有字段生成一个带有参数的构造函数。这个注解在Spring Boot中常常被用在需要使用所有字段来创建对象的地方，例如DTO（Data Transfer Object）对象的创建。</li>
<li>@RequiredArgsConstructor：这个注解用于自动生成带有final修饰符的成员变量的构造函数。当一个类中存在多个final修饰符的成员变量时，使用这个注解可以避免手动编写重复的构造函数代码。这个注解在Spring Boot中常常被用在需要将final字段绑定到具体实现的地方，例如Spring的Bean配置。</li>
</ol>
<blockquote>
<p>总结一下，@NoArgsConstructor、@AllArgsConstructor和@RequiredArgsConstructor这三个注解在Spring Boot项目中的常见应用场景包括：<br>在单例模式中，使用@NoArgsConstructor来创建一个无参数的构造函数，以便在不需要任何参数的情况下创建对象。<br>在DTO对象的创建中，使用@AllArgsConstructor来创建一个包含所有字段的构造函数，以便将所有字段的值传递给对象。<br>在Spring的Bean配置中，使用@RequiredArgsConstructor来自动生成包含final字段的构造函数的代码，以便将final字段绑定到具体实现。</p>
</blockquote>
<h1 id="Getter"><a href="#Getter" class="headerlink" title="@Getter"></a>@Getter</h1><p>生成getter、写在类上会生成该类下所有字段的getter。写在某个字段上就作用与该字段</p>
<h2 id="参数-2"><a href="#参数-2" class="headerlink" title="参数"></a>参数</h2><ol>
<li>onMethod：把需要添加的注解写在这<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Example</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter(onMethod_=&#123;@Deprecated&#125;)</span> <span class="comment">// JDK7写法 @Getter(onMethod=@__(&#123;@Deprecated&#125;))</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> foo;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">bar</span>  <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>生成：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Example</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> foo;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">bar</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Example</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@deprecated</span> */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getFoo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.foo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>value：访问权限修饰符</li>
</ol>
<h1 id="Setter"><a href="#Setter" class="headerlink" title="@Setter"></a>@Setter</h1><p>生成Setter</p>
<ol>
<li>onMethod：在方法上添加中注解，见@Getter#onMethod</li>
<li>onParam：在方法的参数上添加注解，见@Getter#onMethod</li>
<li>value：访问权限修饰符</li>
</ol>
<h1 id="NonNull"><a href="#NonNull" class="headerlink" title="@NonNull"></a>@NonNull</h1><p>空检查</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Example</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="keyword">private</span> Integer foo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Example</span> &#123;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="keyword">private</span> Integer foo;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Example</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getFoo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.foo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setFoo</span><span class="params">(<span class="meta">@NonNull</span> Integer foo)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (foo == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;foo is marked @NonNull but is null&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.foo = foo;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://leetao50.github.io/2024/04/29/rocketmq/RocketMQ%E7%AE%80%E4%BB%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="InfoPool">
      <meta itemprop="description" content="记录信息来源网络，内容只为方便查找，非公开信息，非请勿入">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | InfoPool">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/29/rocketmq/RocketMQ%E7%AE%80%E4%BB%8B/" class="post-title-link" itemprop="url">RocketMQ简介</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-04-29 12:02:15" itemprop="dateCreated datePublished" datetime="2024-04-29T12:02:15+08:00">2024-04-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-28 16:19:37" itemprop="dateModified" datetime="2024-05-28T16:19:37+08:00">2024-05-28</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>RocketMQ主要由 Producer、Broker、Consumer 三部分组成，其中Producer 负责生产消息，Consumer 负责消费消息，Broker 负责存储消息。Broker 在实际部署过程中对应一台服务器，每个 Broker 可以存储多个Topic的消息，每个Topic的消息也可以分片存储于不同的 Broker。Message Queue 用于存储消息的物理地址，每个Topic中的消息地址存储于多个 Message Queue 中。ConsumerGroup 由多个Consumer 实例构成。</p>
<h1 id="RocketMQ-网络部署特点"><a href="#RocketMQ-网络部署特点" class="headerlink" title="RocketMQ 网络部署特点"></a>RocketMQ 网络部署特点</h1><p><img src="42ff55f8bd0348f9e371087a39ccf917c358093b440fb488f62168773975c1bb.png" alt="图 0">  </p>
<h2 id="RocketMQ架构上主要分为四部分"><a href="#RocketMQ架构上主要分为四部分" class="headerlink" title="RocketMQ架构上主要分为四部分"></a>RocketMQ架构上主要分为四部分</h2><ol>
<li><p>NameServer：是一个几乎无状态节点，可集群部署，节点之间无任何信息同步。是一个非常简单的Topic路由注册中心，其角色类似Dubbo中的zookeeper，支持Broker的动态注册与发现。<br>主要包括两个功能：</p>
<ul>
<li>Broker管理，NameServer接受Broker集群的注册信息并且保存下来作为路由信息的基本数据。然后提供心跳检测机制，检查Broker是否还存活；</li>
<li>路由信息管理，每个NameServer将保存关于Broker集群的整个路由信息和用于客户端查询的队列信息。然后Producer和Conumser通过NameServer就可以知道整个Broker集群的路由信息，从而进行消息的投递和消费。<br>NameServer通常也是集群的方式部署，各实例间相互不进行信息通讯。Broker是向每一台NameServer注册自己的路由信息，所以每一个NameServer实例上面都保存一份完整的路由信息。当某个NameServer因某种原因下线了，Broker仍然可以向其它NameServer同步其路由信息，Producer,Consumer仍然可以动态感知Broker的路由的信息。</li>
</ul>
</li>
<li><p>Broker部署相对复杂，Broker分为Master与Slave，一个Master可以对应多个Slave，但是一个Slave只能对应一个Master，Master与Slave 的对应关系通过指定相同的BrokerName，不同的BrokerId 来定义，BrokerId为0表示Master，非0表示Slave。Master也可以部署多个。每个Broker与NameServer集群中的所有节点建立长连接，定时注册Topic信息到所有NameServer。 </p>
<blockquote>
<p>注意：当前RocketMQ版本在部署架构上支持一Master多Slave，但只有BrokerId&#x3D;1的从服务器才会参与消息的读负载。</p>
</blockquote>
</li>
<li><p>Producer与NameServer集群中的其中一个节点（随机选择）建立长连接，定期从NameServer获取Topic路由信息，并向提供Topic 服务的Master建立长连接，且定时向Master发送心跳。Producer完全无状态，可集群部署。</p>
</li>
<li><p>Consumer与NameServer集群中的其中一个节点（随机选择）建立长连接，定期从NameServer获取Topic路由信息，并向提供Topic服务的Master、Slave建立长连接，且定时向Master、Slave发送心跳。Consumer既可以从Master订阅消息，也可以从Slave订阅消息，消费者在向Master拉取消息时，Master服务器会根据拉取偏移量与最大偏移量的距离（判断是否读老消息，产生读I&#x2F;O），以及从服务器是否可读等因素建议下一次是从Master还是Slave拉取。</p>
</li>
</ol>
<h2 id="结合部署架构图，描述集群工作流程"><a href="#结合部署架构图，描述集群工作流程" class="headerlink" title="结合部署架构图，描述集群工作流程"></a>结合部署架构图，描述集群工作流程</h2><ol>
<li>启动NameServer，NameServer起来后监听端口，等待Broker、Producer、Consumer连上来，相当于一个路由控制中心。</li>
<li>Broker启动，跟所有的NameServer保持长连接，定时发送心跳包。心跳包中包含当前Broker信息(IP+端口等)以及存储所有Topic信息。注册成功后，NameServer集群中就有Topic跟Broker的映射关系。</li>
<li>Producer发送消息，启动时先跟NameServer集群中的其中一台建立长连接，并从NameServer中获取当前发送的Topic存在哪些Broker上，轮询从队列列表中选择一个队列，然后与队列所在的Broker建立长连接从而向Broker发消息</li>
<li>Consumer跟Producer类似，跟其中一台NameServer建立长连接，获取当前订阅Topic存在哪些Broker上，然后直接跟Broker建立连接通道，开始消费消息。</li>
<li>收发消息前，先创建Topic，创建Topic时需要指定该Topic要存储在哪些Broker上，也可以在发送消息时自动创建Topic。</li>
</ol>
<h2 id="Broker包含了以下几个重要子模块"><a href="#Broker包含了以下几个重要子模块" class="headerlink" title="Broker包含了以下几个重要子模块"></a>Broker包含了以下几个重要子模块</h2><p><img src="1095d6bc5cafd9efcd9f6aeb88a9982a00e535a98a71aeee56f89fa84b0800ef.png" alt="图 1">  </p>
<ol>
<li>Remoting Module：整个Broker的实体，负责处理来自clients端的请求。</li>
<li>Client Manager：负责管理客户端(Producer&#x2F;Consumer)和维护Consumer的Topic订阅信息</li>
<li>Store Service：提供方便简单的API接口处理消息存储到物理硬盘和查询功能。</li>
<li>HA Service：高可用服务，提供Master Broker 和 Slave Broker之间的数据同步功能。</li>
<li>Index Service：根据特定的Message key对投递到Broker的消息进行索引服务，以提供消息的快速查询。</li>
</ol>
<h1 id="集群部署"><a href="#集群部署" class="headerlink" title="集群部署"></a>集群部署</h1><h2 id="单Master模式"><a href="#单Master模式" class="headerlink" title="单Master模式"></a>单Master模式</h2><p>这种方式风险较大，一旦Broker重启或者宕机时，会导致整个服务不可用。不建议线上环境使用,可以用于本地测试。</p>
<ol>
<li><p>启动 NameServer</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">### 首先启动Name Server</span></span><br><span class="line">$ nohup sh mqnamesrv </span><br></pre></td></tr></table></figure>
</li>
<li><p>启动 Broker</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ nohup sh <span class="built_in">bin</span>/mqbroker -n localhost:<span class="number">9876</span> </span><br><span class="line"><span class="comment">### 验证Name Server 是否启动成功，例如Broker的IP为：192.168.1.2，且名称为broker-a</span></span><br></pre></td></tr></table></figure>
<h2 id="多Master模式"><a href="#多Master模式" class="headerlink" title="多Master模式"></a>多Master模式</h2><p>一个集群无Slave，全是Master，例如2个Master或者3个Master，这种模式的优缺点如下：</p>
</li>
</ol>
<ul>
<li>优点：配置简单，单个Master宕机或重启维护对应用无影响，在磁盘配置为RAID10时，即使机器宕机不可恢复情况下，由于RAID10磁盘非常可靠，消息也不会丢（异步刷盘丢失少量消息，同步刷盘一条不丢），性能最高；</li>
<li>缺点：单台机器宕机期间，这台机器上未被消费的消息在机器恢复之前不可订阅，消息实时性会受到影响。</li>
</ul>
<ol>
<li>启动NameServer</li>
</ol>
<p>NameServer需要先于Broker启动，且如果在生产环境使用，为了保证高可用，建议一般规模的集群启动3个NameServer，各节点的启动命令相同，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 首先启动Name Server</span></span><br><span class="line">$ nohup sh mqnamesrv</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>启动Broker集群</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 在机器A，启动第一个Master，例如NameServer的IP为：192.168.1.1</span></span><br><span class="line">$ nohup sh mqbroker -n <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span>:<span class="number">9876</span> -c $ROCKETMQ_HOME/conf/2m-noslave/broker-a.properties </span><br><span class="line"></span><br><span class="line"><span class="comment">### 在机器B，启动第二个Master，例如NameServer的IP为：192.168.1.1</span></span><br><span class="line">$ nohup sh mqbroker -n <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span>:<span class="number">9876</span> -c $ROCKETMQ_HOME/conf/2m-noslave/broker-b.properties </span><br></pre></td></tr></table></figure>

<p>如上启动命令是在单个NameServer情况下使用的。对于多个NameServer的集群，Broker启动命令中-n后面的地址列表用分号隔开即可，例如 192.168.1.1:9876;192.161.2:9876。</p>
<h2 id="多Master多Slave模式-异步复制"><a href="#多Master多Slave模式-异步复制" class="headerlink" title="多Master多Slave模式-异步复制"></a>多Master多Slave模式-异步复制</h2><p>每个Master配置一个Slave，有多对Master-Slave，HA采用异步复制方式，主备有短暂消息延迟（毫秒级），这种模式的优缺点如下：</p>
<p>优点：即使磁盘损坏，消息丢失的非常少，且消息实时性不会受影响，同时Master宕机后，消费者仍然可以从Slave消费，而且此过程对应用透明，不需要人工干预，性能同多Master模式几乎一样；<br>缺点：Master宕机，磁盘损坏情况下会丢失少量消息。</p>
<ol>
<li>启动NameServer<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 首先启动Name Server</span></span><br><span class="line">$ nohup sh mqnamesrv &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">### 验证Name Server 是否启动成功</span></span><br><span class="line">$ tail -f ~/logs/rocketmqlogs/namesrv.log</span><br><span class="line">The Name Server boot success...</span><br></pre></td></tr></table></figure></li>
<li>启动Broker集群</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 在机器A，启动第一个Master，例如NameServer的IP为：192.168.1.1</span></span><br><span class="line">$ nohup sh mqbroker -n <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span>:<span class="number">9876</span> -c $ROCKETMQ_HOME/conf/2m-2s-<span class="keyword">async</span>/broker-a.properties &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">### 在机器B，启动第二个Master，例如NameServer的IP为：192.168.1.1</span></span><br><span class="line">$ nohup sh mqbroker -n <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span>:<span class="number">9876</span> -c $ROCKETMQ_HOME/conf/2m-2s-<span class="keyword">async</span>/broker-b.properties &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">### 在机器C，启动第一个Slave，例如NameServer的IP为：192.168.1.1</span></span><br><span class="line">$ nohup sh mqbroker -n <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span>:<span class="number">9876</span> -c $ROCKETMQ_HOME/conf/2m-2s-<span class="keyword">async</span>/broker-a-s.properties &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">### 在机器D，启动第二个Slave，例如NameServer的IP为：192.168.1.1</span></span><br><span class="line">$ nohup sh mqbroker -n <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span>:<span class="number">9876</span> -c $ROCKETMQ_HOME/conf/2m-2s-<span class="keyword">async</span>/broker-b-s.properties </span><br></pre></td></tr></table></figure>

<h2 id="多Master多Slave模式-同步双写"><a href="#多Master多Slave模式-同步双写" class="headerlink" title="多Master多Slave模式-同步双写"></a>多Master多Slave模式-同步双写</h2><p>每个Master配置一个Slave，有多对Master-Slave，HA采用同步双写方式，即只有主备都写成功，才向应用返回成功，这种模式的优缺点如下：</p>
<p>优点：数据与服务都无单点故障，Master宕机情况下，消息无延迟，服务可用性与数据可用性都非常高；<br>缺点：性能比异步复制模式略低（大约低10%左右），发送单个消息的RT会略高，且目前版本在主节点宕机后，备机不能自动切换为主机。</p>
<ol>
<li>启动NameServer</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 首先启动Name Server</span></span><br><span class="line">$ nohup sh mqnamesrv &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">### 验证Name Server 是否启动成功</span></span><br><span class="line">$ tail -f ~/logs/rocketmqlogs/namesrv.log</span><br><span class="line">The Name Server boot success...</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>启动Broker集群<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 在机器A，启动第一个Master，例如NameServer的IP为：192.168.1.1</span></span><br><span class="line">$ nohup sh mqbroker -n <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span>:<span class="number">9876</span> -c $ROCKETMQ_HOME/conf/2m-2s-sync/broker-a.properties &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">### 在机器B，启动第二个Master，例如NameServer的IP为：192.168.1.1</span></span><br><span class="line">$ nohup sh mqbroker -n <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span>:<span class="number">9876</span> -c $ROCKETMQ_HOME/conf/2m-2s-sync/broker-b.properties &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">### 在机器C，启动第一个Slave，例如NameServer的IP为：192.168.1.1</span></span><br><span class="line">$ nohup sh mqbroker -n <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span>:<span class="number">9876</span> -c $ROCKETMQ_HOME/conf/2m-2s-sync/broker-a-s.properties &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">### 在机器D，启动第二个Slave，例如NameServer的IP为：192.168.1.1</span></span><br><span class="line">$ nohup sh mqbroker -n <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span>:<span class="number">9876</span> -c $ROCKETMQ_HOME/conf/2m-2s-sync/broker-b-s.properties &amp;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>以上Broker与Slave配对是通过指定相同的BrokerName参数来配对，Master的BrokerId必须是0，Slave的BrokerId必须是大于0的数。另外一个Master下面可以挂载多个Slave，同一Master下的多个Slave通过指定不同的BrokerId来区分。$ROCKETMQ_HOME指的RocketMQ安装目录，需要用户自己设置此环境变量。</p>
<h1 id="集群监控平台搭建"><a href="#集群监控平台搭建" class="headerlink" title="集群监控平台搭建"></a>集群监控平台搭建</h1><p>RocketMQ有一个对其扩展的开源项目incubator-rocketmq-externals，这个项目中有一个子模块叫rocketmq-console，这个便是管理控制台项目了，先将incubator-rocketmq-externals拉到本地，因为我们需要自己对rocketmq-console进行编译打包运行。</p>
<p>下载并编译打包</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/apache/rocketmq-dashboard.git</span><br><span class="line"><span class="built_in">cd</span> rocketmq-dashboard</span><br></pre></td></tr></table></figure>
<p>进入到解压的文件夹下修改 application.yml 文件</p>
<p>执行<code> mvn clean package -DskipTests=true</code></p>
<p>启动 rocketmq-dashboard：</p>
<p><code>java -jar rocketmq-dashboard-1.0.1-SNAPSHOT.jar</code></p>
<p>启动成功后，我们就可以通过浏览器访问<a href="http://localhost:8080进入控制台界面了，如下图：">http://localhost:8080进入控制台界面了，如下图：</a></p>
<p><img src="d56dfc1921c2d22aad5573f1c3a8cc0e51d979763894cd87f2f7e7068c844469.png" alt="图 2">  </p>
<h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h1><p>在基本样例中我们提供如下的功能场景：</p>
<ul>
<li>使用RocketMQ发送三种类型的消息：同步消息、异步消息和单向消息。其中前两种消息是可靠的，因为会有发送是否成功的应答。</li>
<li>使用RocketMQ来消费接收到的消息。</li>
</ul>
<h2 id="加入依赖"><a href="#加入依赖" class="headerlink" title="加入依赖"></a>加入依赖</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.rocketmq&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;rocketmq-client&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.3.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h2 id="消息发送"><a href="#消息发送" class="headerlink" title="消息发送"></a>消息发送</h2><p>Producer端发送同步消息 这种可靠性同步地发送方式使用的比较广泛，比如：重要的消息通知，短信通知。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SyncProducer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 实例化消息生产者Producer</span></span><br><span class="line">        <span class="type">DefaultMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQProducer</span>(<span class="string">&quot;please_rename_unique_group_name&quot;</span>);</span><br><span class="line">        <span class="comment">// 设置NameServer的地址</span></span><br><span class="line">        producer.setNamesrvAddr(<span class="string">&quot;localhost:9876&quot;</span>);</span><br><span class="line">        <span class="comment">// 启动Producer实例</span></span><br><span class="line">        producer.start();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="comment">// 创建消息，并指定Topic，Tag和消息体</span></span><br><span class="line">            <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;TopicTest&quot;</span> <span class="comment">/* Topic */</span>,</span><br><span class="line">            <span class="string">&quot;TagA&quot;</span> <span class="comment">/* Tag */</span>,</span><br><span class="line">            (<span class="string">&quot;Hello RocketMQ &quot;</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET) <span class="comment">/* Message body */</span></span><br><span class="line">            );</span><br><span class="line">            <span class="comment">// 发送消息到一个Broker</span></span><br><span class="line">            <span class="type">SendResult</span> <span class="variable">sendResult</span> <span class="operator">=</span> producer.send(msg);</span><br><span class="line">            <span class="comment">// 通过sendResult返回消息是否成功送达</span></span><br><span class="line">            System.out.printf(<span class="string">&quot;%s%n&quot;</span>, sendResult);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果不再发送消息，关闭Producer实例。</span></span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发送异步消息 异步消息通常用在对响应时间敏感的业务场景，即发送端不能容忍长时间地等待Broker的响应。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncProducer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 实例化消息生产者Producer</span></span><br><span class="line">        <span class="type">DefaultMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQProducer</span>(<span class="string">&quot;please_rename_unique_group_name&quot;</span>);</span><br><span class="line">        <span class="comment">// 设置NameServer的地址</span></span><br><span class="line">        producer.setNamesrvAddr(<span class="string">&quot;localhost:9876&quot;</span>);</span><br><span class="line">        <span class="comment">// 启动Producer实例</span></span><br><span class="line">        producer.start();</span><br><span class="line">        producer.setRetryTimesWhenSendAsyncFailed(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">messageCount</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">        <span class="comment">// 根据消息数量实例化倒计时计算器</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">CountDownLatch2</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch2</span>(messageCount);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; messageCount; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> i;</span><br><span class="line">                <span class="comment">// 创建消息，并指定Topic，Tag和消息体</span></span><br><span class="line">                <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;TopicTest&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;TagA&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;OrderID188&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Hello world&quot;</span>.getBytes(RemotingHelper.DEFAULT_CHARSET));</span><br><span class="line">                <span class="comment">// SendCallback接收异步返回结果的回调</span></span><br><span class="line">                producer.send(msg, <span class="keyword">new</span> <span class="title class_">SendCallback</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(SendResult sendResult)</span> &#123;</span><br><span class="line">                        System.out.printf(<span class="string">&quot;%-10d OK %s %n&quot;</span>, index,</span><br><span class="line">                            sendResult.getMsgId());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onException</span><span class="params">(Throwable e)</span> &#123;</span><br><span class="line">                      System.out.printf(<span class="string">&quot;%-10d Exception %s %n&quot;</span>, index, e);</span><br><span class="line">                      e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// 等待5s</span></span><br><span class="line">    countDownLatch.await(<span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="comment">// 如果不再发送消息，关闭Producer实例。</span></span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>单向发送消息 这种方式主要用在不特别关心发送结果的场景，例如日志发送。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OnewayProducer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 实例化消息生产者Producer</span></span><br><span class="line">        <span class="type">DefaultMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQProducer</span>(<span class="string">&quot;please_rename_unique_group_name&quot;</span>);</span><br><span class="line">        <span class="comment">// 设置NameServer的地址</span></span><br><span class="line">        producer.setNamesrvAddr(<span class="string">&quot;localhost:9876&quot;</span>);</span><br><span class="line">        <span class="comment">// 启动Producer实例</span></span><br><span class="line">        producer.start();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="comment">// 创建消息，并指定Topic，Tag和消息体</span></span><br><span class="line">            <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;TopicTest&quot;</span> <span class="comment">/* Topic */</span>,</span><br><span class="line">                <span class="string">&quot;TagA&quot;</span> <span class="comment">/* Tag */</span>,</span><br><span class="line">                (<span class="string">&quot;Hello RocketMQ &quot;</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET) <span class="comment">/* Message body */</span></span><br><span class="line">            );</span><br><span class="line">            <span class="comment">// 发送单向消息，没有任何返回结果</span></span><br><span class="line">            producer.sendOneway(msg);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果不再发送消息，关闭Producer实例。</span></span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发送延时消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScheduledMessageProducer</span> &#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      <span class="comment">// 实例化一个生产者来产生延时消息</span></span><br><span class="line">      <span class="type">DefaultMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQProducer</span>(<span class="string">&quot;ExampleProducerGroup&quot;</span>);</span><br><span class="line">      <span class="comment">// 启动生产者</span></span><br><span class="line">      producer.start();</span><br><span class="line">      <span class="type">int</span> <span class="variable">totalMessagesToSend</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; totalMessagesToSend; i++) &#123;</span><br><span class="line">          <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;TestTopic&quot;</span>, (<span class="string">&quot;Hello scheduled message &quot;</span> + i).getBytes());</span><br><span class="line">          <span class="comment">// 设置延时等级3,这个消息将在10s之后发送(现在只支持固定的几个时间,详看delayTimeLevel)</span></span><br><span class="line">          message.setDelayTimeLevel(<span class="number">3</span>);</span><br><span class="line">          <span class="comment">// 发送消息</span></span><br><span class="line">          producer.send(message);</span><br><span class="line">      &#125;</span><br><span class="line">       <span class="comment">// 关闭生产者</span></span><br><span class="line">      producer.shutdown();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>批量发送消息能显著提高传递小消息的性能。限制是这些批量消息应该有相同的topic，相同的waitStoreMsgOK，而且不能是延时消息。此外，这一批消息的总大小不应超过4MB。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">topic</span> <span class="operator">=</span> <span class="string">&quot;BatchTest&quot;</span>;</span><br><span class="line">List&lt;Message&gt; messages = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">messages.add(<span class="keyword">new</span> <span class="title class_">Message</span>(topic, <span class="string">&quot;TagA&quot;</span>, <span class="string">&quot;OrderID001&quot;</span>, <span class="string">&quot;Hello world 0&quot;</span>.getBytes()));</span><br><span class="line">messages.add(<span class="keyword">new</span> <span class="title class_">Message</span>(topic, <span class="string">&quot;TagA&quot;</span>, <span class="string">&quot;OrderID002&quot;</span>, <span class="string">&quot;Hello world 1&quot;</span>.getBytes()));</span><br><span class="line">messages.add(<span class="keyword">new</span> <span class="title class_">Message</span>(topic, <span class="string">&quot;TagA&quot;</span>, <span class="string">&quot;OrderID003&quot;</span>, <span class="string">&quot;Hello world 2&quot;</span>.getBytes()));</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">   producer.send(messages);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">   e.printStackTrace();</span><br><span class="line">   <span class="comment">//处理error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>你可能不确定它是否超过了大小限制（4MB）。这时候你最好把你的消息列表分割一下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ListSplitter</span> <span class="keyword">implements</span> <span class="title class_">Iterator</span>&lt;List&lt;Message&gt;&gt; &#123; </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SIZE_LIMIT</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Message&gt; messages;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> currIndex;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ListSplitter</span><span class="params">(List&lt;Message&gt; messages)</span> &#123; </span><br><span class="line">        <span class="built_in">this</span>.messages = messages;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> currIndex &lt; messages.size(); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> List&lt;Message&gt; <span class="title function_">next</span><span class="params">()</span> &#123; </span><br><span class="line">        <span class="type">int</span> <span class="variable">startIndex</span> <span class="operator">=</span> getStartIndex();</span><br><span class="line">        <span class="type">int</span> <span class="variable">nextIndex</span> <span class="operator">=</span> startIndex;</span><br><span class="line">        <span class="type">int</span> <span class="variable">totalSize</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (; nextIndex &lt; messages.size(); nextIndex++) &#123;</span><br><span class="line">            <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> messages.get(nextIndex); </span><br><span class="line">            <span class="type">int</span> <span class="variable">tmpSize</span> <span class="operator">=</span> calcMessageSize(message);</span><br><span class="line">            <span class="keyword">if</span> (tmpSize + totalSize &gt; SIZE_LIMIT) &#123;</span><br><span class="line">                <span class="keyword">break</span>; </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                totalSize += tmpSize; </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;Message&gt; subList = messages.subList(startIndex, nextIndex); </span><br><span class="line">        currIndex = nextIndex;</span><br><span class="line">        <span class="keyword">return</span> subList;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getStartIndex</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">currMessage</span> <span class="operator">=</span> messages.get(currIndex); </span><br><span class="line">        <span class="type">int</span> <span class="variable">tmpSize</span> <span class="operator">=</span> calcMessageSize(currMessage); </span><br><span class="line">        <span class="keyword">while</span>(tmpSize &gt; SIZE_LIMIT) &#123;</span><br><span class="line">            currIndex += <span class="number">1</span>;</span><br><span class="line">            <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> messages.get(curIndex); </span><br><span class="line">            tmpSize = calcMessageSize(message);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> currIndex; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">calcMessageSize</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">tmpSize</span> <span class="operator">=</span> message.getTopic().length() + message.getBody().length(); </span><br><span class="line">        Map&lt;String, String&gt; properties = message.getProperties();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : properties.entrySet()) &#123;</span><br><span class="line">            tmpSize += entry.getKey().length() + entry.getValue().length(); </span><br><span class="line">        &#125;</span><br><span class="line">        tmpSize = tmpSize + <span class="number">20</span>; <span class="comment">// 增加⽇日志的开销20字节</span></span><br><span class="line">        <span class="keyword">return</span> tmpSize; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//把大的消息分裂成若干个小的消息</span></span><br><span class="line"><span class="type">ListSplitter</span> <span class="variable">splitter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ListSplitter</span>(messages);</span><br><span class="line"><span class="keyword">while</span> (splitter.hasNext()) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">      List&lt;Message&gt;  listItem = splitter.next();</span><br><span class="line">      producer.send(listItem);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">      <span class="comment">//处理error</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="消费消息"><a href="#消费消息" class="headerlink" title="消费消息"></a>消费消息</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, MQClientException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实例化消费者</span></span><br><span class="line">        <span class="type">DefaultMQPushConsumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQPushConsumer</span>(<span class="string">&quot;please_rename_unique_group_name&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置NameServer的地址</span></span><br><span class="line">        consumer.setNamesrvAddr(<span class="string">&quot;localhost:9876&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 订阅一个或者多个Topic，以及Tag来过滤需要消费的消息</span></span><br><span class="line">        consumer.subscribe(<span class="string">&quot;TopicTest&quot;</span>, <span class="string">&quot;*&quot;</span>);</span><br><span class="line">        <span class="comment">// 注册回调实现类来处理从broker拉取回来的消息</span></span><br><span class="line">        consumer.registerMessageListener(<span class="keyword">new</span> <span class="title class_">MessageListenerConcurrently</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> ConsumeConcurrentlyStatus <span class="title function_">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; msgs, ConsumeConcurrentlyContext context)</span> &#123;</span><br><span class="line">                System.out.printf(<span class="string">&quot;%s Receive New Messages: %s %n&quot;</span>, Thread.currentThread().getName(), msgs);</span><br><span class="line">                <span class="comment">// 标记该消息已经被成功消费</span></span><br><span class="line">                <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 启动消费者实例</span></span><br><span class="line">        consumer.start();</span><br><span class="line">        System.out.printf(<span class="string">&quot;Consumer Started.%n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://leetao50.github.io/2024/03/20/Spring/SpringBean%E6%B3%A8%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="InfoPool">
      <meta itemprop="description" content="记录信息来源网络，内容只为方便查找，非公开信息，非请勿入">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | InfoPool">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/20/Spring/SpringBean%E6%B3%A8%E8%A7%A3/" class="post-title-link" itemprop="url">SpringBean注解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-03-20 18:16:11" itemprop="dateCreated datePublished" datetime="2024-03-20T18:16:11+08:00">2024-03-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-03-21 09:56:28" itemprop="dateModified" datetime="2024-03-21T09:56:28+08:00">2024-03-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Bean"><a href="#Bean" class="headerlink" title="@Bean"></a>@Bean</h1><p>Bean可以说是Spring当中最为重要的概念之一了。简单来说，Bean就是一个对象，只不过这个对象是由Spring容器来初始化，装配，管理的，因此也可以叫做Spring Bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD, ElementType.ANNOTATION_TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Bean &#123;</span><br><span class="line">    <span class="meta">@AliasFor(&quot;name&quot;)</span></span><br><span class="line">    String[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AliasFor(&quot;value&quot;)</span></span><br><span class="line">    String[] name() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@deprecated</span> */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    Autowire <span class="title function_">autowire</span><span class="params">()</span> <span class="keyword">default</span> Autowire.NO;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">autowireCandidate</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">initMethod</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">destroyMethod</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;(inferred)&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：当注解中只传入value一个属性的时候，value属性的名称可以省略；即：@Bean(value&#x3D;”myBean”)等同于@Bean(“myBean”)；Alias是别名的意思，因此使用@Bean(name&#x3D;”myBean”)也是一样的效果。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FooService <span class="title function_">fooService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FooService</span>(fooRepository());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FooRepository <span class="title function_">fooRepository</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JdbcFooRepository</span>(datasource());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上面的代码中，我们向Spring容器中注入了两个Bean，当没有显式命名时，自动注册的名称为方法名。</p>
<p>使用name属性显式命名如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean(&#123;&quot;b1&quot;, &quot;b2&quot;&#125;)</span> <span class="comment">// Bean可以用&#x27;b1&#x27;或者&#x27;b2&#x27;取到，而非&#x27;myBean&#x27;</span></span><br><span class="line"><span class="keyword">public</span> MyBean <span class="title function_">myBean</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 此处初始化和配置MyBean对象</span></span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<h1 id="Configuration"><a href="#Configuration" class="headerlink" title="@Configuration"></a>@Configuration</h1><p>@Bean注解往往和@Configuration配合，前者标注在方法上，后者标注在类上；两者搭配，将Bean注册到容器中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Configuration &#123;</span><br><span class="line">    <span class="meta">@AliasFor(</span></span><br><span class="line"><span class="meta">        annotation = Component.class</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">proxyBeanMethods</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我们可以从源码中可以看到，它实质上也是一个@Component注解，所以该注解标记的类本身也会被注册成一个Bean</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MyBean <span class="title function_">myBean</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// instance, configure and return bean</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它指示类生成一个或者多个@Bean方法，可以由Spring容器处理，在运行时为这些Bean生成BeanDefination和服务请求。</p>
<h1 id="Component"><a href="#Component" class="headerlink" title="@Component"></a>@Component</h1><p>从前面我们知道，所谓的Bean其实就是一个个对象；但是@Bean注解是标注在方法上的，意思就是通过方法返回一个对象，那么有没有直接通过类获取对象的呢？当然有，那就是@Component，被该注解标注的类会被注册到当前容器，bean的id就是类名转换为小驼峰。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Indexed</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Component &#123;</span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接标注在类上，Spring扫描时会将其加入容器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span> <span class="comment">// or @Component(&quot;myBean&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line">    <span class="comment">// write your bean here...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Spring常用注册Bean注解："><a href="#Spring常用注册Bean注解：" class="headerlink" title="Spring常用注册Bean注解："></a>Spring常用注册Bean注解：</h2><ul>
<li>@Component, @Service, @Repository, @Controller四个注解作用于类上，实质上是一样的，注册类到当前容器，value属性就是BeanName</li>
<li>@Configuration注解也作用于类上，该注解通常与@Bean配合使用</li>
<li>@Bean用于方法上，该方法需要在@Configutation标注的类里面，且方法必须为public</li>
<li>@Component注解的效果与@Bean的效果类似，也是单例模式。可以搭配的注解也类似，例如@Scope, @Profile, @Primary等等。</li>
</ul>
<h1 id="Autowired"><a href="#Autowired" class="headerlink" title="@Autowired"></a>@Autowired</h1><p>我们使用@Bean(或者@Component)注解将Bean注册到了Spring容器；我们创建这些Bean的目的，最终还是为了使用，@Autowired注解可以将bean自动注入到类的属性中。@Autowired注解可以直接标注在属性上，也可以标注在构造器，方法，甚至是传入参数上，其实质都是调用了setter方法注入。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.CONSTRUCTOR, ElementType.METHOD, ElementType.PARAMETER, ElementType.FIELD, ElementType.ANNOTATION_TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Autowired &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">required</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>当自动注入的Bean不存在时，Spring会报错；如果希望Bean存在时才注入，可以使用@Autowired(required&#x3D;false)。</p>
</blockquote>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="meta">@Autowired</span> <span class="comment">//标注在属性上</span></span><br><span class="line"><span class="keyword">private</span> MyBean myBean;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span> <span class="comment">//标注在方法上</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMyBean</span><span class="params">(MyBean myBean)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.myBean = myBean;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span><span class="comment">//标注在构造函数上</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">MyClass</span><span class="params">(MyBean myBean)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.myBean = myBean;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="comment">//标注在方法参数上</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMyBean</span><span class="params">(<span class="meta">@Autowired</span> MyBean myBean)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.myBean = myBean;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ul>
<li>@Autowired和@Resource注解都是作为bean对象注入时使用的，@Autowired是Spring提供的注解，而@Resource是J2EE本身提供的。</li>
<li>@Autowired首先根据类型去寻找注入的对象，如果有多个再根据名字匹配。</li>
<li>当名字也无法区分时可以通过@Qulifier显式指定，如：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="meta">@Qualifier(&quot;userServiceImpl1&quot;)</span></span><br><span class="line"><span class="keyword">private</span> UserService userService;</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="Qualifier"><a href="#Qualifier" class="headerlink" title="@Qualifier"></a>@Qualifier</h1><p>当同一个类型的Bean创建了多个时，我们可以通过搭配@Autowired和@Qualifier来确定需要注入的Bean解决混淆。除此以外，@Qualifier还可以标注在Bean上实现逻辑分组。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.FIELD, ElementType.METHOD, ElementType.PARAMETER, ElementType.TYPE, ElementType.ANNOTATION_TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Qualifier &#123;</span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>标注在单个属性上，是根据name去获取Bean:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="meta">@Qualifier(&quot;bean2&quot;)</span></span><br><span class="line"><span class="keyword">private</span> MyBean mybean;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MyBean <span class="title function_">bean1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyBean</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MyBean <span class="title function_">bean2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyBean</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>标注在集合上，则可以筛选出被@Qualifier标注的Bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> List&lt;User&gt; users; <span class="comment">// user1, user2, user3</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="meta">@Qualifier</span></span><br><span class="line"><span class="keyword">private</span> List&lt;User&gt; usersQualifier; <span class="comment">// user2, user3</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">user1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span> </span><br><span class="line"><span class="meta">@Qualifier</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">user2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Qualifier</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">user3</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Primary"><a href="#Primary" class="headerlink" title="@Primary"></a>@Primary</h1><p>当一个接口有多个实现时，我们可以通过给@Autowired注解搭配@Qualifier来注入我们想要的Bean。这里还有另一种情况：Bean之前分优先级顺序，一般情况下我们只会注入默认实现；这个时候可以采用@Primary注解，该注解标注于Bean上，指示了优先注入的类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Primary &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用时直接标注在返回Bean的方法上</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> MyBean <span class="title function_">myBean</span><span class="params">()</span>; <span class="comment">// 注入myBean1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Primary</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MyBean <span class="title function_">myBean1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyBean</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MyBean <span class="title function_">myBean2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyBean</span>();</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>也可以标注在@Component的类上(@Controller, @Service, @Repository也是一样的)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Primary</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBean</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Scope"><a href="#Scope" class="headerlink" title="@Scope"></a>@Scope</h1><p>Spring中的Bean默认是单例模式，在代码各处注入的一个Bean都是同一个实例；我们将在Spring IoC创建的Bean对象的请求可见范围称为作用域。注解@Scope可用于更改Bean的作用域。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Scope &#123;</span><br><span class="line">    <span class="meta">@AliasFor(&quot;scopeName&quot;)</span></span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AliasFor(&quot;value&quot;)</span></span><br><span class="line">    String <span class="title function_">scopeName</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    ScopedProxyMode <span class="title function_">proxyMode</span><span class="params">()</span> <span class="keyword">default</span> ScopedProxyMode.DEFAULT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>传入作用域类型时直接传入字符串，例如：@Scope(“prototype”)，但这种方法字符串拼写错误不容易发现；Spring提供了默认的参数：ConfigurableBeanFactory.SCOPE_PROTOTYPE, ConfigurableBeanFactory.SCOPE_SINGLETON, WebApplicationContext.SCOPE_REQUEST, WebApplicationContext.SCOPE_SESSION<br>proxyMode也提供了参数：ScopedProxyMode.INTERFACES, ScopedProxyMode.TARGET_CLASS</p>
</blockquote>
<h2 id="作用域分为："><a href="#作用域分为：" class="headerlink" title="作用域分为："></a>作用域分为：</h2><ul>
<li>基本作用域(singleton, prototype)</li>
<li>Web作用域(request, session, globalssion)<br>由于默认为单例模式，所以需要标注时一般都是使用prototype<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Scope(&quot;prototype&quot;)</span>  <span class="comment">// @Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE)</span></span><br><span class="line"><span class="keyword">public</span> MyBean <span class="title function_">myBean</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyBean</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
prototype是原型模式，具体可以看设计模式中的”原型模式”，每次通过容器的getBean方法获取Bean时，都将产生一个新的Bean实例。</li>
</ul>
<h2 id="常见使用误区，单例调用多例："><a href="#常见使用误区，单例调用多例：" class="headerlink" title="常见使用误区，单例调用多例："></a>常见使用误区，单例调用多例：</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SingletonBean</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PrototypeBean bean;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE)</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码中，外面的SingletonBean默认单例模式，里面的PrototypeBean设置成原型模式。<br>这里并不能达到我们每次创建返回新实例的效果。<br>因为@Autowired只会在单例SingletonBean初始化的时候注入一次，再次调用SingletonBean的时候，PrototypeBean不会再创建了(注入时创建，而注入只有一次)。<br>解决方法1：不使用@Autowired，每次调用多例的时候，直接调用Bean;<br>解决方法2：Spring的解决办法：设置proxyMode, 每次请求的时候实例化。</p>
<blockquote>
<p>两种代理模式的区别：<br>ScopedProxyMode.INTERFACES: 创建一个JDK代理模式<br>ScopedProxyMode.TARGET_CLASS: 基于类的代理模式<br>前者只能将其注入一个接口，后者可以将其注入类。</p>
</blockquote>
<h1 id="Lazy"><a href="#Lazy" class="headerlink" title="@Lazy"></a>@Lazy</h1><p>Spring Boot中Bean默认的作用域为单例模式；而Spring IoC容器会在启动的时候实例化所有单例Bean。熟悉单例模式的朋友也许立刻想到了饿汉模式和懒汉模式。在Spring Boot中，@Lazy用于指定Bean是否取消预初始化，该注解可以用于直接或者间接用了@Component注解的类，或使用了@Bean的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD, ElementType.CONSTRUCTOR, ElementType.PARAMETER, ElementType.FIELD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Lazy &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@Lazy注解使用在@Bean方法上：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Lazy</span></span><br><span class="line"><span class="keyword">public</span> MyBean <span class="title function_">myBean</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyBean</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也可以在@Comfiguration类上使用，该类中所有的@Bean方法都会延迟初始化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Lazy</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span>() &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MyBean <span class="title function_">myBean1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyBean</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MyBean <span class="title function_">myBean2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyBean</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在标注了@Lazy的@Configuration类内，在某个@Bean方法上标注@Lazy(false)，表明这个bean立即初始化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Lazy</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span>() &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Lazy(false)</span></span><br><span class="line">    <span class="keyword">public</span> MyBean <span class="title function_">myBean1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyBean</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Profile"><a href="#Profile" class="headerlink" title="@Profile"></a>@Profile</h1><p>@Profile注解在前面的的文章中提到过，这是一个直接用英文翻译比较难理解的词；profile本身的意思是”轮廓”，”侧写”，在编程的其他领域，这个词有针对每个用户的数据存储的意思。而在Spring Boot当中，这个词用于区分不同的环境，如开发环境，测试环境，生产环境。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Conditional(&#123;ProfileCondition.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Profile &#123;</span><br><span class="line">    String[] value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该注解可以传入多个字符串，@Profile(“prod”), @Profile({“test”,”master”})都是合法的使用，如果有多个条件，需要同时满足</p>
<p>一般在@Configuration下使用，标注在能返回Bean的类或者方法上，标注的时候填入一个字符串，作为一个场景或者一个区分。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Profile(&quot;dev&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line">    <span class="comment">// your beans here</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当Profile为dev时，上面的代码才会在Spring中注册MyConfig这个类。</p>
<p>在Profile的名字前加”!”，即Profile不激活才注册相应的Bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Profile(&quot;!test&quot;)</span> <span class="comment">// test不激活才创建该Bean</span></span><br><span class="line"><span class="keyword">public</span> MyBean <span class="title function_">myBean</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyBean</span>();</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h2 id="激活环境"><a href="#激活环境" class="headerlink" title="激活环境"></a>激活环境</h2><p>最推荐的方式是在计算机中配置环境变量：export SPRING_PROFILES_ACTIVE&#x3D;prod，这样注册的环境就和计算机绑定在一起。<br>也可以设置启动参数-Dspring.profiles.active&#x3D;test<br>允许同时激活多个环境，如：-Dspring.profiles.active&#x3D;test,master<br>也可以在application.yml中配置，或者使用@ActiveProfiles注解，但是它们直接写在了源代码中，失去了灵活性，这里就不展开说了。</p>
<blockquote>
<p>prod, dev, test等都是常用的缩写, 属于自己定义的内容而非Spring提供的定义</p>
</blockquote>
<h1 id="ComponentScan"><a href="#ComponentScan" class="headerlink" title="@ComponentScan"></a>@ComponentScan</h1><p>标注了@Component等注解的类会被注册为Bean。那么@ComponentScan自然就是用于开启包扫描，将Bean注册到Spring IoC环境中的注解。该注解标注在启动类上，它定义了扫描路径，从中找到标识了需要装配的类，自动将其装配到环境中。</p>
<blockquote>
<p>在Spring Boot中，我们常常见到的是复合注解@SpringBootApplication，这个注解的功能之一等效于使用了@ComponentScan，因此我们前面没有显式提到要使用@ComponentScan</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Repeatable(ComponentScans.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ComponentScan &#123;</span><br><span class="line">    <span class="meta">@AliasFor(&quot;basePackages&quot;)</span></span><br><span class="line">    String[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AliasFor(&quot;value&quot;)</span></span><br><span class="line">    String[] basePackages() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt;[] basePackageClasses() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    Class&lt;? <span class="keyword">extends</span> <span class="title class_">BeanNameGenerator</span>&gt; nameGenerator() <span class="keyword">default</span> BeanNameGenerator.class;</span><br><span class="line"></span><br><span class="line">    Class&lt;? <span class="keyword">extends</span> <span class="title class_">ScopeMetadataResolver</span>&gt; scopeResolver() <span class="keyword">default</span> AnnotationScopeMetadataResolver.class;</span><br><span class="line"></span><br><span class="line">    ScopedProxyMode <span class="title function_">scopedProxy</span><span class="params">()</span> <span class="keyword">default</span> ScopedProxyMode.DEFAULT;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">resourcePattern</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;**/*.class&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">useDefaultFilters</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    ComponentScan.Filter[] includeFilters() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    ComponentScan.Filter[] excludeFilters() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">lazyInit</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line">    <span class="meta">@Target(&#123;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@interface</span> Filter &#123;</span><br><span class="line">        FilterType <span class="title function_">type</span><span class="params">()</span> <span class="keyword">default</span> FilterType.ANNOTATION;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@AliasFor(&quot;classes&quot;)</span></span><br><span class="line">        Class&lt;?&gt;[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@AliasFor(&quot;value&quot;)</span></span><br><span class="line">        Class&lt;?&gt;[] classes() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">        String[] pattern() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@ComponentScan标注在启动类上，如果不传入basePackages属性，那么扫描的路径默认为当前包以及当前路径下的子包，这也是启动类为什么一般放在源代码最外层的原因。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyApplication</span> &#123;</span><br><span class="line">    <span class="comment">// 启动类</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>includeFilters和excludeFilters两个属性的行为比较理解，就是包含或者排除哪些特殊情况，但Filter类值得讲一讲。<br>FilterType有五种类型：注解类型FilterType.ANNOTATION, 指定固定类FilterType.ASSIGNABLE_TYPE, 切入点类型FilterType.ASPECTJ, 正则表达式FilterType.REGEX, 自定义类型FilterType.CUSTOM<br>首先说注解类型，比如我们知道@Controller会被注册为Bean，我们可以将其排除。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ComponentScan(</span></span><br><span class="line"><span class="meta">    excludeFilters=&#123;@Filter(type=FilterType.ANNOTATION,classes=&#123;Controller.class&#125;)&#125;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyApplication</span> &#123;</span><br><span class="line">    <span class="comment">// 启动类</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用includeFilters将未标注的自定义类注册进容器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ComponentScan(</span></span><br><span class="line"><span class="meta">    includeFilters=&#123;@Filter(type=FilterType.ASSIGNABLE_TYPE, classes=&#123;MyClass.class&#125;)&#125;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyApplication</span> &#123;</span><br><span class="line">    <span class="comment">// 启动类</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>我们对Spring注解的学习整理也完成了第一阶段。别的文章往往一开始都会介绍@SpringBootApplication，而我们仅仅只让它在第十篇文章内露了一下面。看似我们的文章组织的没有章法，实际上也是无可奈何，平级的知识之间的关系就如同网状，起步阶段总是感觉备受困扰，我已经按照我认为最容易理解的顺序组织内容。如果看的不太懂，不妨先去找找DEMO，上手敲一敲。<br>回到我们的文章上来，第一阶段的主题是Bean装配，想要将Bean注册到Spring IoC容器。一般有两种思路：<br>①使用@Configuration标注在类上, 正如其名字所表达的那样，在这个配置类中，我们可以在返回Bean的方法上标注@Bean；<br>②直接在类上标注@Component，那么这个类就会被注册到容器中。<br>Bean被注册到了容器中，但我们并不能直接使用，否则那岂不是成了全局变量，开了历史的倒车？<br>@Autowired能够将Bean注入到成员变量中，它实际上调用了setter方法，所以需要注入的字段，需要声明public的setter方法。<br>自动注入时类型必须匹配，必须是对应的类或者子类。当对应的类只有一个时自然不必烦恼。当有多个实例时则根据名字匹配。但为了自动匹配上而强迫自己按照Bean的名字命名字段对象无异于削足适履，还好，@Qualifier和@Primary能解决我们的问题。Spring会根据@Qualifier内传入的名字去匹配相应的Bean；而@Primary更加适用于Bean之间有优先级顺序的情况，像主从数据库就是一个很好的例子。<br>之后，我们需要对Bean有着更加细粒度的控制。比如@Scope来决定Bean的作用域。@Lazy来决定Bean是否懒加载。@Profile让我们根据条件决定Bean是否装配。<br>最后，是十分重要常常被提到，却往往沦为@SpringBootApplication的背景板的@ComponentScan，它开启了包扫描，是我们Bean被装配到容器中的最大功臣。</p>
<h1 id="ConfigurationProperties"><a href="#ConfigurationProperties" class="headerlink" title="@ConfigurationProperties"></a>@ConfigurationProperties</h1><p>即便现在简化了配置，但是一个独立的配置文件总是易于理解而且使人安心的。Spring在构建完项目后，会默认在resources文件夹下创建一个application.properties文件，application.yml也是一样的效果。@ConfigurationProperties可以获取配置文件中的数据，将其注入类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ConfigurationProperties &#123;</span><br><span class="line">    <span class="meta">@AliasFor(&quot;prefix&quot;)</span></span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AliasFor(&quot;value&quot;)</span></span><br><span class="line">    String <span class="title function_">prefix</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">ignoreInvalidFields</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">ignoreUnknownFields</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>向注解中传入配置文件中的前缀名，如果配置文件如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">myConfigs:</span></span><br><span class="line">  <span class="attr">config1:</span></span><br><span class="line">    <span class="attr">field1:</span> <span class="string">f1</span></span><br><span class="line">    <span class="attr">field2:</span> <span class="string">f2</span></span><br><span class="line">    <span class="attr">field3:</span> <span class="string">f3</span></span><br></pre></td></tr></table></figure>
<p>那么代码中的配置类应该这样写：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(&quot;myConfigs.config1&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig1</span> &#123;</span><br><span class="line">    String field1;</span><br><span class="line">    String field2;</span><br><span class="line">    String field3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上所示，field1, field2, field3三个属性就被绑定到了对象上。</p>
<p>ignoreInvalidFields默认为false，不合法的属性的属性会默认抛出异常；<br>ignoreUnknownFields默认为true, 未能识别的属性会被忽略(所以打错了名字就会被忽略了)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix=&quot;config.prefix&quot;, ignoreInvalidFields=true, ignoreUnknownFields=false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line">    <span class="comment">// fields</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Spring Boot的绑定规则相当宽松，myField, my-field, my_field等都能识别绑定到myField上。</p>
<p>可以给字段设定默认值，这样配置中没有传入时会使用默认值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(&quot;your.prefix&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">YourConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">field</span> <span class="operator">=</span> <span class="string">&quot;Default&quot;</span></span><br><span class="line">    <span class="comment">// setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>类的字段必须要有public访问权限的setter方法。</p>
<h1 id="EnableConfigurationProperties"><a href="#EnableConfigurationProperties" class="headerlink" title="@EnableConfigurationProperties"></a>@EnableConfigurationProperties</h1><p>我们从前面大概知道，在Spring中，想让一个类被扫描进入IoC容器中，一般有两种方法：一是在这个类上添加@Component；二是在配置类上指定类。第二类的方法对应到实际中就是大多以Enable开头，例如@EnableConfigurationProperties就是和@ConfigurationProperties搭配使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import(&#123;EnableConfigurationPropertiesRegistrar.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableConfigurationProperties &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">VALIDATOR_BEAN_NAME</span> <span class="operator">=</span> <span class="string">&quot;configurationPropertiesValidator&quot;</span>;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt;[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用使用时要加载配置类上，启动类也是一种配置类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(YouConfigurationProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Value"><a href="#Value" class="headerlink" title="@Value"></a>@Value</h1><p> 使用@ConfigurationProperties能够将配置注入到整个类中，而@Value注解能够将配置注入到字段中，进行更为细粒度的控制。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.FIELD, ElementType.METHOD, ElementType.PARAMETER, ElementType.ANNOTATION_TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Value &#123;</span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：注解修饰的字段不能为static或者final。</p>
</blockquote>
<p>使用上有两种形式：<br>@Value(“${}”)，用来加载外部文件中的值；<br>@Value(“#{}”)，用于执行SpEl表达式，并将内容赋值给属性。<br>我们可以获取Spring Boot配置文件(.yml或.properties)中的属性值并将其赋值给指定变量。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;my.config.field&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String value;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>SpEL是一种表达式语言，能够动态的运行语句。<br>如果有使用Thymeleaf，会感到一种熟悉感。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="meta">@Value(&quot;#&#123;1 + 1&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Integer value; <span class="comment">// 2</span></span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder"></span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
